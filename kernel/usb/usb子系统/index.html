

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/tom.png">
  <link rel="icon" href="/img/tom.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Tom">
  <meta name="keywords" content="">
  
    <meta name="description" content="USB子系统USB子系统框架    USB设备驱动：用于和枚举到的USB设备进行绑定，完成特定的功能 USB Core：用于内核USB总线的初始化及USB相关API，为设备驱动和HCD的交互提供桥梁 USB主机控制器HCD：完成主机控制器的初始化以及数据的传输，并监测外部设备插入，完成设备枚举  USB传输类型 控制传输：控制传输是双向传输，数据量通常比较小，主要指由USB总线驱动程序用来进行查询">
<meta property="og:type" content="article">
<meta property="og:title" content="USB子系统">
<meta property="og:url" content="https://tomwithkernel.github.io/kernel/usb/usb%E5%AD%90%E7%B3%BB%E7%BB%9F/index.html">
<meta property="og:site_name" content="TomWithKernel&#39;s Blog">
<meta property="og:description" content="USB子系统USB子系统框架    USB设备驱动：用于和枚举到的USB设备进行绑定，完成特定的功能 USB Core：用于内核USB总线的初始化及USB相关API，为设备驱动和HCD的交互提供桥梁 USB主机控制器HCD：完成主机控制器的初始化以及数据的传输，并监测外部设备插入，完成设备枚举  USB传输类型 控制传输：控制传输是双向传输，数据量通常比较小，主要指由USB总线驱动程序用来进行查询">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://tomwithkernel.github.io/kernel/usb/usb%E5%AD%90%E7%B3%BB%E7%BB%9F/usb.png">
<meta property="og:image" content="https://tomwithkernel.github.io/kernel/usb/usb%E5%AD%90%E7%B3%BB%E7%BB%9F/usb_intf_image.png">
<meta property="article:published_time" content="2024-05-18T02:09:00.000Z">
<meta property="article:modified_time" content="2024-08-19T07:16:49.635Z">
<meta property="article:author" content="Tom">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://tomwithkernel.github.io/kernel/usb/usb%E5%AD%90%E7%B3%BB%E7%BB%9F/usb.png">
  
  
  
  <title>USB子系统 - TomWithKernel&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"tomwithkernel.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"mGugYoHICpLi8BnBygCpEblQ-MdYXbMMI","app_key":"jxVWH2hG2DLvf0KjiGZ93acw","server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>TomWithKernel&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="USB子系统"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-05-18 10:09" pubdate>
          2024年5月18日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          53 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">USB子系统</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="USB子系统"><a href="#USB子系统" class="headerlink" title="USB子系统"></a>USB子系统</h2><h3 id="USB子系统框架"><a href="#USB子系统框架" class="headerlink" title="USB子系统框架"></a>USB子系统框架</h3><img src="/kernel/usb/usb%E5%AD%90%E7%B3%BB%E7%BB%9F/usb.png" srcset="/img/loading.gif" lazyload class="" title="usb"> 

<ul>
<li>USB设备驱动：用于和枚举到的USB设备进行绑定，完成特定的功能</li>
<li>USB Core：用于内核USB总线的初始化及USB相关API，为设备驱动和HCD的交互提供桥梁</li>
<li>USB主机控制器HCD：完成主机控制器的初始化以及数据的传输，并监测外部设备插入，完成设备枚举</li>
</ul>
<h3 id="USB传输类型"><a href="#USB传输类型" class="headerlink" title="USB传输类型"></a>USB传输类型</h3><ul>
<li>控制传输：控制传输是双向传输，数据量通常比较小，主要指由USB总线驱动程序用来进行查询、配置以及给USB设备发送通用的命令。控制传输典型地用在主计算机和USB外设之间的端点0(Endpoint 0)之间的传输，但是指定供应商的控制传输可能用到其它的端点。比如：USB设备的识别过程。</li>
<li>批量传输：主要应用在数据大量传输，同时又没有带宽和间隔时间要求的情况下，进行可靠传输。比如：U盘拷贝数据。</li>
<li>中断传输：中断传输主要用于定时查询设备是否有中断数据要传输，设备的端点模式器的结构决定了它的查询频率，从1到255ms之间。这种传输方式典型的应用在少量的、分散的、不可预测数据的传输，比如，键盘和鼠标就属于这一类型。中断传输是单向的并且对于host来说只有输入的方式。</li>
<li>实时传输：实时传输提供了确定的带宽和间隔时间，它被用于时间严格并具有较强容错性的流数据传输，或者用于要求恒定的数据传输率的即时应用中。比如：USB摄像头。</li>
</ul>
<h3 id="USB设备描述符"><a href="#USB设备描述符" class="headerlink" title="USB设备描述符"></a>USB设备描述符</h3><img src="/kernel/usb/usb%E5%AD%90%E7%B3%BB%E7%BB%9F/usb_intf_image.png" srcset="/img/loading.gif" lazyload class="" title="usb_intf">  

<ul>
<li>一个USB设备描述符中可以有多个配置描述符，即USB设备可以有多种配置；一个配置描述符中可以有多个接口描述符，即USB设备可以支持多种功能（接口）；一个接口描述符中可以有多个端点描述符。</li>
<li>一设备至少要包含设备描述符、配置描述符和接口描述符，如果USB设备没有端点描述符，则它仅仅用默认管道与主机进行数据传输。</li>
<li>接口，表示逻辑上的设备，比如USB声卡可以分为接口1-录音设备，接口2-播放设备。</li>
<li>访问设备时，即访问某个接口，接口表示逻辑设备。</li>
<li>传输数据时，即读写某个端口，端口是数据通道。</li>
</ul>
<h4 id="设备描述符"><a href="#设备描述符" class="headerlink" title="设备描述符"></a>设备描述符</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* USB_DT_DEVICE: Device descriptor */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device_descriptor</span> &#123;</span><br>    __u8  bLength; <span class="hljs-comment">//该结构体大小</span><br>    __u8  bDescriptorType; <span class="hljs-comment">//描述符类型 （此处应为0x01，即设备描述符）</span><br><br>    __le16 bcdUSB; <span class="hljs-comment">//usb版本号 200 -&gt; USB2.0</span><br>    __u8  bDeviceClass; <span class="hljs-comment">//设备类 </span><br>    __u8  bDeviceSubClass; <span class="hljs-comment">//设备类子类</span><br>    __u8  bDeviceProtocol; <span class="hljs-comment">//设备协议，以上三点都是USB官方定义</span><br>    __u8  bMaxPacketSize0; <span class="hljs-comment">//端点0最大包大小 （只能为8,16,32,64）</span><br>    __le16 idVendor; <span class="hljs-comment">//厂家id</span><br>    __le16 idProduct; <span class="hljs-comment">//产品id</span><br>    __le16 bcdDevice; <span class="hljs-comment">//设备出厂编号</span><br>    __u8  iManufacturer; <span class="hljs-comment">//描述厂商信息的字符串描述符的索引值</span><br>    __u8  iProduct; <span class="hljs-comment">//描述产品信息的字串描述符的索引值</span><br>    __u8  iSerialNumber; <span class="hljs-comment">//描述设备序列号信息的字串描述符的索引值 </span><br>    __u8  bNumConfigurations; <span class="hljs-comment">//可能的配置描述符的数目</span><br>&#125; __attribute__ ((packed));<br></code></pre></td></tr></table></figure>

<p> USB设备描述符位于USB设备结构体usb_device中的成员descriptor中。同样地,配置、接口、端点描述符也是位于USB配置、接口、端点结构体中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * struct usb_device - kernel&#x27;s representation of a USB device</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> &#123;</span><br>	<span class="hljs-type">int</span>		devnum;                    <span class="hljs-comment">// 设备编号；在USB总线上的地址</span><br>	<span class="hljs-type">char</span>		devpath[<span class="hljs-number">16</span>];              <span class="hljs-comment">// 设备ID字符串，用于消息（例如，/port/...）</span><br>	u32		route;                    <span class="hljs-comment">// 树拓扑的十六进制字符串，用于xHCI</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">usb_device_state</span>	<span class="hljs-title">state</span>;</span>                <span class="hljs-comment">// 设备状态：配置、未连接等</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">usb_device_speed</span>	<span class="hljs-title">speed</span>;</span>                <span class="hljs-comment">// 设备速度：高/全/低（或错误）</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>		rx_lanes;              <span class="hljs-comment">// 使用中的接收通道数量，USB 3.2添加了双通道支持</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>		tx_lanes;              <span class="hljs-comment">// 使用中的传输通道数量，USB 3.2添加了双通道支持</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_tt</span>	*<span class="hljs-title">tt</span>;</span>                    <span class="hljs-comment">// 事务转换器信息；用于低/全速设备、高速集线器</span><br>	<span class="hljs-type">int</span>		ttport;                   <span class="hljs-comment">// 在事务转换器集线器上的设备端口</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> toggle[<span class="hljs-number">2</span>];                   <span class="hljs-comment">// 每个端点一个位，([0] = 输入， [1] = 输出) 端点</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">parent</span>;</span>                <span class="hljs-comment">// 我们的集线器，除非我们是根</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_bus</span> *<span class="hljs-title">bus</span>;</span>                      <span class="hljs-comment">// 我们所属的总线</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_endpoint</span> <span class="hljs-title">ep0</span>;</span>             <span class="hljs-comment">// 端点0数据（默认控制管道）</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> <span class="hljs-title">dev</span>;</span>                        <span class="hljs-comment">// 通用设备接口</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device_descriptor</span> <span class="hljs-title">descriptor</span>;</span>  <span class="hljs-comment">// USB设备描述符</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_bos</span> *<span class="hljs-title">bos</span>;</span>                 <span class="hljs-comment">// USB设备BOS描述符集</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_config</span> *<span class="hljs-title">config</span>;</span>           <span class="hljs-comment">// 设备的所有配置</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_config</span> *<span class="hljs-title">actconfig</span>;</span>        <span class="hljs-comment">// 活动配置</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_endpoint</span> *<span class="hljs-title">ep_in</span>[16];</span>      <span class="hljs-comment">// 输入端点数组</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_endpoint</span> *<span class="hljs-title">ep_out</span>[16];</span>     <span class="hljs-comment">// 输出端点数组</span><br><br>	<span class="hljs-type">char</span> **rawdescriptors;                    <span class="hljs-comment">// 每个配置的原始描述符</span><br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> bus_mA;                    <span class="hljs-comment">// 总线可用电流</span><br>	u8 portnum;                               <span class="hljs-comment">// 父端口号（起始值为1）</span><br>	u8 level;                                 <span class="hljs-comment">// USB集线器祖先的数量</span><br>	u8 devaddr;                               <span class="hljs-comment">// 设备地址，XHCI：由硬件分配，其他：与devnum相同</span><br><br>	<span class="hljs-type">unsigned</span> can_submit:<span class="hljs-number">1</span>;                    <span class="hljs-comment">// 可以提交URB</span><br>	<span class="hljs-type">unsigned</span> persist_enabled:<span class="hljs-number">1</span>;               <span class="hljs-comment">// 启用USB_PERSIST</span><br>	<span class="hljs-type">unsigned</span> reset_in_progress:<span class="hljs-number">1</span>;             <span class="hljs-comment">// 设备正在复位</span><br>	<span class="hljs-type">unsigned</span> have_langid:<span class="hljs-number">1</span>;                   <span class="hljs-comment">// string_langid是否有效</span><br>	<span class="hljs-type">unsigned</span> authorized:<span class="hljs-number">1</span>;                    <span class="hljs-comment">// 策略已允许我们使用它</span><br>	<span class="hljs-type">unsigned</span> authenticated:<span class="hljs-number">1</span>;                 <span class="hljs-comment">// 通过加密认证</span><br>	<span class="hljs-type">unsigned</span> wusb:<span class="hljs-number">1</span>;                          <span class="hljs-comment">// 设备是无线USB</span><br>	<span class="hljs-type">unsigned</span> lpm_capable:<span class="hljs-number">1</span>;                   <span class="hljs-comment">// 设备支持LPM</span><br>	<span class="hljs-type">unsigned</span> usb2_hw_lpm_capable:<span class="hljs-number">1</span>;           <span class="hljs-comment">// 设备可以执行USB2硬件LPM</span><br>	<span class="hljs-type">unsigned</span> usb2_hw_lpm_besl_capable:<span class="hljs-number">1</span>;      <span class="hljs-comment">// 设备可以执行USB2硬件BESL LPM</span><br>	<span class="hljs-type">unsigned</span> usb2_hw_lpm_enabled:<span class="hljs-number">1</span>;           <span class="hljs-comment">// 启用USB2硬件LPM</span><br>	<span class="hljs-type">unsigned</span> usb2_hw_lpm_allowed:<span class="hljs-number">1</span>;           <span class="hljs-comment">// 用户空间允许启用USB 2.0 LPM</span><br>	<span class="hljs-type">unsigned</span> usb3_lpm_u1_enabled:<span class="hljs-number">1</span>;           <span class="hljs-comment">// 启用USB3硬件U1 LPM</span><br>	<span class="hljs-type">unsigned</span> usb3_lpm_u2_enabled:<span class="hljs-number">1</span>;           <span class="hljs-comment">// 启用USB3硬件U2 LPM</span><br>	<span class="hljs-type">int</span> string_langid;                        <span class="hljs-comment">// 字符串的语言ID</span><br><br>	<span class="hljs-comment">/* static strings from the device */</span><br>	<span class="hljs-type">char</span> *product;                            <span class="hljs-comment">// 如果存在，iProduct字符串（静态）</span><br>	<span class="hljs-type">char</span> *manufacturer;                       <span class="hljs-comment">// 如果存在，iManufacturer字符串（静态）</span><br>	<span class="hljs-type">char</span> *serial;                             <span class="hljs-comment">// 如果存在，iSerialNumber字符串（静态）</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">filelist</span>;</span>                <span class="hljs-comment">// 此设备打开的usbfs文件</span><br><br>	<span class="hljs-type">int</span> maxchild;                             <span class="hljs-comment">// 如果是集线器，端口数量</span><br><br>	u32 quirks;                               <span class="hljs-comment">// 设备的怪癖</span><br>	<span class="hljs-type">atomic_t</span> urbnum;                          <span class="hljs-comment">// 提交的URB数量</span><br><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> active_duration;            <span class="hljs-comment">// 设备未挂起的总时间</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PM</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> connect_time;               <span class="hljs-comment">// 设备首次连接时间</span><br><br>	<span class="hljs-type">unsigned</span> do_remote_wakeup:<span class="hljs-number">1</span>;              <span class="hljs-comment">// 启用远程唤醒</span><br>	<span class="hljs-type">unsigned</span> reset_resume:<span class="hljs-number">1</span>;                  <span class="hljs-comment">// 需要复位而不是恢复</span><br>	<span class="hljs-type">unsigned</span> port_is_suspended:<span class="hljs-number">1</span>;             <span class="hljs-comment">// 上游端口被挂起（L2或U3）</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">wusb_dev</span> *<span class="hljs-title">wusb_dev</span>;</span>                <span class="hljs-comment">// 如果这是无线USB设备，则链接到设备的WUSB特定数据</span><br>	<span class="hljs-type">int</span> slot_id;                              <span class="hljs-comment">// xHCI分配的插槽ID</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">usb_device_removable</span> <span class="hljs-title">removable</span>;</span>      <span class="hljs-comment">// 设备可以从此端口物理移除</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb2_lpm_parameters</span> <span class="hljs-title">l1_params</span>;</span>     <span class="hljs-comment">// USB2 L1 LPM状态的最佳努力服务延迟和L1超时</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb3_lpm_parameters</span> <span class="hljs-title">u1_params</span>;</span>     <span class="hljs-comment">// USB3 U1 LPM状态的退出延迟和集线器启动的超时</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb3_lpm_parameters</span> <span class="hljs-title">u2_params</span>;</span>     <span class="hljs-comment">// USB3 U2 LPM状态的退出延迟和集线器启动的超时</span><br>	<span class="hljs-type">unsigned</span> lpm_disable_count;               <span class="hljs-comment">// Ref计数用于usb_disable_lpm()和usb_enable_lpm()跟踪需要禁用USB 3.0链路电源管理的函数数量。该计数应仅由这些函数在持有带宽互斥锁时操作。</span><br><br>	u16 hub_delay;                            <span class="hljs-comment">// 缓存值，包括：</span><br>	                                          <span class="hljs-comment">// parent-&gt;hub_delay + wHubDelay + tTPTransmissionDelay (40ns)</span><br>	                                          <span class="hljs-comment">// 将用作SetIsochDelay请求的wValue。</span><br>	<span class="hljs-type">unsigned</span> use_generic_driver:<span class="hljs-number">1</span>;            <span class="hljs-comment">// 请求驱动程序核心使用通用驱动程序重新探测。</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="配置描述符"><a href="#配置描述符" class="headerlink" title="配置描述符"></a>配置描述符</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_config_descriptor</span> &#123;</span><br>    __u8  bLength; <span class="hljs-comment">//该结构体大小</span><br>    __u8  bDescriptorType;<span class="hljs-comment">//描述符类型（本结构体中固定为0x02)  </span><br><br>    __le16 wTotalLength; <span class="hljs-comment">//该配置下，信息的总长度（包括配置，接口，端点和设备类及厂商定义的描述符）</span><br>    __u8  bNumInterfaces; <span class="hljs-comment">//接口的个数</span><br>    __u8  bConfigurationValue; <span class="hljs-comment">//Set_Configuration命令所需要的参数值，用来选定此配置</span><br>    __u8  iConfiguration; <span class="hljs-comment">//描述该配置的字符串描述的索引值 </span><br>    __u8  bmAttributes;<span class="hljs-comment">//供电模式的选择  </span><br>    __u8  bMaxPower;<span class="hljs-comment">//设备从总线提取的最大电流</span><br>&#125; __attribute__ ((packed));<br></code></pre></td></tr></table></figure>

<h4 id="接口描述符"><a href="#接口描述符" class="headerlink" title="接口描述符"></a>接口描述符</h4><p>配置描述符中包含了一个或多个接口描述符，这里的“接口”并不是指物理存在的接口，在这里把它称之为“功能”更易理解些，例如一个设备既有录音的功能又有扬声器的功能，则这个设备至少就有两个“接口”。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface_descriptor</span> &#123;</span><br>    __u8  bLength;      <span class="hljs-comment">//该结构体大小</span><br>    __u8  bDescriptorType;<span class="hljs-comment">//接口描述符的类型编号(0x04）</span><br><br>    __u8  bInterfaceNumber;  <span class="hljs-comment">//该接口的编号  </span><br>    __u8  bAlternateSetting; <span class="hljs-comment">//备用的接口描述符编号  </span><br>    __u8  bNumEndpoints; <span class="hljs-comment">//该接口使用的端点数，不包括端点0  </span><br>    __u8  bInterfaceClass; <span class="hljs-comment">//接口类</span><br>    __u8  bInterfaceSubClass; <span class="hljs-comment">//子类</span><br>    __u8  bInterfaceProtocol; <span class="hljs-comment">//协议</span><br>    __u8  iInterface;<span class="hljs-comment">//描述此接口的字串描述表的索引值  </span><br>&#125; __attribute__ ((packed));<br></code></pre></td></tr></table></figure>

<p>它位于usb_interface-&gt;cur_altsetting-&gt;desc 这个成员结构体里</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * struct usb_interface - what usb device drivers talk to</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> &#123;</span><br>	<span class="hljs-comment">/* array of alternate settings for this interface,</span><br><span class="hljs-comment">	 * stored in no particular order */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_interface</span> *<span class="hljs-title">altsetting</span>;</span>              <span class="hljs-comment">// 备用设置的数组，无特定顺序</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_interface</span> *<span class="hljs-title">cur_altsetting</span>;</span>          <span class="hljs-comment">// 当前活动的备用设置</span><br>	<span class="hljs-type">unsigned</span> num_altsetting;                            <span class="hljs-comment">// 定义的备用设置数量</span><br><br>	<span class="hljs-comment">/* If there is an interface association descriptor then it will list</span><br><span class="hljs-comment">	 * the associated interfaces */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface_assoc_descriptor</span> *<span class="hljs-title">intf_assoc</span>;</span>  <span class="hljs-comment">// 接口关联描述符</span><br><br>	<span class="hljs-type">int</span> minor;                                          <span class="hljs-comment">// 分配给此接口的次设备号</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">usb_interface_condition</span> <span class="hljs-title">condition</span>;</span>             <span class="hljs-comment">// 绑定状态</span><br>	<span class="hljs-type">unsigned</span> sysfs_files_created:<span class="hljs-number">1</span>;                     <span class="hljs-comment">// sysfs属性存在</span><br>	<span class="hljs-type">unsigned</span> ep_devs_created:<span class="hljs-number">1</span>;                         <span class="hljs-comment">// 端点伪设备存在</span><br>	<span class="hljs-type">unsigned</span> unregistering:<span class="hljs-number">1</span>;                           <span class="hljs-comment">// 注销中</span><br>	<span class="hljs-type">unsigned</span> needs_remote_wakeup:<span class="hljs-number">1</span>;                     <span class="hljs-comment">// 驱动程序需要远程唤醒</span><br>	<span class="hljs-type">unsigned</span> needs_altsetting0:<span class="hljs-number">1</span>;                       <span class="hljs-comment">// 切换到备用设置0待处理</span><br>	<span class="hljs-type">unsigned</span> needs_binding:<span class="hljs-number">1</span>;                           <span class="hljs-comment">// 需要延迟解除绑定/重新绑定</span><br>	<span class="hljs-type">unsigned</span> resetting_device:<span class="hljs-number">1</span>;                        <span class="hljs-comment">// 复位后需要带宽分配</span><br>	<span class="hljs-type">unsigned</span> authorized:<span class="hljs-number">1</span>;                              <span class="hljs-comment">// 接口授权</span><br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> <span class="hljs-title">dev</span>;</span>                                  <span class="hljs-comment">// 接口特定的设备信息</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">usb_dev</span>;</span>                             <span class="hljs-comment">// 如果接口绑定到USB主设备号，则指向该设备的sysfs表示</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">reset_ws</span>;</span>                        <span class="hljs-comment">// 用于在原子上下文中复位的工作结构</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* host-side wrapper for one interface setting&#x27;s parsed descriptors */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_interface</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface_descriptor</span> <span class="hljs-title">desc</span>;</span>  <span class="hljs-comment">// 接口描述符</span><br><br>	<span class="hljs-type">int</span> extralen;                          <span class="hljs-comment">// 额外描述符的长度</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *extra;                  <span class="hljs-comment">// 额外描述符</span><br><br>	<span class="hljs-comment">/* array of desc.bNumEndpoints endpoints associated with this</span><br><span class="hljs-comment">	 * interface setting.  these will be in no particular order.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_endpoint</span> *<span class="hljs-title">endpoint</span>;</span>    <span class="hljs-comment">// 该接口设置关联的端点数组，无特定顺序</span><br><br>	<span class="hljs-type">char</span> *<span class="hljs-built_in">string</span>;                          <span class="hljs-comment">// iInterface字符串，如果存在</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="端点描述符"><a href="#端点描述符" class="headerlink" title="端点描述符"></a>端点描述符</h4><p>端点是设备与主机之间进行数据传输的逻辑接口，除配置使用的端点0（控制端点，一般一个设备只有一个控制端点）为双向端口外，其它均为单向。端点描述符描述了数据的传输类型、传输方向、数据包大小和端点号（也可称为端点地址）等。<br>除了描述符中描述的端点外，每个设备必须要有一个默认的控制型端点，地址为0，它的数据传输为双向，而且没有专门的描述符，只是在设备描述符中定义了它的最大包长度。主机通过此端点向设备发送命令，获得设备的各种描述符的信息，并通过它来配置设备。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* USB_DT_ENDPOINT: Endpoint descriptor */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_endpoint_descriptor</span> &#123;</span><br>    __u8  bLength;        <span class="hljs-comment">//端点描述符字节数大小（7个字节）</span><br>    __u8  bDescriptorType;<span class="hljs-comment">//端点描述符类型编号（0x05) </span><br><br>    __u8  bEndpointAddress; <span class="hljs-comment">//此描述表所描述的端点的地址、方向 : </span><br>                            <span class="hljs-comment">// bit3~bit0:端点号，bit6~bit4:保留，</span><br>                            <span class="hljs-comment">// bit7:方向，如果是控制端点则忽略，0-输出端点（主机到设备）1-输入端点（设备到主机）</span><br>    __u8  bmAttributes; <span class="hljs-comment">// 端点特性，bit1~bit0 表示传输类型，其他位保留</span><br>                        <span class="hljs-comment">// 00-控制传输  01-实时传输   10-批量传输 11-中断传输</span><br>    __le16 wMaxPacketSize;  <span class="hljs-comment">//端点收、发的最大包大小</span><br>    __u8  bInterval; <span class="hljs-comment">// 中断传输模式中主机查询端点的时间间隔。</span><br>                     <span class="hljs-comment">// 对于实时传输的端点此域必需为1，表示周期为1ms。对于中断传输的端点此域值的范围为1ms到255ms</span><br><br>    <span class="hljs-comment">/* <span class="hljs-doctag">NOTE:</span>  these two are _only_ in audio endpoints. */</span><br>    <span class="hljs-comment">/* use USB_DT_ENDPOINT*_SIZE in bLength, not sizeof. */</span><br>    __u8  bRefresh;<br>    __u8  bSynchAddress;<br>&#125; __attribute__ ((packed));<br></code></pre></td></tr></table></figure>

<h4 id="字符串描述符"><a href="#字符串描述符" class="headerlink" title="字符串描述符"></a>字符串描述符</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_string_descriptor</span> &#123;</span><br>    __u8  bLength;  <span class="hljs-comment">// 此描述表的字节数（bString域的数值N＋2）</span><br>    __u8  bDescriptorType; <span class="hljs-comment">// 字串描述表类型（此处应为0x03）</span><br><br>    __le16 wData[<span class="hljs-number">1</span>];        <span class="hljs-comment">/* UTF-16LE encoded */</span>  <br>&#125; __attribute__ ((packed));<br></code></pre></td></tr></table></figure>

<h4 id="人机接口描述符"><a href="#人机接口描述符" class="headerlink" title="人机接口描述符"></a>人机接口描述符</h4><p>USB 设备中有一大类就是 HID 设备，即 Human Interface Devices，人机接口设备。这类设备包括鼠标、键盘等，主要用于人与计算机进行交互。 它是 USB 协议最早支持的一种设备类。 HID 设备可以作为低速、全速、高速设备用。由于 HID 设备要求用户输入能得到及时响应，故其传输方式通常采用中断方式。 在 USB 协议中， HID 设备的定义放置在接口描述符中， USB 的设备描述符和配置描述符中不包含 HID 设备的信息。因此，对于某些特定的 HID 设备，可以定义多个接口，只有其中一个接口为 HID 设备类即可。</p>
<h4 id="USB描述符类型值"><a href="#USB描述符类型值" class="headerlink" title="USB描述符类型值"></a>USB描述符类型值</h4><table>
<thead>
<tr>
<th>类型</th>
<th>描述符</th>
<th>类型值</th>
</tr>
</thead>
<tbody><tr>
<td>标准描述符</td>
<td>设备描述符</td>
<td>0x01</td>
</tr>
<tr>
<td></td>
<td>配置描述符</td>
<td>0x02</td>
</tr>
<tr>
<td></td>
<td>字符串描述符</td>
<td>0x03</td>
</tr>
<tr>
<td></td>
<td>接口描述符</td>
<td>0x04</td>
</tr>
<tr>
<td></td>
<td>端点描述符</td>
<td>0x05</td>
</tr>
<tr>
<td>类描述符</td>
<td>集线器类描述符</td>
<td>0x29</td>
</tr>
<tr>
<td></td>
<td>人机接口类描述符</td>
<td>0x21</td>
</tr>
<tr>
<td>厂商定义的描述符</td>
<td></td>
<td>0xff</td>
</tr>
</tbody></table>
<h3 id="USB的数据传输对象"><a href="#USB的数据传输对象" class="headerlink" title="USB的数据传输对象"></a>USB的数据传输对象</h3><p>端点，一个USB设备可以有多个端点，和主机间的数据传输称为到设备端点的数据传输。比如说，对于一个U盘，可以细分为两个端点，把数据写到U盘的端点1、从U盘的端点2读取数据。</p>
<h2 id="USB总线驱动框架"><a href="#USB总线驱动框架" class="headerlink" title="USB总线驱动框架"></a>USB总线驱动框架</h2><h3 id="USB-Core"><a href="#USB-Core" class="headerlink" title="USB Core"></a>USB Core</h3><p>初始化内核USB总线提供USB相关API，为设备驱动和HCD的交互提供桥梁。</p>
<blockquote>
<p>Linux启动阶段，通过<strong>subsys_initcall</strong>会完成USB Core的加载</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">subsys_initcall(usb_init);<br></code></pre></td></tr></table></figure>

<h4 id="usb-init"><a href="#usb-init" class="headerlink" title="usb_init"></a>usb_init</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">usb_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-type">int</span> retval;<br>	<span class="hljs-keyword">if</span> (usb_disabled()) &#123;<br>		pr_info(<span class="hljs-string">&quot;%s: USB support disabled\n&quot;</span>, usbcore_name);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br>	usb_init_pool_max();<br><br>	usb_debugfs_init();<br><br>	usb_acpi_register();<br>	retval = bus_register(&amp;usb_bus_type);	<span class="hljs-comment">//USB总线的创建</span><br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> bus_register_failed;<br>	retval = bus_register_notifier(&amp;usb_bus_type, &amp;usb_bus_nb);<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> bus_notifier_failed;<br>	retval = usb_major_init();<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> major_init_failed;<br>	retval = usb_register(&amp;usbfs_driver);	<span class="hljs-comment">//注册USB接口驱动</span><br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> driver_register_failed;<br>	retval = usb_devio_init();<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> usb_devio_init_failed;<br>	retval = usb_hub_init();				<span class="hljs-comment">//初始化一个USB设备集线器，用来检测USB设备的连接和断开。</span><br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> hub_init_failed;<br>	retval = usb_register_device_driver(&amp;usb_generic_driver, THIS_MODULE);<span class="hljs-comment">//注册USB设备驱动</span><br>	<span class="hljs-keyword">if</span> (!retval)<br>		<span class="hljs-keyword">goto</span> out;<br><br>	usb_hub_cleanup();<br>hub_init_failed:<br>	usb_devio_cleanup();<br>usb_devio_init_failed:<br>	usb_deregister(&amp;usbfs_driver);<br>driver_register_failed:<br>	usb_major_cleanup();<br>major_init_failed:<br>	bus_unregister_notifier(&amp;usb_bus_type, &amp;usb_bus_nb);<br>bus_notifier_failed:<br>	bus_unregister(&amp;usb_bus_type);<br>bus_register_failed:<br>	usb_acpi_unregister();<br>	usb_debugfs_cleanup();<br>out:<br>	<span class="hljs-keyword">return</span> retval;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="注册USB总线"><a href="#注册USB总线" class="headerlink" title="注册USB总线"></a>注册USB总线</h4><p>USB是基于总线-驱动-设备模型的框架，其初始化阶段一个重点任务就是完成USB总线的创建。usb_bus_type提供了驱动和设备匹配的匹配函数，后面注册设备和驱动时会调用到。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">retval = bus_register(&amp;usb_bus_type);<br><span class="hljs-keyword">if</span> (retval) <br>    <span class="hljs-keyword">goto</span> bus_register_failed;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bus_type</span> <span class="hljs-title">usb_bus_type</span> =</span> &#123;<br>	.name =		<span class="hljs-string">&quot;usb&quot;</span>,<br>	.match =	usb_device_match,<br>	.uevent =	usb_uevent,<br>	.need_parent_lock =	<span class="hljs-literal">true</span>,<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>使用bus_register接口注册USB总线，会创建出两条链表用来分别存放向USB总线注册的设备和驱动。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">klist_init(&amp;priv-&gt;klist_devices, klist_devices_get, klist_devices_put);<br>klist_init(&amp;priv-&gt;klist_drivers, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br></code></pre></td></tr></table></figure>

<h4 id="注册USB接口驱动"><a href="#注册USB接口驱动" class="headerlink" title="注册USB接口驱动"></a>注册USB接口驱动</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 在usb总线注册USB接口驱动，该驱动被放在usb总线的驱动链表中。</span><br>retval = usb_register(&amp;usbfs_driver);<br><span class="hljs-keyword">if</span> (retval)<br>    <span class="hljs-keyword">goto</span> driver_register_failed;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_driver</span> <span class="hljs-title">usbfs_driver</span> =</span> &#123;<br>    .name =     <span class="hljs-string">&quot;usbfs&quot;</span>,<br>    .probe =    driver_probe,<br>    .disconnect =   driver_disconnect,<br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="初始化USB-Hub"><a href="#初始化USB-Hub" class="headerlink" title="初始化USB Hub"></a>初始化USB Hub</h4><p>初始化一个USB设备集线器，用来检测USB设备的连接和断开。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c">retval = usb_hub_init();<br><span class="hljs-keyword">if</span> (retval)<br>    <span class="hljs-keyword">goto</span> hub_init_failed;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">usb_hub_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-comment">// 在usb总线注册一个hub驱动，该驱动被放在usb总线的驱动链表中。</span><br>	<span class="hljs-keyword">if</span> (usb_register(&amp;hub_driver) &lt; <span class="hljs-number">0</span>) &#123;<br>		printk(KERN_ERR <span class="hljs-string">&quot;%s: can&#x27;t register hub driver\n&quot;</span>,<br>			usbcore_name);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * The workqueue needs to be freezable to avoid interfering with</span><br><span class="hljs-comment">	 * USB-PERSIST port handover. Otherwise it might see that a full-speed</span><br><span class="hljs-comment">	 * device was gone before the EHCI controller had handed its port</span><br><span class="hljs-comment">	 * over to the companion full-speed controller.</span><br><span class="hljs-comment">	 * 工作队列需要可冻结以避免干扰 USB-PERSIST 端口切换。 </span><br><span class="hljs-comment">	 * 否则，在 EHCI 控制器将其端口移交给配套的全速控制器之前，它可能会发现全速设备已消失。</span><br><span class="hljs-comment">	 */</span><br>	hub_wq = alloc_workqueue(<span class="hljs-string">&quot;usb_hub_wq&quot;</span>, WQ_FREEZABLE, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (hub_wq)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-comment">/* Fall through if kernel_thread failed */</span><br>	usb_deregister(&amp;hub_driver);<br>	pr_err(<span class="hljs-string">&quot;%s: can&#x27;t allocate workqueue for usb hub\n&quot;</span>, usbcore_name);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_driver</span> <span class="hljs-title">hub_driver</span> =</span> &#123;<br>	.name =		<span class="hljs-string">&quot;hub&quot;</span>,<br>	.probe =	hub_probe,<br>	.disconnect =	hub_disconnect,<br>	.suspend =	hub_suspend,<br>	.resume =	hub_resume,<br>	.reset_resume =	hub_reset_resume,<br>	.pre_reset =	hub_pre_reset,<br>	.post_reset =	hub_post_reset,<br>	.unlocked_ioctl = hub_ioctl,<br>	.id_table =	hub_id_table,<br>	.supports_autosuspend =	<span class="hljs-number">1</span>,<br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="注册USB设备驱动"><a href="#注册USB设备驱动" class="headerlink" title="注册USB设备驱动"></a>注册USB设备驱动</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 在usb总线注册USB设备驱动，该驱动被放在usb总线的驱动链表中。</span><br>retval = usb_register_device_driver(&amp;usb_generic_driver, THIS_MODULE);<br><span class="hljs-keyword">if</span> (!retval)<br>    <span class="hljs-keyword">goto</span> out;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device_driver</span> <span class="hljs-title">usb_generic_driver</span> =</span> &#123;<br>    .name = <span class="hljs-string">&quot;usb&quot;</span>,<br>    .probe = generic_probe,<br>    .disconnect = generic_disconnect,<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span>  CONFIG_PM</span><br>    .suspend = generic_suspend,<br>    .resume = generic_resume,<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    .supports_autosuspend = <span class="hljs-number">1</span>,<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="usb-register-和-usb-register-device-driver"><a href="#usb-register-和-usb-register-device-driver" class="headerlink" title="usb_register 和 usb_register_device_driver"></a>usb_register 和 usb_register_device_driver</h3><p>usb_register 注册一个USB接口驱动，一个设备可以有多个接口，一个接口表示一种功能。比如USB声卡设备，有两个接口，一个播放接口，一个录音接口。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> usb_register(driver) \</span><br><span class="hljs-meta">	usb_register_driver(driver, THIS_MODULE, KBUILD_MODNAME)</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * usb_register_driver - register a USB interface driver</span><br><span class="hljs-comment"> * @new_driver: USB operations for the interface driver</span><br><span class="hljs-comment"> * @owner: module owner of this driver.</span><br><span class="hljs-comment"> * @mod_name: module name string</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Registers a USB interface driver with the USB core.  The list of</span><br><span class="hljs-comment"> * unattached interfaces will be rescanned whenever a new driver is</span><br><span class="hljs-comment"> * added, allowing the new driver to attach to any recognized interfaces.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Return: A negative error code on failure and 0 on success.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">NOTE:</span> if you want your driver to use the USB major number, you must call</span><br><span class="hljs-comment"> * usb_register_dev() to enable that functionality.  This function no longer</span><br><span class="hljs-comment"> * takes care of that.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">usb_register_driver</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_driver *new_driver, <span class="hljs-keyword">struct</span> module *owner,</span><br><span class="hljs-params">			<span class="hljs-type">const</span> <span class="hljs-type">char</span> *mod_name)</span><br>&#123;<br>	<span class="hljs-type">int</span> retval = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (usb_disabled())<br>		<span class="hljs-keyword">return</span> -ENODEV;<br><br>	new_driver-&gt;drvwrap.for_devices = <span class="hljs-number">0</span>;<br>	new_driver-&gt;drvwrap.driver.name = new_driver-&gt;name;<br>	new_driver-&gt;drvwrap.driver.bus = &amp;usb_bus_type;<br>    <span class="hljs-comment">// 对应的usb接口“设备”被匹配时，首先会调用usb_probe_interface，然后在该接口中调用driver的probe</span><br>	new_driver-&gt;drvwrap.driver.probe = usb_probe_interface;<br>	new_driver-&gt;drvwrap.driver.remove = usb_unbind_interface;<br>	new_driver-&gt;drvwrap.driver.owner = owner;<br>	new_driver-&gt;drvwrap.driver.mod_name = mod_name;<br>	new_driver-&gt;drvwrap.driver.dev_groups = new_driver-&gt;dev_groups;<br>	spin_lock_init(&amp;new_driver-&gt;dynids.lock);<br>	INIT_LIST_HEAD(&amp;new_driver-&gt;dynids.<span class="hljs-built_in">list</span>);<br><br>	retval = driver_register(&amp;new_driver-&gt;drvwrap.driver);<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> out;<br><br>	retval = usb_create_newid_files(new_driver);<br>	<span class="hljs-keyword">if</span> (retval)<br>		<span class="hljs-keyword">goto</span> out_newid;<br><br>	pr_info(<span class="hljs-string">&quot;%s: registered new interface driver %s\n&quot;</span>,<br>			usbcore_name, new_driver-&gt;name);<br><br>out:<br>	<span class="hljs-keyword">return</span> retval;<br><br>out_newid:<br>	driver_unregister(&amp;new_driver-&gt;drvwrap.driver);<br><br>	pr_err(<span class="hljs-string">&quot;%s: error %d registering interface driver %s\n&quot;</span>,<br>		usbcore_name, retval, new_driver-&gt;name);<br>	<span class="hljs-keyword">goto</span> out;<br>&#125;<br>EXPORT_SYMBOL_GPL(usb_register_driver);<br></code></pre></td></tr></table></figure>

<p>usb_register_device_driver 注册一个通用USB设备驱动，而不是USB接口驱动。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * usb_register_device_driver - register a USB device (not interface) driver</span><br><span class="hljs-comment"> * @new_udriver: USB operations for the device driver</span><br><span class="hljs-comment"> * @owner: module owner of this driver.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Registers a USB device driver with the USB core.  The list of</span><br><span class="hljs-comment"> * unattached devices will be rescanned whenever a new driver is</span><br><span class="hljs-comment"> * added, allowing the new driver to attach to any recognized devices.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Return: A negative error code on failure and 0 on success.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">usb_register_device_driver</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_device_driver *new_udriver,</span><br><span class="hljs-params">		<span class="hljs-keyword">struct</span> module *owner)</span><br>&#123;<br>	<span class="hljs-type">int</span> retval = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (usb_disabled())<br>		<span class="hljs-keyword">return</span> -ENODEV;<br><br>	new_udriver-&gt;drvwrap.for_devices = <span class="hljs-number">1</span>;<br>	new_udriver-&gt;drvwrap.driver.name = new_udriver-&gt;name;<br>	new_udriver-&gt;drvwrap.driver.bus = &amp;usb_bus_type;<br>    <span class="hljs-comment">// 对应的usb设备被匹配时，首先会调用usb_probe_device，然后在该接口中调用driver的probe</span><br>	new_udriver-&gt;drvwrap.driver.probe = usb_probe_device;<br>	new_udriver-&gt;drvwrap.driver.remove = usb_unbind_device;<br>	new_udriver-&gt;drvwrap.driver.owner = owner;<br>	new_udriver-&gt;drvwrap.driver.dev_groups = new_udriver-&gt;dev_groups;<br><br>	retval = driver_register(&amp;new_udriver-&gt;drvwrap.driver);<br><br>	<span class="hljs-keyword">if</span> (!retval) &#123;<br>		pr_info(<span class="hljs-string">&quot;%s: registered new device driver %s\n&quot;</span>,<br>			usbcore_name, new_udriver-&gt;name);<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * Check whether any device could be better served with</span><br><span class="hljs-comment">		 * this new driver</span><br><span class="hljs-comment">		 */</span><br>		bus_for_each_dev(&amp;usb_bus_type, <span class="hljs-literal">NULL</span>, new_udriver,<br>				 __usb_bus_reprobe_drivers);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		pr_err(<span class="hljs-string">&quot;%s: error %d registering device driver %s\n&quot;</span>,<br>			usbcore_name, retval, new_udriver-&gt;name);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> retval;<br>&#125;<br>EXPORT_SYMBOL_GPL(usb_register_device_driver);<br></code></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>USB core注册了一个USB总线，并向USB总线中注册了三个驱动，分别是USB接口驱动、HUB驱动、USB设备驱动。其中在注册HUB驱动前创建了一个hub_thread线程，用来处理hub上USB设备事件，比如插入和拔出；在HUB驱动的probe函数中，创建了一个urb并为其注册了一个中断处理函数hub_irq，用来唤醒hub_thread线程来处理USB设备事件。</p>
<h2 id="USB主机控制器驱动（HCD）"><a href="#USB主机控制器驱动（HCD）" class="headerlink" title="USB主机控制器驱动（HCD）"></a>USB主机控制器驱动（HCD）</h2><p>USB HCD注册在平台总线上。用来处理主机控制器的初始化以及数据的传输，并监测外部设备插入、拔出，完成设备枚举。</p>
<h3 id="USB主机控制器-设备"><a href="#USB主机控制器-设备" class="headerlink" title="USB主机控制器-设备"></a>USB主机控制器-设备</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">//5.10/arch/arm/mach-s3c/mach-smdk2440.c</span><br>MACHINE_START(S3C2440, <span class="hljs-string">&quot;SMDK2440&quot;</span>)<br>	<span class="hljs-comment">/* Maintainer: Ben Dooks &lt;ben-linux@fluff.org&gt; */</span><br>	.atag_offset	= <span class="hljs-number">0x100</span>,<br><br>	.init_irq	= s3c2440_init_irq,<br>	.map_io		= smdk2440_map_io,<br>	.init_machine	= smdk2440_machine_init,<br>	.init_time	= smdk2440_init_time,<br>MACHINE_END<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __init smdk2440_machine_init(<span class="hljs-type">void</span>)<br>&#123;<br>	s3c24xx_fb_set_platdata(&amp;smdk2440_fb_info);<br>	s3c_i2c0_set_platdata(<span class="hljs-literal">NULL</span>);<br>	<span class="hljs-comment">/* Configure the I2S pins (GPE0...GPE4) in correct mode */</span><br>	s3c_gpio_cfgall_range(S3C2410_GPE(<span class="hljs-number">0</span>), <span class="hljs-number">5</span>, S3C_GPIO_SFN(<span class="hljs-number">2</span>),<br>			      S3C_GPIO_PULL_NONE);<br>	platform_add_devices(smdk2440_devices, ARRAY_SIZE(smdk2440_devices));<br>	smdk_machine_init();<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_device</span> *<span class="hljs-title">smdk2440_devices</span>[] __<span class="hljs-title">initdata</span> =</span> &#123;<br>	&amp;s3c_device_ohci,<br>	&amp;s3c_device_lcd,<br>	&amp;s3c_device_wdt,<br>	&amp;s3c_device_i2c0,<br>	&amp;s3c_device_iis,<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_device</span> <span class="hljs-title">s3c_device_ohci</span> =</span> &#123;<br>	.name		= <span class="hljs-string">&quot;s3c2410-ohci&quot;</span>,<br>	.id		= <span class="hljs-number">-1</span>,<br>	.num_resources	= ARRAY_SIZE(s3c_usb_resource),<br>	.resource	= s3c_usb_resource,<br>	.dev		= &#123;<br>		.dma_mask		= &amp;samsung_device_dma_mask,<br>		.coherent_dma_mask	= DMA_BIT_MASK(<span class="hljs-number">32</span>),<br>	&#125;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="USB主机控制器-驱动"><a href="#USB主机控制器-驱动" class="headerlink" title="USB主机控制器-驱动"></a>USB主机控制器-驱动</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// linux-2.6.22.6/drivers/usb/host/ohci-hcd.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_ARCH_S3C2410</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;ohci-s3c2410.c&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PLATFORM_DRIVER     ohci_hcd_s3c2410_driver</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">ohci_hcd_mod_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-type">int</span> retval = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (usb_disabled())<br>		<span class="hljs-keyword">return</span> -ENODEV;<br><br>	printk(KERN_INFO <span class="hljs-string">&quot;%s: &quot;</span> DRIVER_DESC <span class="hljs-string">&quot;\n&quot;</span>, hcd_name);<br>	pr_debug (<span class="hljs-string">&quot;%s: block sizes: ed %zd td %zd\n&quot;</span>, hcd_name,<br>		<span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">struct</span> ed), <span class="hljs-keyword">sizeof</span> (<span class="hljs-keyword">struct</span> td));<br>	set_bit(USB_OHCI_LOADED, &amp;usb_hcds_loaded);<br><br>	ohci_debug_root = debugfs_create_dir(<span class="hljs-string">&quot;ohci&quot;</span>, usb_debug_root);<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PS3_SYSTEM_BUS_DRIVER</span><br>	retval = ps3_ohci_driver_register(&amp;PS3_SYSTEM_BUS_DRIVER);<br>	<span class="hljs-keyword">if</span> (retval &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">goto</span> error_ps3;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> OF_PLATFORM_DRIVER</span><br>	retval = platform_driver_register(&amp;OF_PLATFORM_DRIVER);<br>	<span class="hljs-keyword">if</span> (retval &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">goto</span> error_of_platform;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SA1111_DRIVER</span><br>	retval = sa1111_driver_register(&amp;SA1111_DRIVER);<br>	<span class="hljs-keyword">if</span> (retval &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">goto</span> error_sa1111;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SM501_OHCI_DRIVER</span><br>	retval = platform_driver_register(&amp;SM501_OHCI_DRIVER);<br>	<span class="hljs-keyword">if</span> (retval &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">goto</span> error_sm501;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> TMIO_OHCI_DRIVER</span><br>	retval = platform_driver_register(&amp;TMIO_OHCI_DRIVER);<br>	<span class="hljs-keyword">if</span> (retval &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">goto</span> error_tmio;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	<span class="hljs-keyword">return</span> retval;<br><br>	<span class="hljs-comment">/* Error path */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> TMIO_OHCI_DRIVER</span><br>	platform_driver_unregister(&amp;TMIO_OHCI_DRIVER);<br> error_tmio:<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SM501_OHCI_DRIVER</span><br>	platform_driver_unregister(&amp;SM501_OHCI_DRIVER);<br> error_sm501:<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SA1111_DRIVER</span><br>	sa1111_driver_unregister(&amp;SA1111_DRIVER);<br> error_sa1111:<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> OF_PLATFORM_DRIVER</span><br>	platform_driver_unregister(&amp;OF_PLATFORM_DRIVER);<br> error_of_platform:<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PS3_SYSTEM_BUS_DRIVER</span><br>	ps3_ohci_driver_unregister(&amp;PS3_SYSTEM_BUS_DRIVER);<br> error_ps3:<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	debugfs_remove(ohci_debug_root);<br>	ohci_debug_root = <span class="hljs-literal">NULL</span>;<br><br>	clear_bit(USB_OHCI_LOADED, &amp;usb_hcds_loaded);<br>	<span class="hljs-keyword">return</span> retval;<br>&#125;<br>module_init(ohci_hcd_mod_init);<br><br><span class="hljs-comment">// drivers/usb/host/ohci-s3c2410.c</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_driver</span> <span class="hljs-title">ohci_hcd_s3c2410_driver</span> =</span> &#123;<br>	.probe		= ohci_hcd_s3c2410_probe,<br>	.remove		= ohci_hcd_s3c2410_remove,<br>	.shutdown	= usb_hcd_platform_shutdown,<br>	.driver		= &#123;<br>		.name	= <span class="hljs-string">&quot;s3c2410-ohci&quot;</span>,<br>		.pm	= &amp;ohci_hcd_s3c2410_pm_ops,<br>		.of_match_table	= ohci_hcd_s3c2410_dt_ids,<br>	&#125;,<br>&#125;;<br></code></pre></td></tr></table></figure>

<h3 id="USB主机控制器设备和驱动的匹配"><a href="#USB主机控制器设备和驱动的匹配" class="headerlink" title="USB主机控制器设备和驱动的匹配"></a>USB主机控制器设备和驱动的匹配</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs c">platform_driver_register-&gt;<br>    driver_register-&gt;<br>        bus_add_driver-&gt;<br>            driver_attach-&gt;<br>                bus_for_each_dev-&gt; <span class="hljs-comment">// 从平台总线的的设备链表中，取出每一项设备进行匹配</span><br>                    __driver_attach-&gt;<br>                        driver_probe_device-&gt;<br>                            <span class="hljs-comment">// 此总线类型为平台总线，其存在match函数，即调用platform_match进行匹配</span><br>                            <span class="hljs-keyword">if</span> (drv-&gt;bus-&gt;match &amp;&amp; !drv-&gt;bus-&gt;match(dev, drv))                            <br><br><span class="hljs-comment">// 平台总线                            </span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bus_type</span> <span class="hljs-title">platform_bus_type</span> =</span> &#123;<br>	.name		= <span class="hljs-string">&quot;platform&quot;</span>,<br>	.dev_groups	= platform_dev_groups,<br>	.match		= platform_match,<br>	.uevent		= platform_uevent,<br>	.dma_configure	= platform_dma_configure,<br>	.pm		= &amp;platform_dev_pm_ops,<br>&#125;;<br>EXPORT_SYMBOL_GPL(platform_bus_type);             <br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">platform_match</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> device *dev, <span class="hljs-keyword">struct</span> device_driver *drv)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_device</span> *<span class="hljs-title">pdev</span> =</span> to_platform_device(dev);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_driver</span> *<span class="hljs-title">pdrv</span> =</span> to_platform_driver(drv);<br><br>	<span class="hljs-comment">/* When driver_override is set, only bind to the matching driver */</span><br>	<span class="hljs-keyword">if</span> (pdev-&gt;driver_override)<br>		<span class="hljs-keyword">return</span> !<span class="hljs-built_in">strcmp</span>(pdev-&gt;driver_override, drv-&gt;name);<br><br>	<span class="hljs-comment">/* Attempt an OF style match first */</span><br>	<span class="hljs-keyword">if</span> (of_driver_match_device(dev, drv))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>	<span class="hljs-comment">/* Then try ACPI style match */</span><br>	<span class="hljs-keyword">if</span> (acpi_driver_match_device(dev, drv))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>	<span class="hljs-comment">/* Then try to match against the id table */</span><br>	<span class="hljs-keyword">if</span> (pdrv-&gt;id_table)<br>		<span class="hljs-keyword">return</span> platform_match_id(pdrv-&gt;id_table, pdev) != <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-comment">/* fall-back to driver name match */</span><br>	<span class="hljs-keyword">return</span> (<span class="hljs-built_in">strcmp</span>(pdev-&gt;name, drv-&gt;name) == <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">// ohci 设备   name = &quot;s3c2410-ohci&quot;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_device</span> <span class="hljs-title">s3c_device_ohci</span> =</span> &#123;<br>	.name		= <span class="hljs-string">&quot;s3c2410-ohci&quot;</span>,<br>	.id		= <span class="hljs-number">-1</span>,<br>	.num_resources	= ARRAY_SIZE(s3c_usb_resource),<br>	.resource	= s3c_usb_resource,<br>	.dev		= &#123;<br>		.dma_mask		= &amp;samsung_device_dma_mask,<br>		.coherent_dma_mask	= DMA_BIT_MASK(<span class="hljs-number">32</span>),<br>	&#125;<br>&#125;;<br><br><span class="hljs-comment">// ohci 驱动 name = &quot;s3c2410-ohci&quot;</span><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_driver</span> <span class="hljs-title">ohci_hcd_s3c2410_driver</span> =</span> &#123;<br>	.probe		= ohci_hcd_s3c2410_probe,<br>	.remove		= ohci_hcd_s3c2410_remove,<br>	.shutdown	= usb_hcd_platform_shutdown,<br>	.driver		= &#123;<br>		.name	= <span class="hljs-string">&quot;s3c2410-ohci&quot;</span>,<br>		.pm	= &amp;ohci_hcd_s3c2410_pm_ops,<br>		.of_match_table	= ohci_hcd_s3c2410_dt_ids,<br>	&#125;,<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>匹配成功调用驱动的probe函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">driver_probe_device-&gt; <span class="hljs-comment">// 在此函数中匹配成功的话，就会去调用驱动的probe函数</span><br>    really_probe-&gt;<br>        drv-&gt;probe(dev)<br></code></pre></td></tr></table></figure>

<h3 id="USB主机控制器驱动的probe函数"><a href="#USB主机控制器驱动的probe函数" class="headerlink" title="USB主机控制器驱动的probe函数"></a>USB主机控制器驱动的probe函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">ohci_hcd_s3c2410_drv_probe -&gt; <br>    usb_hcd_s3c2410_probe -&gt;<br>        usb_add_hcd -&gt; <br>            rhdev = usb_alloc_dev<br>            hcd-&gt;self.root_hub = rhdev<br>            register_root_hub -&gt; <br>                usb_new_device -&gt;<br>                    device_add -&gt;     <br>                        bus_attach_device -&gt;<br>                            device_attach -&gt; <br>                                bus_for_each_drv -&gt; <span class="hljs-comment">// 从usb总线的的驱动链表中，取出每一项驱动进行匹配</span><br>                                    __device_attach -&gt;<br>                                        driver_probe_device -&gt;<br>                                            <span class="hljs-comment">// 此总线类型为USB总线，其存在match函数，即调用usb_device_match进行匹配</span><br>                                            <span class="hljs-keyword">if</span> (drv-&gt;bus-&gt;match &amp;&amp; !drv-&gt;bus-&gt;match(dev, drv)) <br>                                                driver_probe_device-&gt; <span class="hljs-comment">// 在此函数中匹配成功的话，就会去调用驱动的probe函数</span><br>                                                    really_probe-&gt;<br>                                                        drv-&gt;probe(dev)<br></code></pre></td></tr></table></figure>

<h3 id="usb-device-match"><a href="#usb-device-match" class="headerlink" title="usb_device_match"></a>usb_device_match</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">is_usb_device</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> device *dev)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> dev-&gt;type == &amp;usb_device_type;<br>&#125;<br><br><span class="hljs-comment">/* Do the same for device drivers and interface drivers. */</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title function_">is_usb_device_driver</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> device_driver *drv)</span><br>&#123;<br>    <span class="hljs-comment">// struct device_driver 中 struct usbdrv_wrap 中的for_devices变量为1，则为USB设备驱动</span><br>    <span class="hljs-comment">// 上节USB Core中向USB总线注册的USB设备驱动中有将该变量设置为1（new_udriver-&gt;drvwrap.for_devices = 1;）</span><br>    <span class="hljs-keyword">return</span> container_of(drv, <span class="hljs-keyword">struct</span> usbdrv_wrap, driver)-&gt;<br>            for_devices;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">usb_device_match</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> device *dev, <span class="hljs-keyword">struct</span> device_driver *drv)</span><br>&#123;<br>    <span class="hljs-comment">// USB设备 和 USB接口“设备”分开处理 </span><br>    <span class="hljs-comment">/* devices and interfaces are handled separately */</span><br>    <span class="hljs-keyword">if</span> (is_usb_device(dev)) &#123;<br>        <span class="hljs-comment">// 处理USB设备</span><br>        <span class="hljs-comment">/* interface drivers never match devices */</span><br>        <span class="hljs-keyword">if</span> (!is_usb_device_driver(drv))<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-comment">/* <span class="hljs-doctag">TODO:</span> Add real matching code */</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 处理USB接口设备</span><br>        <span class="hljs-keyword">struct</span> usb_interface *intf;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_driver</span> *<span class="hljs-title">usb_drv</span>;</span><br>        <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device_id</span> *<span class="hljs-title">id</span>;</span><br><br>        <span class="hljs-comment">/* device drivers never match interfaces */</span><br>        <span class="hljs-keyword">if</span> (is_usb_device_driver(drv))<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>        intf = to_usb_interface(dev);<br>        usb_drv = to_usb_driver(drv);<br><br>        id = usb_match_id(intf, usb_drv-&gt;id_table);<br>        <span class="hljs-keyword">if</span> (id)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br><br>        id = usb_match_dynamic_id(intf, usb_drv);<br>        <span class="hljs-keyword">if</span> (id)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>probe 向USB总线注册一个root hub 设备，从usb总线的的驱动链表中，取出每一项驱动进行匹配。在USB Core中已经向总线注册了三个驱动（USB设备驱动、USB接口驱动、USB hub驱动），根据条件匹配到USB设备驱动，则去调用USB设备驱动的probe函数。</p>
<h3 id="USB设备驱动的probe函数"><a href="#USB设备驱动的probe函数" class="headerlink" title="USB设备驱动的probe函数"></a>USB设备驱动的probe函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">generic_probe(<span class="hljs-keyword">struct</span> usb_device *udev) -&gt; <span class="hljs-comment">// 从上分析流程知udev为USB root hub设备 </span><br>    usb_set_configuration -&gt;<br>        device_add -&gt;  <span class="hljs-comment">// 创建USB接口设备，USB root hub接口设备被创建</span><br></code></pre></td></tr></table></figure>

<p>之后匹配到USB Core中注册的USB hub驱动，执行USB hub驱动的probe函数，该probe函数中，创建了一个urb并为其注册了一个中断处理函数hub_irq，用来唤醒hub_thread线程来处理USB设备事件（插入、拔出）。至此，系统启动初始化时关于USB的内容分析完成。USB Core和USB HCD的成功建立联系，为之后的USB设备驱动提供API。</p>
<h2 id="USB设备驱动-–USB鼠标"><a href="#USB设备驱动-–USB鼠标" class="headerlink" title="USB设备驱动 –USB鼠标"></a>USB设备驱动 –USB鼠标</h2><p>用于和枚举到的USB设备进行绑定，完成特定的功能。 比如USB鼠标设备，驱动开发主要是这一块代码的coding。</p>
<h3 id="注册一个USB接口驱动"><a href="#注册一个USB接口驱动" class="headerlink" title="注册一个USB接口驱动"></a>注册一个USB接口驱动</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_driver</span> <span class="hljs-title">usb_mouse_driver</span> =</span> &#123;<br>	.name		= <span class="hljs-string">&quot;usbmouse&quot;</span>,<br>	.probe		= usb_mouse_probe,<br>	.disconnect	= usb_mouse_disconnect,<br>	.id_table	= usb_mouse_id_table,<br>&#125;;<br><br>module_usb_driver(usb_mouse_driver);<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * module_usb_driver() - Helper macro for registering a USB driver</span><br><span class="hljs-comment"> * @__usb_driver: usb_driver struct</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Helper macro for USB drivers which do not do anything special in module</span><br><span class="hljs-comment"> * init/exit. This eliminates a lot of boilerplate. Each module may only</span><br><span class="hljs-comment"> * use this macro once, and calling it replaces module_init() and module_exit()</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> module_usb_driver(__usb_driver) \</span><br><span class="hljs-meta">	module_driver(__usb_driver, usb_register, \</span><br><span class="hljs-meta">		       usb_deregister)</span><br></code></pre></td></tr></table></figure>

<h3 id="USB接口设备的创建"><a href="#USB接口设备的创建" class="headerlink" title="USB接口设备的创建"></a>USB接口设备的创建</h3><p>当一个USB 鼠标设备插入后，主机USB控制器检测到后，触发USB设备集线器中的”中断”处理函数hub_irq。在hub_irq中会获取USB鼠标设备的设备描述符，根据设备描述符创建USB接口设备，从而和这边的USB接口驱动匹配，调用其probe函数，通过USB总线驱动程序（USB Core和USB HCD）和USB鼠标设备建立联系，进而操作（读写控制）该设备。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c">hub_irq<br>    kick_khubd <span class="hljs-comment">// 唤醒hub_thread线程</span><br>        hub_thread<br>            hub_events <span class="hljs-comment">// 处理USB设备插入事件</span><br>                hub_port_connect_change<br><br>                    udev = usb_alloc_dev(hdev, hdev-&gt;bus, port1);<br>                                dev-&gt;dev.bus = &amp;usb_bus_type;<br><br>                    choose_address(udev); <span class="hljs-comment">// 给新设备分配编号(地址)                                       </span><br>                    hub_port_init   <span class="hljs-comment">// usb 1-1: new full speed USB device using s3c2410-ohci and address 3</span><br><br>                        hub_set_address  <span class="hljs-comment">// 把编号(地址)告诉USB设备</span><br><br>                        usb_get_device_descriptor(udev, <span class="hljs-number">8</span>); <span class="hljs-comment">// 获取设备描述符</span><br>                        retval = usb_get_device_descriptor(udev, USB_DT_DEVICE_SIZE);<br><br>                        usb_new_device(udev)   <br>                            err = usb_get_configuration(udev); <span class="hljs-comment">// 把所有的描述符都读出来，并解析</span><br>                            usb_parse_configuration<br><br>                            device_add  <span class="hljs-comment">// 把device放入usb_bus_type的dev链表, </span><br>                                        <span class="hljs-comment">// 从usb_bus_type的driver链表里取出usb_driver，</span><br>                                        <span class="hljs-comment">// 把usb_interface和usb_driver的id_table比较</span><br>                                        <span class="hljs-comment">// 如果能匹配，调用usb_driver的probe</span><br></code></pre></td></tr></table></figure>

<h3 id="USB接口驱动和USB接口设备的匹配"><a href="#USB接口驱动和USB接口设备的匹配" class="headerlink" title="USB接口驱动和USB接口设备的匹配"></a>USB接口驱动和USB接口设备的匹配</h3><p>USB设备插入后根据获取到的设备描述符所创建的USB 接口设备和开发的USB接口驱动匹配： 对于设备： 将获取到的USB设备描述符信息保存在其id_table中。 对于驱动： 驱动的id_table中存放期望该驱动适用的USB设备。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device_id</span> <span class="hljs-title">usb_mouse_id_table</span>[] =</span> &#123;<br>	&#123; USB_INTERFACE_INFO(USB_INTERFACE_CLASS_HID, USB_INTERFACE_SUBCLASS_BOOT,<br>		USB_INTERFACE_PROTOCOL_MOUSE) &#125;,<br>	&#123; &#125;	<span class="hljs-comment">/* Terminating entry */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>匹配成功后调用该驱动的probe函数，具体的过程和前面分析的差不多。接下来就是在probe函数中，和USB总线驱动程序建立联系，以达到操作USB 鼠标设备的目的。</p>
<h3 id="创建数据传输管道"><a href="#创建数据传输管道" class="headerlink" title="创建数据传输管道"></a>创建数据传输管道</h3><p>根据数据传输类型，有几个接口可供调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Create various pipes... */</span><br><span class="hljs-comment">// 控制传输</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> usb_sndctrlpipe(dev, endpoint)	\</span><br><span class="hljs-meta">	((PIPE_CONTROL &lt;&lt; 30) | __create_pipe(dev, endpoint))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> usb_rcvctrlpipe(dev, endpoint)	\</span><br><span class="hljs-meta">	((PIPE_CONTROL &lt;&lt; 30) | __create_pipe(dev, endpoint) | USB_DIR_IN)</span><br><span class="hljs-comment">// 实时传输</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> usb_sndisocpipe(dev, endpoint)	\</span><br><span class="hljs-meta">	((PIPE_ISOCHRONOUS &lt;&lt; 30) | __create_pipe(dev, endpoint))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> usb_rcvisocpipe(dev, endpoint)	\</span><br><span class="hljs-meta">	((PIPE_ISOCHRONOUS &lt;&lt; 30) | __create_pipe(dev, endpoint) | USB_DIR_IN)</span><br><span class="hljs-comment">// 批量传输</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> usb_sndbulkpipe(dev, endpoint)	\</span><br><span class="hljs-meta">	((PIPE_BULK &lt;&lt; 30) | __create_pipe(dev, endpoint))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> usb_rcvbulkpipe(dev, endpoint)	\</span><br><span class="hljs-meta">	((PIPE_BULK &lt;&lt; 30) | __create_pipe(dev, endpoint) | USB_DIR_IN)</span><br><span class="hljs-comment">// 中断传输</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> usb_sndintpipe(dev, endpoint)	\</span><br><span class="hljs-meta">	((PIPE_INTERRUPT &lt;&lt; 30) | __create_pipe(dev, endpoint))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> usb_rcvintpipe(dev, endpoint)	\</span><br><span class="hljs-meta">	((PIPE_INTERRUPT &lt;&lt; 30) | __create_pipe(dev, endpoint) | USB_DIR_IN)</span><br></code></pre></td></tr></table></figure>

<p>对于USB 鼠标设备，使用中断传输方式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">dev</span> =</span> interface_to_usbdev(intf);<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_interface</span> *<span class="hljs-title">interface</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_endpoint_descriptor</span> *<span class="hljs-title">endpoint</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_mouse</span> *<span class="hljs-title">mouse</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">input_dev</span> *<span class="hljs-title">input_dev</span>;</span><br><span class="hljs-type">int</span> pipe, maxp;<br><span class="hljs-type">int</span> error = -ENOMEM;<br><br>interface = intf-&gt;cur_altsetting;<br><br><span class="hljs-keyword">if</span> (interface-&gt;desc.bNumEndpoints != <span class="hljs-number">1</span>)<br>	<span class="hljs-keyword">return</span> -ENODEV;<br><br>endpoint = &amp;interface-&gt;endpoint[<span class="hljs-number">0</span>].desc;<br><span class="hljs-keyword">if</span> (!usb_endpoint_is_int_in(endpoint))<br>	<span class="hljs-keyword">return</span> -ENODEV;<br><br><span class="hljs-comment">// 端点是USB设备数据传输对象</span><br>pipe = usb_rcvintpipe(dev, endpoint-&gt;bEndpointAddress);<br>maxp = usb_maxpacket(dev, pipe, usb_pipeout(pipe));<br></code></pre></td></tr></table></figure>

<h3 id="分配urb"><a href="#分配urb" class="headerlink" title="分配urb"></a>分配urb</h3><p>urb（USB Request Block）是Linux内核中USB驱动实现上的一个数据结构，用于组织每一次的USB设备驱动的数据传输请求。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">mouse-&gt;irq = usb_alloc_urb(<span class="hljs-number">0</span>, GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!mouse-&gt;irq)<br>	<span class="hljs-keyword">goto</span> fail2;<br></code></pre></td></tr></table></figure>

<h3 id="urb数据结构初始化"><a href="#urb数据结构初始化" class="headerlink" title="urb数据结构初始化"></a>urb数据结构初始化</h3><p>根据传输类型，有几个接口可供调用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// 控制</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">usb_fill_control_urb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> urb *urb,</span><br><span class="hljs-params">					<span class="hljs-keyword">struct</span> usb_device *dev,</span><br><span class="hljs-params">					<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> pipe,</span><br><span class="hljs-params">					<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *setup_packet,</span><br><span class="hljs-params">					<span class="hljs-type">void</span> *transfer_buffer,</span><br><span class="hljs-params">					<span class="hljs-type">int</span> buffer_length,</span><br><span class="hljs-params">					<span class="hljs-type">usb_complete_t</span> complete_fn,</span><br><span class="hljs-params">					<span class="hljs-type">void</span> *context)</span><br><span class="hljs-comment">// 批量</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">usb_fill_bulk_urb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> urb *urb,</span><br><span class="hljs-params">				     <span class="hljs-keyword">struct</span> usb_device *dev,</span><br><span class="hljs-params">				     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> pipe,</span><br><span class="hljs-params">				     <span class="hljs-type">void</span> *transfer_buffer,</span><br><span class="hljs-params">				     <span class="hljs-type">int</span> buffer_length,</span><br><span class="hljs-params">				     <span class="hljs-type">usb_complete_t</span> complete_fn,</span><br><span class="hljs-params">				     <span class="hljs-type">void</span> *context)</span><br><br><span class="hljs-comment">// 中断</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title function_">usb_fill_int_urb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> urb *urb,</span><br><span class="hljs-params">				    <span class="hljs-keyword">struct</span> usb_device *dev,</span><br><span class="hljs-params">				    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> pipe,</span><br><span class="hljs-params">				    <span class="hljs-type">void</span> *transfer_buffer,</span><br><span class="hljs-params">				    <span class="hljs-type">int</span> buffer_length,</span><br><span class="hljs-params">				    <span class="hljs-type">usb_complete_t</span> complete_fn,</span><br><span class="hljs-params">				    <span class="hljs-type">void</span> *context,</span><br><span class="hljs-params">				    <span class="hljs-type">int</span> interval)</span><br><span class="hljs-comment">// 实时   </span><br><span class="hljs-comment">// 实时urb 没有和中断、控制、批量urb 类似的初始化函数，因此它们在提交到USB核心之前，需要在驱动程序中手动的初始化</span><br></code></pre></td></tr></table></figure>

<p>对于USB鼠标设备，采用中断传输方式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">usb_fill_int_urb(mouse-&gt;irq, dev, pipe, mouse-&gt;data,<br>		 (maxp &gt; <span class="hljs-number">8</span> ? <span class="hljs-number">8</span> : maxp),<br>		 usb_mouse_irq, mouse, endpoint-&gt;bInterval);<br>mouse-&gt;irq-&gt;transfer_dma = mouse-&gt;data_dma;<br>mouse-&gt;irq-&gt;transfer_flags |= URB_NO_TRANSFER_DMA_MAP;<br></code></pre></td></tr></table></figure>

<h3 id="提交USB请求块"><a href="#提交USB请求块" class="headerlink" title="提交USB请求块"></a>提交USB请求块</h3><p>调用usb_submit_urb接口以获取USB设备数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">usb_mouse_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> input_dev *dev)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_mouse</span> *<span class="hljs-title">mouse</span> =</span> input_get_drvdata(dev);<br><br>	mouse-&gt;irq-&gt;dev = mouse-&gt;usbdev;<br>	<span class="hljs-keyword">if</span> (usb_submit_urb(mouse-&gt;irq, GFP_KERNEL))<br>		<span class="hljs-keyword">return</span> -EIO;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>USB驱动开发，针对某一个USB设备的某个功能（接口）构建的驱动程序。USB驱动并不直接和USB设备进行数据交互，而是通过USB总线驱动程序（USB Core和USB HCD）来操作USB设备的。一般构建USB设备驱动的流程为：</p>
<ul>
<li>根据期望适用的USB设备信息构建一个id_table。</li>
<li>根据需要的数据传输类型，调用相应的接口创建数据传输管道。</li>
<li>分配一个urb(USB请求块)。</li>
<li>根据需要的数据传输类型，调用相应的接口进行urb数据结构初始化。</li>
<li>提交urb</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/USB/" class="category-chain-item">USB</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>USB子系统</div>
      <div>https://tomwithkernel.github.io/kernel/usb/usb子系统/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Tom</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年5月18日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/script/README/" title="常用脚本">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">常用脚本</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/dbg_meth/crash/" title="crash">
                        <span class="hidden-mobile">crash</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"mGugYoHICpLi8BnBygCpEblQ-MdYXbMMI","appKey":"jxVWH2hG2DLvf0KjiGZ93acw","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://tomwithkernel.github.io/" target="_blank" rel="nofollow noopener"><span>Tom</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/TomWithKernel/kernel" target="_blank" rel="nofollow noopener"><span>repository</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
