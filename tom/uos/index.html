

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/tom.png">
  <link rel="icon" href="/img/tom.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Tom">
  <meta name="keywords" content="">
  
    <meta name="description" content="uos_proc.c123456789101112131415161718192021222324252627282930313233343536 &#x2F;&#x2F; SPDX-License-Identifier: GPL-2.0-only &#x2F;* * Copyright (C) 2018-2021 Uniontech Ltd, All Rights Reserved. * Author: tom &lt;to">
<meta property="og:type" content="article">
<meta property="og:title" content="uos">
<meta property="og:url" content="https://tomwithkernel.github.io/tom/uos/index.html">
<meta property="og:site_name" content="TomWithKernel&#39;s Blog">
<meta property="og:description" content="uos_proc.c123456789101112131415161718192021222324252627282930313233343536 &#x2F;&#x2F; SPDX-License-Identifier: GPL-2.0-only &#x2F;* * Copyright (C) 2018-2021 Uniontech Ltd, All Rights Reserved. * Author: tom &lt;to">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-05-07T08:10:30.000Z">
<meta property="article:modified_time" content="2025-07-18T01:21:22.962Z">
<meta property="article:author" content="Tom">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>uos - TomWithKernel&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="/css/scrollAnimation.css">
<link rel="stylesheet" href="/css/cloudedGlass.css">
<link rel="stylesheet" href="/css/selection.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"tomwithkernel.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":"mGugYoHICpLi8BnBygCpEblQ-MdYXbMMI","app_key":"jxVWH2hG2DLvf0KjiGZ93acw","server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2023-08-07T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body><!-- hexo injector body_begin start --><div id="web_bg"></div><!-- hexo injector body_begin end -->
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>TomWithKernel&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="uos"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-05-07 16:10" pubdate>
          2025年5月7日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          428 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">uos</h1>
            
            
              <div class="markdown-body">
                
                <h4 id="uos-proc-c"><a href="#uos-proc-c" class="headerlink" title="uos_proc.c"></a>uos_proc.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-comment">// SPDX-License-Identifier: GPL-2.0-only</span><br> <span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Copyright (C) 2018-2021 Uniontech Ltd, All Rights Reserved.</span><br><span class="hljs-comment"> * Author: tom &lt;tom@uniontech.com&gt;</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/proc_fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/vmalloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/uaccess.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_dir_entry</span>* <span class="hljs-title">uos_path</span>;</span><br><br><span class="hljs-comment">/* create /proc/uos entry */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">init_uos_proc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	uos_path = proc_mkdir(<span class="hljs-string">&quot;uos&quot;</span>, <span class="hljs-literal">NULL</span>);<br>	<span class="hljs-keyword">if</span>(!uos_path)<br>		<span class="hljs-keyword">return</span> -ENOMEM;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">exit_uos_proc</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	proc_remove(uos_path);<br>&#125;<br><br>module_init(init_uos_proc);<br>module_exit(exit_uos_proc);<br><br>MODULE_AUTHOR(<span class="hljs-string">&quot;tom &lt;tom@uniontech.com&gt;&quot;</span>);<br>MODULE_DESCRIPTION(<span class="hljs-string">&quot;UOS-specific directory in /proc&quot;</span>);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);<br><br></code></pre></td></tr></table></figure>

<h4 id="drivers-input-input-c"><a href="#drivers-input-input-c" class="headerlink" title="drivers&#x2F;input&#x2F;input.c"></a>drivers&#x2F;input&#x2F;input.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * input_get_dev_list - provide the address of input_dev_list to other modules</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Some modules want to get all the input device information.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> list_head *<span class="hljs-title function_">input_get_dev_list</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> &amp;input_dev_list;<br>&#125;<br>EXPORT_SYMBOL(input_get_dev_list);<br></code></pre></td></tr></table></figure>

<h4 id="uos-touchpad-switch-c"><a href="#uos-touchpad-switch-c" class="headerlink" title="uos_touchpad_switch.c"></a>uos_touchpad_switch.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs c"> <span class="hljs-comment">/**</span><br><span class="hljs-comment">  * SPDX-License-Identifier: GPL-2.0-only</span><br><span class="hljs-comment">  * Copyright (C) 2018-2021 Uniontech Ltd, All Rights Reserved.</span><br><span class="hljs-comment">  * Author: tom &lt;tom@uniontech.com&gt;</span><br><span class="hljs-comment">  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/proc_fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/vmalloc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/uaccess.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seq_file.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/input.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/input/mt.h&gt;</span></span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TOUCHPAD_MAX 16</span><br><span class="hljs-comment">/* create touchpad_switch file for open/close touchpad */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_dir_entry</span> *<span class="hljs-title">touchpad_switch</span>;</span><br><span class="hljs-type">static</span> u8 switch_buffer[TOUCHPAD_MAX] = &#123;<span class="hljs-string">&quot;enable\n&quot;</span>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">dev_list_head</span>;</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * touchpad_control - enable/disable touchpad and ps/2 mouse</span><br><span class="hljs-comment"> * Some ps/2 touchpad expose as ps/2 mouse</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">touchpad_control</span><span class="hljs-params">(<span class="hljs-type">bool</span> flag)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">dev_node</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">input_dev</span> *<span class="hljs-title">dev</span>;</span><br><br>	list_for_each(dev_node, dev_list_head) &#123;<br>		dev = list_entry(dev_node, <span class="hljs-keyword">struct</span> input_dev, node);<br>		<span class="hljs-keyword">if</span> (dev &amp;&amp; ((test_bit(BTN_TOUCH, dev-&gt;keybit) &amp;&amp; test_bit(BTN_TOOL_FINGER, dev-&gt;keybit) &amp;&amp; !test_bit(INPUT_PROP_DIRECT, dev-&gt;propbit))<br>		|| ((dev-&gt;id.bustype == BUS_I8042) &amp;&amp; test_bit(BTN_LEFT, dev-&gt;keybit)))) &#123;<br>			<span class="hljs-keyword">if</span> (!flag) &#123;<br>				input_report_key(dev, BTN_TOUCH, <span class="hljs-number">0</span>);<br>				input_report_key(dev, BTN_TOOL_FINGER, <span class="hljs-number">0</span>);<br><br>				<span class="hljs-keyword">if</span> (test_bit(EV_ABS, dev-&gt;evbit) &amp;&amp; test_bit(ABS_MT_SLOT, dev-&gt;absbit)) &#123;<br>					<span class="hljs-type">int</span> i;<br>					<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; dev-&gt;absinfo[ABS_MT_SLOT].maximum; i++) &#123;<br>						input_mt_slot(dev, i);<br>						input_mt_report_slot_state(dev, MT_TOOL_FINGER, <span class="hljs-number">0</span>);<br>					&#125;<br>					input_mt_sync_frame(dev);<br>				&#125;<br><br>				input_sync(dev);<br>				__set_bit(INPUT_PROP_TOUCHPAD_SWITCH, dev-&gt;propbit);<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				__clear_bit(INPUT_PROP_TOUCHPAD_SWITCH, dev-&gt;propbit);<br><br>				<span class="hljs-keyword">if</span> (test_bit(EV_ABS, dev-&gt;evbit) &amp;&amp; test_bit(ABS_MT_SLOT, dev-&gt;absbit)) &#123;<br>					input_mt_sync_frame(dev);<br>				&#125;<br>				input_sync(dev);<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">switch_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">char</span> __user *ubuf, <span class="hljs-type">size_t</span> count, <span class="hljs-type">loff_t</span> *ppos)</span><br>&#123;<br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (clear_user(ubuf, count)) &#123;<br>		printk(KERN_ERR <span class="hljs-string">&quot;clear error \n&quot;</span>);<br>		<span class="hljs-keyword">return</span> -EIO;<br>	&#125;<br>	ret = simple_read_from_buffer(ubuf, count, ppos, switch_buffer, TOUCHPAD_MAX);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">switch_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *ubuf, <span class="hljs-type">size_t</span> count, <span class="hljs-type">loff_t</span> *ppos)</span><br>&#123;<br>	<span class="hljs-type">int</span> ret;<br>	u8 temp[TOUCHPAD_MAX] = &#123;<span class="hljs-string">&quot;\0&quot;</span>&#125;;<br><br>	ret = simple_write_to_buffer(temp, TOUCHPAD_MAX, ppos, ubuf, count);<br>	<span class="hljs-keyword">if</span> (sysfs_streq(temp, <span class="hljs-string">&quot;disable\n&quot;</span>)) &#123;<br>		<span class="hljs-built_in">strcpy</span>(switch_buffer, <span class="hljs-string">&quot;disable\n&quot;</span>);<br>		touchpad_control(<span class="hljs-literal">false</span>);<br>	&#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sysfs_streq(temp, <span class="hljs-string">&quot;enable\n&quot;</span>)) &#123;<br>		<span class="hljs-built_in">strcpy</span>(switch_buffer, <span class="hljs-string">&quot;enable\n&quot;</span>);<br>		touchpad_control(<span class="hljs-literal">true</span>);<br>	&#125;<br>	<span class="hljs-keyword">else</span><br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">touchpad_switch_ops</span> =</span> &#123;<br>	.read =  switch_read,<br>	.write = switch_write,<br>&#125;;<br><br><span class="hljs-comment">/* create /proc/uos entry */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">init_touchpad_switch</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	touchpad_switch = proc_create(<span class="hljs-string">&quot;uos/touchpad_switch&quot;</span>, <span class="hljs-number">0644</span>, <span class="hljs-literal">NULL</span>, &amp;touchpad_switch_ops);<br>	<span class="hljs-keyword">if</span>(!touchpad_switch)<br>		<span class="hljs-keyword">return</span> -ENOMEM;<br><br>	dev_list_head = input_get_dev_list();<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">exit_touchpad_switch</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	proc_remove(touchpad_switch);<br>&#125;<br><br>module_init(init_touchpad_switch);<br>module_exit(exit_touchpad_switch);<br><br>MODULE_AUTHOR(<span class="hljs-string">&quot;tom &lt;tom@uniontech.com&gt;&quot;</span>);<br>MODULE_DESCRIPTION(<span class="hljs-string">&quot;UOS-specific touchpad switch in /proc&quot;</span>);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);<br><br></code></pre></td></tr></table></figure>

<h4 id="uos-touchpand-expand-c"><a href="#uos-touchpand-expand-c" class="headerlink" title="uos_touchpand_expand.c"></a>uos_touchpand_expand.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// SPDX-License-Identifier: GPL-2.0-only</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Copyright (C) 2025 Uniontech Ltd, All Rights Reserved.</span><br><span class="hljs-comment"> * Author: tom &lt;tom@uniontech.com&gt;</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * This module provides the functionality to control the</span><br><span class="hljs-comment"> * touchpad&#x27;s extended features through a HID report,</span><br><span class="hljs-comment"> * allowing enabling and disabling of the touchpad&#x27;s</span><br><span class="hljs-comment"> * edge shortcut feature.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * It creates a /proc/uos/touchpad_expand_switch file for user-space</span><br><span class="hljs-comment"> * control, where the value &quot;enable&quot; or &quot;disable&quot; can be</span><br><span class="hljs-comment"> * written to control the feature.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/proc_fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/uaccess.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/hid.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/platform_device.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/delay.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/slab.h&gt;</span></span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Version Information</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DRIVER_DESC <span class="hljs-string">&quot;uos touchpad edge shortcut key control function&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PROC_FILE <span class="hljs-string">&quot;uos/touchpad_expand_switch&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TOUCHPAD_MAX 16</span><br><br><span class="hljs-comment">/* HID REPORT DATA */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_REPORT_ID 0x43</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_BANK 3</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_ADDRESS 0x12</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_ENABLE_VALUE 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TP_DISABLE_VALUE 0</span><br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_dir_entry</span> *<span class="hljs-title">proc_file</span>;</span><br><br><span class="hljs-comment">/* proc default value */</span><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> proc_value[TOUCHPAD_MAX] = <span class="hljs-string">&quot;unknown\n&quot;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">touchpad_device</span> &#123;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> vendor_id;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> product_id;<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">touchpad_device</span> <span class="hljs-title">tp_dev_tables</span>[] =</span> &#123;<br>	&#123;<span class="hljs-number">0x093A</span>, <span class="hljs-number">0x0256</span>&#125;,	<span class="hljs-comment">// 亚米拉</span><br>	&#123;<span class="hljs-number">0x347D</span>, <span class="hljs-number">0x7853</span>&#125;,	<span class="hljs-comment">// 莱宝</span><br>	&#123;&#125;<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hid_device</span> *<span class="hljs-title">tp_hid_dev</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_device</span> *<span class="hljs-title">touchpad_pdev</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * sed_ctl_msg - Send a HID report to the HID device</span><br><span class="hljs-comment"> * 			     to control the touchpad extension feature</span><br><span class="hljs-comment"> * @hdev: hid device</span><br><span class="hljs-comment"> * @report_id: the report ID to identify the type of report</span><br><span class="hljs-comment"> * @bank: a separator or identifier for different configuration sets</span><br><span class="hljs-comment"> * @address: the address of the touchpad feature to modify</span><br><span class="hljs-comment"> * @value: the value to set, where 1 enables the feature and 0 disables it</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function sends a HID report to the HID device to control the touchpad</span><br><span class="hljs-comment"> * extension feature. The report is sent as a feature report</span><br><span class="hljs-comment"> * (HID_FEATURE_REPORT), and it uses the report ID, address, bank, and value</span><br><span class="hljs-comment"> * to communicate with the touchpad device.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The HID report will be sent using the `hid_hw_raw_request` function to</span><br><span class="hljs-comment"> * ensure that the HID device&#x27;s state is updated with the desired settings.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sed_ctl_msg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> hid_device *hdev,</span><br><span class="hljs-params">				   <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> report_id, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> bank,</span><br><span class="hljs-params">				   <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> address, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> value)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> buffer[<span class="hljs-number">4</span>];<br>	<span class="hljs-type">int</span> retval = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-comment">/* Fill the buffer with the report data */</span><br>	buffer[<span class="hljs-number">0</span>] = report_id;<br>	buffer[<span class="hljs-number">1</span>] = address;<br>	buffer[<span class="hljs-number">2</span>] = bank;<br>	buffer[<span class="hljs-number">3</span>] = value;<br><br>	pr_debug(<span class="hljs-string">&quot;Sending HID report to touchpad: report_id=0x%02x, address=0x%02x, &quot;</span><br>		 <span class="hljs-string">&quot;bank=0x%02x, value=0x%02x\n&quot;</span>, report_id, address, bank, value);<br><br>	<span class="hljs-comment">/* Send the HID report to the device */</span><br>	retval = hid_hw_raw_request(hdev, buffer[<span class="hljs-number">0</span>], buffer, <span class="hljs-keyword">sizeof</span>(buffer),<br>				    HID_FEATURE_REPORT, HID_REQ_SET_REPORT);<br>	<span class="hljs-keyword">if</span> (retval &lt; <span class="hljs-number">0</span>) &#123;<br>		pr_err(<span class="hljs-string">&quot;Failed to send hid report(tp_expand control data) to dev!&quot;</span>);<br>	&#125;<br>	<span class="hljs-keyword">return</span> retval;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * match_touchpad_device - Matches a HID device with a touchpad device based on</span><br><span class="hljs-comment"> * 			   vendor and product IDs</span><br><span class="hljs-comment"> * @dev: The device to match, passed as a generic device pointer</span><br><span class="hljs-comment"> * @data: some args to function</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function is used to match HID devices with the list of known touchpad devices.</span><br><span class="hljs-comment"> * It compares the vendor and product IDs of the HID device with those in the touchpad</span><br><span class="hljs-comment"> * device table (`tp_dev_tables`). If a match is found, it retrieves the matched HID device</span><br><span class="hljs-comment"> * and returns 1 to indicate a successful match.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">match_touchpad_device</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> device *dev, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hid_device</span> *<span class="hljs-title">hdev</span> =</span> to_hid_device(dev);<br>	<span class="hljs-type">int</span> i;<br><br>	<span class="hljs-keyword">if</span> (!hdev)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-comment">/* Debug print the current vendor and product IDs being matched */</span><br>	pr_debug(<span class="hljs-string">&quot;Current matching device: vendor_id=0x%04x, product_id=0x%04x\n&quot;</span>,<br>	         hdev-&gt;vendor, hdev-&gt;product);<br><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; ARRAY_SIZE(tp_dev_tables); i++) &#123;<br>		<span class="hljs-keyword">if</span> (hdev-&gt;vendor == tp_dev_tables[i].vendor_id &amp;&amp;<br>		    hdev-&gt;product == tp_dev_tables[i].product_id) &#123;<br>			tp_hid_dev = hdev;<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> hid_device *<span class="hljs-title function_">find_hid_device</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	bus_for_each_dev(&amp;hid_bus_type, <span class="hljs-literal">NULL</span>, tp_dev_tables,<br>			 match_touchpad_device);<br>	<span class="hljs-keyword">return</span> tp_hid_dev;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">touchpad_expand_control</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> value)</span><br>&#123;<br>	<span class="hljs-type">int</span> ret = <span class="hljs-number">-1</span>;<br><br>	<span class="hljs-keyword">if</span> (!tp_hid_dev) &#123;<br>		pr_err(<span class="hljs-string">&quot;tp_hid_dev is NULL! Can&#x27;t send msg!\n&quot;</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>	&#125;<br><br>	ret = sed_ctl_msg(tp_hid_dev, TP_REPORT_ID, TP_BANK,<br>			  TP_ADDRESS, value);<br><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">tp_exp_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> count,</span><br><span class="hljs-params">			   <span class="hljs-type">loff_t</span> *offset)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> simple_read_from_buffer(buf, count, offset, proc_value,<br>				       <span class="hljs-built_in">strlen</span>(proc_value));<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * tp_exp_write - Write handler for the touchpad expansion control proc file</span><br><span class="hljs-comment"> * @file: The proc file structure representing the file being written to</span><br><span class="hljs-comment"> * @buf: The data buffer containing the user input</span><br><span class="hljs-comment"> * @count: The number of bytes to write from the user buffer</span><br><span class="hljs-comment"> * @offset: The file offset (not used here)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This function is the write handler for the /proc/uos/touchpad_expand file.</span><br><span class="hljs-comment"> * It processes the user input and takes action to enable or disable the</span><br><span class="hljs-comment"> * touchpad expansion feature based on the written value.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">tp_exp_write</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *buf,</span><br><span class="hljs-params">			    <span class="hljs-type">size_t</span> count, <span class="hljs-type">loff_t</span> *offset)</span><br>&#123;<br>	<span class="hljs-type">char</span> temp_buf[TOUCHPAD_MAX] = &#123;<span class="hljs-string">&quot;\0&quot;</span>&#125;;<br><br>	<span class="hljs-keyword">if</span> (count &gt;= <span class="hljs-keyword">sizeof</span>(temp_buf))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	<span class="hljs-keyword">if</span> (copy_from_user(temp_buf, buf, count))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	temp_buf[count] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>	strim(temp_buf);<br><br>	<span class="hljs-keyword">if</span> (sysfs_streq(temp_buf, <span class="hljs-string">&quot;enable&quot;</span>)) &#123;<br>		<span class="hljs-keyword">if</span> (touchpad_expand_control(TP_ENABLE_VALUE) &gt;= <span class="hljs-number">0</span>) &#123;<br>			<span class="hljs-built_in">strcpy</span>(proc_value, <span class="hljs-string">&quot;enable\n&quot;</span>);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-keyword">return</span> -EIO;<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sysfs_streq(temp_buf, <span class="hljs-string">&quot;disable&quot;</span>)) &#123;<br>		<span class="hljs-keyword">if</span> (touchpad_expand_control(TP_DISABLE_VALUE) &gt;= <span class="hljs-number">0</span>) &#123;<br>			<span class="hljs-built_in">strcpy</span>(proc_value, <span class="hljs-string">&quot;disable\n&quot;</span>);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-keyword">return</span> -EIO;<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> count;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">touchpad_switch_ops</span> =</span> &#123;<br>	.read = tp_exp_read,<br>	.write = tp_exp_write,<br>&#125;;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Platform device and driver for touchpad expansion control</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">touchpad_expand_delayed_work</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> work_struct *work)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (sysfs_streq(proc_value, <span class="hljs-string">&quot;enable\n&quot;</span>)) &#123;<br>		touchpad_expand_control(TP_ENABLE_VALUE);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sysfs_streq(proc_value, <span class="hljs-string">&quot;disable\n&quot;</span>)) &#123;<br>		touchpad_expand_control(TP_DISABLE_VALUE);<br>	&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-title function_">DECLARE_DELAYED_WORK</span><span class="hljs-params">(touchpad_expand_work, touchpad_expand_delayed_work)</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">touchpad_expand_resume</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> device *dev)</span><br>&#123;<br>	schedule_delayed_work(&amp;touchpad_expand_work, msecs_to_jiffies(<span class="hljs-number">3000</span>));<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">touchpad_expand_restore</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> device *dev)</span><br>&#123;<br>	schedule_delayed_work(&amp;touchpad_expand_work, msecs_to_jiffies(<span class="hljs-number">3000</span>));<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dev_pm_ops</span> <span class="hljs-title">touchpad_expand_pm_ops</span> =</span> &#123;<br>	.resume = touchpad_expand_resume,<br>	.restore = touchpad_expand_restore,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">platform_driver</span> <span class="hljs-title">touchpad_expand_driver</span> =</span> &#123;<br>	.driver = &#123;<br>		.name = <span class="hljs-string">&quot;touchpad_expand&quot;</span>,<br>		.pm = &amp;touchpad_expand_pm_ops,<br>	&#125;,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">touchpad_expand_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-type">int</span> ret;<br><br>	tp_hid_dev = find_hid_device();<br>	<span class="hljs-keyword">if</span> (!tp_hid_dev) &#123;<br>		<span class="hljs-keyword">return</span> -ENODEV;<br>	&#125;<br><br>	proc_file = proc_create(PROC_FILE, <span class="hljs-number">0644</span>, <span class="hljs-literal">NULL</span>, &amp;touchpad_switch_ops);<br>	<span class="hljs-keyword">if</span> (!proc_file) &#123;<br>		<span class="hljs-keyword">return</span> -ENOMEM;<br>	&#125;<br><br>	touchpad_pdev = platform_device_register_simple(<span class="hljs-string">&quot;touchpad_expand&quot;</span>, <span class="hljs-number">-1</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (IS_ERR(touchpad_pdev)) &#123;<br>		<span class="hljs-keyword">return</span> PTR_ERR(touchpad_pdev);<br>	&#125;<br><br>	ret = platform_driver_register(&amp;touchpad_expand_driver);<br>	<span class="hljs-keyword">if</span> (ret) &#123;<br>		platform_device_unregister(touchpad_pdev);<br>		<span class="hljs-keyword">return</span> ret;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> __exit <span class="hljs-title function_">touchpad_expand_exit</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (proc_file) &#123;<br>		remove_proc_entry(PROC_FILE, <span class="hljs-literal">NULL</span>);<br>		<span class="hljs-keyword">if</span> (touchpad_pdev) &#123;<br>			platform_driver_unregister(&amp;touchpad_expand_driver);<br>			platform_device_unregister(touchpad_pdev);<br>		&#125;<br>	&#125;<br>&#125;<br><br>late_initcall(touchpad_expand_init);<br>module_exit(touchpad_expand_exit);<br><br>MODULE_AUTHOR(<span class="hljs-string">&quot;tom&quot;</span>);<br>MODULE_DESCRIPTION(DRIVER_DESC);<br>MODULE_LICENSE(<span class="hljs-string">&quot;GPL&quot;</span>);<br><br></code></pre></td></tr></table></figure>





<h4 id="usb-forbid-rule-c"><a href="#usb-forbid-rule-c" class="headerlink" title="usb_forbid_rule.c"></a>usb_forbid_rule.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// SPDX-License-Identifier: GPL-2.0-only</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Copyright (C) 2018-2021 Uniontech Ltd, All Rights Reserved.</span><br><span class="hljs-comment"> * Author: tom &lt;t@uniontech.com&gt;</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/cache.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/cpu.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/cpufeature.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/dmi.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/bitops.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/bug.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/compat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/elf.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/init.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/personality.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/preempt.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/printk.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seq_file.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/smp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/delay.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/dmi.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/kernel.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/usb.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/genhd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;scsi/scsi.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;scsi/scsi_cmnd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;scsi/scsi_device.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;scsi/scsi_host.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/cdrom.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;scsi/scsi_driver.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/device.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;scsi/sg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;scsi/scsi_proto.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../scsi/sd.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../scsi/sr.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../usb/core/usb.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../usb/storage/usb.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../usb/host/xhci.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DMI_USB_RULE_TYPE 251</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DMI_USB_RULE_MAXNUM 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DMI_USB_RULE_MAXLEN 0x80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_RULE_VERSION_V1 0x01</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_RULE_VERSION_V2 0x02</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_RULE_VERSION_V3 0x03</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BLACK_RULE 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WHITE_RULE 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RULE_MASK 1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> READ_RIGHT_MASK 0x2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WRITE_RIGHT_MASK 0x4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXCE_RIGHT_MASK 0x8</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UOS_FORBID 0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> UOS_ALLOW 1</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_CMNDS 256</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uas_dev_info</span> &#123;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">intf</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">udev</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_anchor</span> <span class="hljs-title">cmd_urbs</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_anchor</span> <span class="hljs-title">sense_urbs</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_anchor</span> <span class="hljs-title">data_urbs</span>;</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br>        <span class="hljs-type">int</span> qdepth, resetting;<br>        <span class="hljs-type">unsigned</span> cmd_pipe, status_pipe, data_in_pipe, data_out_pipe;<br>        <span class="hljs-type">unsigned</span> use_streams:<span class="hljs-number">1</span>;<br>        <span class="hljs-type">unsigned</span> shutdown:<span class="hljs-number">1</span>;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scsi_cmnd</span> *<span class="hljs-title">cmnd</span>[<span class="hljs-title">MAX_CMNDS</span>];</span><br>        <span class="hljs-type">spinlock_t</span> lock;<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">work</span>;</span><br>        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">work_struct</span> <span class="hljs-title">scan_work</span>;</span>      <span class="hljs-comment">/* for async scanning */</span><br>&#125;;<br><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">uos_usb_base_class_bitmap</span> &#123;</span><br>	UOS_USB_CLASS_NONE = <span class="hljs-number">0</span>,  <span class="hljs-comment">/* 00h	 Device	Use class information in the Interface Descriptors */</span><br>	UOS_USB_CLASS_AUDIO = <span class="hljs-number">1</span>, <span class="hljs-comment">/* 01h	 Interface	Audio */</span><br>	UOS_USB_CLASS_COMMUNICATION = <span class="hljs-number">2</span>, <span class="hljs-comment">/* 02h	Both	Communications&amp;CDC */</span><br>	UOS_USB_CLASS_HID = <span class="hljs-number">3</span>, <span class="hljs-comment">/* 03h	Interface	HID(Human Interface Device) */</span><br>	UOS_USB_CLASS_PHY = <span class="hljs-number">5</span>, <span class="hljs-comment">/* 05h	Interface	Physical */</span><br>	UOS_USB_CLASS_IMAGE = <span class="hljs-number">6</span>, <span class="hljs-comment">/* 06h 	Interface	Image */</span><br>	UOS_USB_CLASS_PRINT = <span class="hljs-number">7</span>, <span class="hljs-comment">/* 07h 	Interface	Printer */</span><br>	UOS_USB_CLASS_MASS = <span class="hljs-number">8</span>, <span class="hljs-comment">/* 08h	Interface	Mass Storage */</span><br>	UOS_USB_CLASS_HUB = <span class="hljs-number">9</span>, <span class="hljs-comment">/* 09h	Device	Hub */</span><br>	UOS_USB_CLASS_CDC = <span class="hljs-number">0xA</span>, <span class="hljs-comment">/* 0Ah	 Interface	CDC-Data */</span><br>	UOS_USB_CLASS_SMART = <span class="hljs-number">0xB</span>, <span class="hljs-comment">/* 0Bh	Interface	Smart Card */</span><br>	UOS_USB_CLASS_SECURITY = <span class="hljs-number">0xD</span>, <span class="hljs-comment">/* 0Dh	Interface	Content Security */</span><br>	UOS_USB_CLASS_VIDEO = <span class="hljs-number">0xE</span>, <span class="hljs-comment">/* 0Eh	Interface	Video */</span><br>	UOS_USB_CLASS_HEALTH = <span class="hljs-number">0xF</span>, <span class="hljs-comment">/* 0Fh	Interface	Personal Healthcare */</span><br>	UOS_USB_CLASS_MEDIA = <span class="hljs-number">0x10</span>, <span class="hljs-comment">/* 10h	Interface	Audio/Video Devices */</span><br>	UOS_USB_CLASS_BILL =  <span class="hljs-number">0x11</span>, <span class="hljs-comment">/* 11h	Device	Billboard Device Class */</span><br>	UOS_USB_CLASS_TYPEC = <span class="hljs-number">0x12</span>,  <span class="hljs-comment">/* 12h	Interface	USB Type-C Bridge Class */</span><br>	UOS_USB_CLASS_DIAG = <span class="hljs-number">0xDC</span>, <span class="hljs-comment">/* DCh	Both	Diagnostic Device */</span><br>	UOS_USB_CLASS_WIFI = <span class="hljs-number">0xE0</span>, <span class="hljs-comment">/* E0h	Interface	Wireless Controller */</span><br>	UOS_USB_CLASS_MISC = <span class="hljs-number">0xEF</span>, <span class="hljs-comment">/* EFh	Both	Miscellaneous */</span><br>	UOS_USB_CLASS_APP = <span class="hljs-number">0xFE</span>, <span class="hljs-comment">/* FEh	Interface	Application Specific */</span><br>	UOS_USB_CLASS_VENDOR = <span class="hljs-number">0xFF</span>, <span class="hljs-comment">/* FFh	Both	Vendor Specific */</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">uos_usb_controller_capacity</span> &#123;</span><br>	UOS_USB_CONTROLLER_PCI = <span class="hljs-number">0</span>,<br>	UOS_USB_CONTROLLER_MMIO = <span class="hljs-number">1</span>,<br>	UOS_USB_CONTROLLER_MAX = <span class="hljs-number">0x10</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dmi_usb_rule_header</span> &#123;</span><br>	u8 type;<br>	u8 length;<br>	u16 handle;<br>	u32 signature;<br>	u16 version;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_rule_pci_bus_name</span> &#123;</span><br>        u32 controller_segment;<br>        u16 controller_bus;<br>        u8 controller_device;<br>        u8 controller_function;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">usb_controller</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_rule_pci_bus_name</span> <span class="hljs-title">pci_controller</span>;</span><br>	u64 mmio_controller;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dmi_usb_rule_v1</span> &#123;</span><br>	u8 type;<br>	u8 length;<br>	u16 handle;<br>	u32 signature;<br>	u16 version;<br>	u16 priority;<br>	<span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">usb_controller</span> <span class="hljs-title">usb_controller_name</span>;</span><br>	u8 port_path_str[<span class="hljs-number">16</span>];<br>	u16 usb_vendor;<br>	u16 usb_product;<br>	u16 device_class;<br>	u8 device_subclass;<br>	u8 device_protocol;<br>	u32 support_property;<br>&#125; __attribute__ ((packed));<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_rule_match_info</span> &#123;</span><br>	<span class="hljs-type">char</span> *bus_name;<br>	<span class="hljs-type">char</span> *dev_path;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface_descriptor</span> *<span class="hljs-title">desc</span>;</span><br>	u16 usb_vendor;<br>	u8 usb_product;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mtp_struct</span> &#123;</span><br>	u32 container_length;<br>	u16 container_type;<br>	u16 operation_code;<br>	u32 transaction_id;<br>	<span class="hljs-type">void</span> *payload;<br>&#125;;<br><br><span class="hljs-type">bool</span> usb_rule_init_flag = <span class="hljs-literal">false</span>;<br>EXPORT_SYMBOL(usb_rule_init_flag);<br><span class="hljs-type">bool</span> usb_rule_is_real = <span class="hljs-literal">false</span>;<br>EXPORT_SYMBOL(usb_rule_is_real); <span class="hljs-comment">/* for do_mount */</span><br><br><span class="hljs-type">static</span> u32 usb_rule_counter; <span class="hljs-comment">/* usb forbid rules number */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dmi_usb_rule_v1</span> * <span class="hljs-title">dmi_usb_rule_table_v1</span>[<span class="hljs-title">DMI_USB_RULE_MAXNUM</span>];</span> <span class="hljs-comment">/* usb forbid rules number */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">get_usb_rule_by_dmi</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> dmi_header *dm, <span class="hljs-type">void</span> *data)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dmi_usb_rule_header</span> *<span class="hljs-title">usb_rule_header</span>;</span><br>	<span class="hljs-type">void</span> *usb_rule_entry;<br><br>	<span class="hljs-keyword">if</span>(!dm || (dm-&gt;type != DMI_USB_RULE_TYPE))<br>		<span class="hljs-keyword">return</span>;<br><br>	usb_rule_header = (<span class="hljs-keyword">struct</span> dmi_usb_rule_header *)dm;<br>	<span class="hljs-keyword">if</span>(usb_rule_header-&gt;length &gt; DMI_USB_RULE_MAXLEN) &#123;<br>		printk(KERN_ERR <span class="hljs-string">&quot;the data length is to long(%d), ignore. \n\r&quot;</span>, usb_rule_header-&gt;length);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	<span class="hljs-keyword">if</span>(usb_rule_header-&gt;length != <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> dmi_usb_rule_v1)) &#123;<br>		printk(KERN_ERR <span class="hljs-string">&quot;the data length(%d) is equal size of rule struct, ignore. \n\r&quot;</span>, usb_rule_header-&gt;length);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span>(usb_rule_header-&gt;version == USB_RULE_VERSION_V1 || usb_rule_header-&gt;version == USB_RULE_VERSION_V2 || usb_rule_header-&gt;version == USB_RULE_VERSION_V3) &#123;<br>		usb_rule_entry = (<span class="hljs-keyword">struct</span> dmi_usb_rule_v1 *) kmalloc (<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> dmi_usb_rule_v1), GFP_KERNEL);<br>		<span class="hljs-keyword">if</span> (usb_rule_entry == <span class="hljs-literal">NULL</span>) &#123;<br>			printk(KERN_ERR <span class="hljs-string">&quot;get_usb_rule_by_dmi alloc memory fail. \n\r&quot;</span>);<br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br>		<span class="hljs-built_in">memcpy</span>(usb_rule_entry, dm, <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> dmi_usb_rule_v1));<br>		dmi_usb_rule_table_v1[usb_rule_counter] = usb_rule_entry;<br>		usb_rule_counter++;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">return</span>; <span class="hljs-comment">/* Reserved for other versions */</span><br>	&#125;<br>	<span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">usb_rule_data_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	usb_rule_counter = <span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">memset</span>(&amp;dmi_usb_rule_table_v1[<span class="hljs-number">0</span>], <span class="hljs-number">0x0</span>, <span class="hljs-keyword">sizeof</span>(dmi_usb_rule_table_v1));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">usb_rule_data_free</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-type">int</span> i;<br><br>	<span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i &lt; usb_rule_counter; i++) &#123;<br>		<span class="hljs-keyword">if</span>(!dmi_usb_rule_table_v1[i])<br>			kfree(dmi_usb_rule_table_v1[i]);<br>	&#125;<br>	<span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">pci_bus_name_to_num</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *bus_name, <span class="hljs-keyword">struct</span> usb_rule_pci_bus_name *pci_bus_name)</span><br>&#123;<br>	<span class="hljs-type">char</span> bus_name_tmp[<span class="hljs-number">16</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> tmp;<br><br>	<span class="hljs-comment">/* para check */</span><br>	<span class="hljs-keyword">if</span>(!bus_name || !pci_bus_name || (<span class="hljs-built_in">strlen</span>(bus_name) &gt;= <span class="hljs-number">16</span>)) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br><br>	<span class="hljs-built_in">memcpy</span>(bus_name_tmp, bus_name, <span class="hljs-built_in">strlen</span>(bus_name));<br><br>	<span class="hljs-comment">/* bus name format: xxxx:xx:xx.x */</span><br>	<span class="hljs-comment">/* clear &#x27;:&#x27; for strings to number */</span><br>	bus_name_tmp[<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>;<br>	bus_name_tmp[<span class="hljs-number">7</span>] = <span class="hljs-number">0</span>;<br>	bus_name_tmp[<span class="hljs-number">10</span>] = <span class="hljs-number">0</span>;<br>	bus_name_tmp[<span class="hljs-number">12</span>] = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span>(kstrtoul(&amp;bus_name_tmp[<span class="hljs-number">0</span>], <span class="hljs-number">16</span>, &amp;tmp) == <span class="hljs-number">0</span>) &#123;<br>		pci_bus_name-&gt;controller_segment = (u32)tmp;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span>(kstrtoul(&amp;bus_name_tmp[<span class="hljs-number">5</span>], <span class="hljs-number">16</span>, &amp;tmp) == <span class="hljs-number">0</span>) &#123;<br>		pci_bus_name-&gt;controller_bus = (u16)tmp;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span>(kstrtoul(&amp;bus_name_tmp[<span class="hljs-number">8</span>], <span class="hljs-number">16</span>, &amp;tmp) == <span class="hljs-number">0</span>) &#123;<br>		pci_bus_name-&gt;controller_device = (u8)tmp;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span>(kstrtoul(&amp;bus_name_tmp[<span class="hljs-number">11</span>], <span class="hljs-number">16</span>, &amp;tmp) == <span class="hljs-number">0</span>) &#123;<br>		pci_bus_name-&gt;controller_function = (u8)tmp;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">uos_usb_rule_pci_name_match</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dmi_usb_rule_v1 *usb_rule_entry, <span class="hljs-keyword">struct</span> usb_rule_pci_bus_name *pci_bus_name)</span><br>&#123;<br>	<span class="hljs-keyword">if</span>((pci_bus_name-&gt;controller_segment != usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_segment) &amp;&amp; (usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_segment != <span class="hljs-number">0xffffffff</span>))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-keyword">if</span>((pci_bus_name-&gt;controller_bus != usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_bus) &amp;&amp; (usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_bus != <span class="hljs-number">0xffff</span>))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-keyword">if</span>((pci_bus_name-&gt;controller_device != usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_device) &amp;&amp; (usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_device != <span class="hljs-number">0xff</span>))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-keyword">if</span>((pci_bus_name-&gt;controller_function != usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_function) &amp;&amp; (usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_function != <span class="hljs-number">0xff</span>))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">uos_usb_rule_mmio_name_match</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *bus_name, u64 controller)</span><br>&#123;<br>	<span class="hljs-type">char</span> mmio_bus_name[<span class="hljs-number">18</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>	<span class="hljs-built_in">snprintf</span>(mmio_bus_name, <span class="hljs-number">16</span>, <span class="hljs-string">&quot;%-15x&quot;</span>, controller);<br>	strim(mmio_bus_name);<br>	<span class="hljs-keyword">if</span>(<span class="hljs-built_in">strncmp</span>(mmio_bus_name, bus_name, <span class="hljs-built_in">strlen</span>(mmio_bus_name)) != <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">uos_usb_rule_interface_class_match</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dmi_usb_rule_v1	*usb_rule_entry, <span class="hljs-keyword">struct</span> usb_interface_descriptor *desc)</span><br>&#123;<br>	<span class="hljs-keyword">if</span>((desc-&gt;bInterfaceClass != usb_rule_entry-&gt;device_class) &amp;&amp; (usb_rule_entry-&gt;device_class != <span class="hljs-number">0xffff</span>))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-keyword">if</span>((desc-&gt;bInterfaceSubClass != usb_rule_entry-&gt;device_subclass) &amp;&amp; (usb_rule_entry-&gt;device_subclass != <span class="hljs-number">0xff</span>))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-keyword">if</span>((desc-&gt;bInterfaceProtocol != usb_rule_entry-&gt;device_protocol) &amp;&amp; (usb_rule_entry-&gt;device_protocol != <span class="hljs-number">0xff</span>))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">uos_usb_rule_port_path_match</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dmi_usb_rule_v1 *usb_rule_entry, <span class="hljs-type">char</span> *dev_path)</span><br>&#123;<br>	<span class="hljs-type">char</span> port_path_str[<span class="hljs-number">16</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>	<span class="hljs-type">char</span> match_path_str[<span class="hljs-number">16</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br>	<span class="hljs-type">int</span> i, j, len = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">char</span> *position = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">int</span> bus_name_len = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span> match_len = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-built_in">memcpy</span>(port_path_str, &amp;usb_rule_entry-&gt;port_path_str[<span class="hljs-number">0</span>], <span class="hljs-number">16</span>);<br><br>	<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">16</span>; i++) &#123;<br>		<span class="hljs-keyword">if</span> (port_path_str[i] == <span class="hljs-number">0</span>) &#123;<br>			len = i;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span>(port_path_str[i] == <span class="hljs-string">&#x27;x&#x27;</span> || port_path_str[i] == <span class="hljs-string">&#x27;X&#x27;</span>) &#123;<br>			len = i<span class="hljs-number">-1</span>;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/* complete dev_path char &#x27;0&#x27; */</span><br>        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16</span>; i ++) &#123;<br>		<span class="hljs-keyword">if</span> (dev_path[i] == <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">break</span>;<br><br>                <span class="hljs-keyword">if</span> ((dev_path[i+<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;.&#x27;</span> &amp;&amp; i == <span class="hljs-number">0</span> ) ||<br>		    (dev_path[i+<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>   &amp;&amp; i == <span class="hljs-number">0</span> ) ||<br>                    (dev_path[i+<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;.&#x27;</span> &amp;&amp; i &gt; <span class="hljs-number">0</span> &amp;&amp; dev_path[i<span class="hljs-number">-1</span>] == <span class="hljs-string">&#x27;.&#x27;</span>) ||<br>		    (dev_path[i+<span class="hljs-number">1</span>] == <span class="hljs-number">0</span>   &amp;&amp; i &gt; <span class="hljs-number">0</span> &amp;&amp; dev_path[i<span class="hljs-number">-1</span>] == <span class="hljs-string">&#x27;.&#x27;</span>)<br>		 ) &#123;<br>                        match_path_str[j] = <span class="hljs-string">&#x27;0&#x27;</span>;<br>                        j++;<br>                &#125;<br>                match_path_str[j] = dev_path[i];<br>                j++;<br>        &#125;<br>        match_path_str[j] = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">//	printk(KERN_ERR &quot;%s: port_path_str=%s, match_path_str=%s, dev_path:%s, len:%d \n\r&quot;,__func__, port_path_str, match_path_str, dev_path, len);</span><br>	<span class="hljs-keyword">if</span>(<span class="hljs-built_in">strncmp</span>(port_path_str, match_path_str, len) == <span class="hljs-number">0</span>) &#123;<br><span class="hljs-comment">//		printk(KERN_ERR &quot;%s: matched port_path_str=%s, match_path_str=%s, dev_path:%s, len:%d \n\r&quot;,__func__, port_path_str, match_path_str, dev_path, len);</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-type">char</span> <span class="hljs-title function_">uos_storage_right</span><span class="hljs-params">(u32 property)</span><br>&#123;<br>	<span class="hljs-type">char</span>  rwx = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span>(property &amp; RULE_MASK) &#123; <span class="hljs-comment">/* BLACK_RULE 0　WHITE_RULE 1 */</span><br>		rwx = (u8) ((property &amp; (READ_RIGHT_MASK | WRITE_RIGHT_MASK | EXCE_RIGHT_MASK)) &gt;&gt; <span class="hljs-number">1</span>) &amp; <span class="hljs-number">7</span>;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-comment">//		rwx = (u8)(~(property &amp; (READ_RIGHT_MASK | WRITE_RIGHT_MASK | EXCE_RIGHT_MASK)) &gt;&gt; 1) &amp; 7;</span><br>		rwx = <span class="hljs-number">0</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> rwx;<br>&#125;<br><br><span class="hljs-type">bool</span> <span class="hljs-title function_">uos_usb_controller_match</span><span class="hljs-params">(<span class="hljs-type">char</span> *bus_name, <span class="hljs-keyword">struct</span> dmi_usb_rule_v1 *usb_rule_entry)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_rule_pci_bus_name</span> <span class="hljs-title">pci_bus_name</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">uos_usb_controller_capacity</span> <span class="hljs-title">capacity</span> =</span> UOS_USB_CONTROLLER_MAX;<br>	<br>	<span class="hljs-keyword">if</span> (usb_rule_entry-&gt;version == USB_RULE_VERSION_V1)<br>		capacity = UOS_USB_CONTROLLER_PCI;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (usb_rule_entry-&gt;version == USB_RULE_VERSION_V2) &#123;<br>		capacity = (usb_rule_entry-&gt;support_property &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x0F</span>;<br>	&#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (usb_rule_entry-&gt;version == USB_RULE_VERSION_V3) &#123;<br>		capacity = (usb_rule_entry-&gt;support_property &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0x0F</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span>(capacity == UOS_USB_CONTROLLER_PCI) &#123;<br>		<span class="hljs-keyword">if</span>(!pci_bus_name_to_num(bus_name, &amp;pci_bus_name))<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>		<span class="hljs-keyword">return</span> uos_usb_rule_pci_name_match(usb_rule_entry, &amp;pci_bus_name);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (capacity == UOS_USB_CONTROLLER_MMIO)&#123;<br>		<span class="hljs-keyword">return</span> uos_usb_rule_mmio_name_match(bus_name, usb_rule_entry-&gt;usb_controller_name.mmio_controller);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-comment">/* return val: forbid 0 , allow 1 */</span><br><span class="hljs-type">bool</span> <span class="hljs-title function_">uos_usb_rule_match</span><span class="hljs-params">(<span class="hljs-type">char</span> *bus_name, <span class="hljs-type">char</span> *dev_path, <span class="hljs-type">char</span> *raw_dev_path, <span class="hljs-keyword">struct</span> usb_interface_descriptor *desc)</span><br>&#123;<br>	<span class="hljs-type">bool</span> ret;<br>	<span class="hljs-type">int</span> i, priority = <span class="hljs-number">-1</span>;<br>	<span class="hljs-type">int</span> property = <span class="hljs-number">-1</span>;<br>	<span class="hljs-type">char</span> bInterfaceClass;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dmi_usb_rule_v1</span> *<span class="hljs-title">usb_rule_entry</span>;</span><br><br><br>	<span class="hljs-comment">/* para check */</span><br>	<span class="hljs-keyword">if</span> (!bus_name || !dev_path || !usb_rule_counter) &#123;<br>		<span class="hljs-keyword">return</span> UOS_ALLOW;<br>	&#125;<br><br>	<span class="hljs-comment">/* usb hub device won&#x27;t match usb forbid rule */</span><br>	<span class="hljs-keyword">if</span> (desc &amp;&amp; desc-&gt;bInterfaceClass == UOS_USB_CLASS_HUB)<br>		<span class="hljs-keyword">return</span> UOS_ALLOW;<br><br>	<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i &lt; usb_rule_counter; i++) &#123;<br>		usb_rule_entry = dmi_usb_rule_table_v1[i];<br>		<span class="hljs-keyword">if</span>(priority &gt;= usb_rule_entry-&gt;priority)  <span class="hljs-comment">/* ignore low priority rule */</span><br>			<span class="hljs-keyword">continue</span>;<br><br>		ret = uos_usb_controller_match(bus_name, usb_rule_entry);<br>		<span class="hljs-keyword">if</span>(!ret)<br>			<span class="hljs-keyword">continue</span>;<br><br>		<span class="hljs-keyword">if</span>(usb_rule_entry-&gt;version &lt; USB_RULE_VERSION_V3)<br>			ret = uos_usb_rule_port_path_match(usb_rule_entry, dev_path);<br>		<span class="hljs-keyword">else</span><br>			ret = uos_usb_rule_port_path_match(usb_rule_entry, raw_dev_path);<br>		<span class="hljs-keyword">if</span>(!ret)<br>			<span class="hljs-keyword">continue</span>;<br><br>		ret = uos_usb_rule_interface_class_match(usb_rule_entry, desc);<br>		<span class="hljs-keyword">if</span>(!ret)<br>			<span class="hljs-keyword">continue</span>;<br><br>		<span class="hljs-comment">/*  To be expanded</span><br><span class="hljs-comment">		ret = uos_usb_rule_vid_match(usb_rule_entry, int vid, int pid);</span><br><span class="hljs-comment">		if(!ret)</span><br><span class="hljs-comment">			continue;</span><br><span class="hljs-comment">		*/</span><br><br>		<span class="hljs-comment">/* match entry */</span><br>		priority = usb_rule_entry-&gt;priority;<br>		property = usb_rule_entry-&gt;support_property;<br>		bInterfaceClass = usb_rule_entry-&gt;device_class;<br>		usb_rule_is_real = <span class="hljs-literal">true</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span>(priority &gt;= <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">/* matched */</span><br>		printk(KERN_INFO <span class="hljs-string">&quot;%s:usb rule matched.  property = %d, priority=%d \n\r&quot;</span>, __func__, property, priority);<br>		<span class="hljs-keyword">if</span>(bInterfaceClass == UOS_USB_CLASS_MASS) &#123;	<span class="hljs-comment">/* storage rule */</span><br>			<span class="hljs-keyword">return</span> !!uos_storage_right(property);<br>		&#125; <span class="hljs-keyword">else</span> &#123;	<span class="hljs-comment">/* other rule */</span><br>			<span class="hljs-keyword">return</span> property &amp; RULE_MASK; <span class="hljs-comment">/* BLACK_RULE 0　WHITE_RULE 1 */</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">/* mismatch return allow */</span><br>	<span class="hljs-keyword">return</span> UOS_ALLOW;<br>&#125;<br>EXPORT_SYMBOL(uos_usb_rule_match);<br><br><span class="hljs-comment">/* return val: mismatch rule rwx_full = 7 , others rwx */</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> <span class="hljs-title function_">uos_usb_rule_storage_match</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *bus_name, <span class="hljs-type">char</span> *dev_path, <span class="hljs-type">char</span> *raw_dev_path)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_rule_pci_bus_name</span> <span class="hljs-title">pci_bus_name</span>;</span><br>	<span class="hljs-type">bool</span> ret;<br>	<span class="hljs-type">int</span> i, priority = <span class="hljs-number">-1</span>;<br>	<span class="hljs-type">int</span> property = <span class="hljs-number">-1</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dmi_usb_rule_v1</span> *<span class="hljs-title">usb_rule_entry</span>;</span><br>	<span class="hljs-type">char</span> rwx_full = <span class="hljs-number">7</span>;<br><br>	<span class="hljs-comment">/* para check */</span><br>	<span class="hljs-keyword">if</span> (!bus_name || !dev_path || !usb_rule_counter) &#123;<br>		<span class="hljs-keyword">return</span> rwx_full;<br>	&#125;<br><br>	<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i &lt; usb_rule_counter; i++) &#123;<br>		usb_rule_entry = dmi_usb_rule_table_v1[i];<br>		<span class="hljs-keyword">if</span>(priority &gt;= usb_rule_entry-&gt;priority)  <span class="hljs-comment">/* ignore low priority rule */</span><br>			<span class="hljs-keyword">continue</span>;<br><br>		<span class="hljs-keyword">if</span> (usb_rule_entry-&gt;device_class != UOS_USB_CLASS_MASS)<br>			<span class="hljs-keyword">continue</span>;<br><br>		ret = uos_usb_controller_match(bus_name, usb_rule_entry);<br>		<span class="hljs-keyword">if</span>(!ret)<br>			<span class="hljs-keyword">continue</span>;<br><br>		<span class="hljs-keyword">if</span>(usb_rule_entry-&gt;version &lt; USB_RULE_VERSION_V3)<br>			ret = uos_usb_rule_port_path_match(usb_rule_entry, dev_path);<br>		<span class="hljs-keyword">else</span><br>			ret = uos_usb_rule_port_path_match(usb_rule_entry, raw_dev_path);<br>		<span class="hljs-keyword">if</span>(!ret)<br>			<span class="hljs-keyword">continue</span>;<br><br>		<span class="hljs-comment">/* match entry */</span><br>		priority = usb_rule_entry-&gt;priority;<br>		property = usb_rule_entry-&gt;support_property;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span>(priority &gt;= <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-keyword">return</span> uos_storage_right(property);<br>	&#125;<br><br>	<span class="hljs-comment">/* mismatch rule */</span><br>	<span class="hljs-keyword">return</span> rwx_full;<br>&#125;<br>EXPORT_SYMBOL(uos_usb_rule_storage_match);<br><br><span class="hljs-keyword">extern</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device_type</span> <span class="hljs-title">usb_if_device_type</span>;</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Get xHCI hw port number</span><br><span class="hljs-comment"> * xHCI is a dual-bus architecture with two root hubs.</span><br><span class="hljs-comment"> * Although the port numbers on these two root hubs are counted together physically,</span><br><span class="hljs-comment"> * the xHCI driver counts them separately in software.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">char</span> * <span class="hljs-title function_">get_raw_devpath</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_device *udev)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_hcd</span> *<span class="hljs-title">hcd</span> =</span> bus_to_hcd(udev-&gt;bus);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">top_dev</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">xhci_hcd</span> *<span class="hljs-title">xhci</span>;</span><br>	<span class="hljs-type">int</span> hw_port;<br>	<span class="hljs-type">static</span> <span class="hljs-type">char</span> hw_devpath[<span class="hljs-number">16</span>];<br>	<span class="hljs-type">int</span> cnt = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(hcd-&gt;driver-&gt;description, <span class="hljs-string">&quot;xhci-hcd&quot;</span>))<br>		<span class="hljs-keyword">return</span> udev-&gt;devpath;<br>	xhci = hcd_to_xhci(hcd);<br>	<span class="hljs-keyword">if</span> (udev-&gt;speed &gt;= USB_SPEED_SUPER)<br>               hcd = xhci-&gt;shared_hcd;<br>	<span class="hljs-keyword">else</span><br>		hcd = xhci-&gt;main_hcd;<br>	<span class="hljs-keyword">for</span> (top_dev = udev; top_dev-&gt;parent &amp;&amp; top_dev-&gt;parent-&gt;parent;<br>			top_dev = top_dev-&gt;parent);<br>	<span class="hljs-keyword">if</span> (top_dev-&gt;portnum == <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> udev-&gt;devpath;<br>	hw_port = hcd-&gt;driver-&gt;find_raw_port_number(hcd, top_dev-&gt;portnum);<br><br>	<span class="hljs-built_in">snprintf</span>(hw_devpath, <span class="hljs-keyword">sizeof</span>(hw_devpath), <span class="hljs-string">&quot;%X&quot;</span>, hw_port);<br><br>	<span class="hljs-keyword">for</span>(cnt = <span class="hljs-number">0</span>; cnt &lt; <span class="hljs-built_in">strlen</span>(udev-&gt;devpath); cnt++) &#123;<br>		<span class="hljs-keyword">if</span> (udev-&gt;devpath[cnt] == <span class="hljs-string">&#x27;.&#x27;</span>) &#123;<br>			<span class="hljs-built_in">strcpy</span>(&amp;(hw_devpath[<span class="hljs-built_in">strlen</span>(hw_devpath)]), &amp;(udev-&gt;devpath[cnt]));<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125;<br><br>	dev_dbg(&amp;udev-&gt;dev, <span class="hljs-string">&quot;Device raw devpath: %s&quot;</span>, hw_devpath);<br>	<span class="hljs-keyword">return</span> hw_devpath;<br>&#125;<br>EXPORT_SYMBOL(get_raw_devpath);<br><br><span class="hljs-keyword">struct</span> usb_device *<span class="hljs-title function_">get_uas_udev</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> Scsi_Host *host)</span><br>&#123;<br>       <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uas_dev_info</span> *<span class="hljs-title">devinfo</span>;</span><br><br>       devinfo = (<span class="hljs-keyword">struct</span> uas_dev_info *)host-&gt;hostdata;<br>       <span class="hljs-keyword">return</span> devinfo-&gt;udev;<br>&#125;<br><br><span class="hljs-comment">/* set scsi disk read only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_sd_ro</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> scsi_disk *sdkp)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">us_data</span> *<span class="hljs-title">us</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">udev</span>;</span><br>	<span class="hljs-type">int</span> rwx_flag;<br><br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(sdkp-&gt;device-&gt;host-&gt;hostt-&gt;name, <span class="hljs-string">&quot;usb-storage&quot;</span>)) &#123;<br>		us = host_to_us(sdkp-&gt;device-&gt;host);<br>		rwx_flag = uos_usb_rule_storage_match(us-&gt;pusb_dev-&gt;bus-&gt;bus_name, us-&gt;pusb_dev-&gt;devpath, get_raw_devpath(us-&gt;pusb_dev));<br>		<span class="hljs-keyword">if</span> (!(rwx_flag &amp; <span class="hljs-number">0x2</span>)) &#123;<br>			sdkp-&gt;write_prot = <span class="hljs-number">1</span>;<br>			sd_printk(KERN_NOTICE, sdkp, <span class="hljs-string">&quot;usb rule match,set sd Write Protect&quot;</span>);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(sdkp-&gt;device-&gt;host-&gt;hostt-&gt;name, <span class="hljs-string">&quot;uas&quot;</span>))<br>	&#123;<br>		udev = get_uas_udev(sdkp-&gt;device-&gt;host);<br>		rwx_flag = uos_usb_rule_storage_match(udev-&gt;bus-&gt;bus_name, udev-&gt;devpath, get_raw_devpath(udev));<br>		<span class="hljs-keyword">if</span> (!(rwx_flag &amp; <span class="hljs-number">0x2</span>)) &#123;<br>			sdkp-&gt;write_prot = <span class="hljs-number">1</span>;<br>			sd_printk(KERN_NOTICE, sdkp, <span class="hljs-string">&quot;usb rule match,set sd Write Protect&quot;</span>);<br>		&#125;<br>	&#125;<br>&#125;<br>EXPORT_SYMBOL(set_sd_ro);<br><br><br><span class="hljs-comment">/* set scsi cdrom read only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_sr_ro</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> scsi_cd *cd)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">us_data</span> *<span class="hljs-title">us</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">udev</span>;</span><br>	<span class="hljs-type">int</span> rwx_flag;<br><br>	<span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(cd-&gt;device-&gt;host-&gt;hostt-&gt;name, <span class="hljs-string">&quot;usb-storage&quot;</span>))<br>	&#123;<br>		us = host_to_us(cd-&gt;device-&gt;host);<br>		rwx_flag = uos_usb_rule_storage_match(us-&gt;pusb_dev-&gt;bus-&gt;bus_name, us-&gt;pusb_dev-&gt;devpath, get_raw_devpath(us-&gt;pusb_dev));<br>		<span class="hljs-keyword">if</span> (!(rwx_flag &amp; <span class="hljs-number">0x2</span>)) &#123;<br>			cd-&gt;writeable = <span class="hljs-number">0</span>;<br>			set_disk_ro(cd-&gt;disk, <span class="hljs-number">1</span>);<br>			sr_printk(KERN_INFO, cd, <span class="hljs-string">&quot;usb rule match,set sr Write Protect&quot;</span>);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(cd-&gt;device-&gt;host-&gt;hostt-&gt;name, <span class="hljs-string">&quot;uas&quot;</span>))<br>	&#123;<br>		udev = get_uas_udev(cd-&gt;device-&gt;host);<br>		rwx_flag = uos_usb_rule_storage_match(udev-&gt;bus-&gt;bus_name, udev-&gt;devpath, get_raw_devpath(udev));<br>		<span class="hljs-keyword">if</span> (!(rwx_flag &amp; <span class="hljs-number">0x2</span>)) &#123;<br>			cd-&gt;writeable = <span class="hljs-number">0</span>;<br>			set_disk_ro(cd-&gt;disk, <span class="hljs-number">1</span>);<br>			sr_printk(KERN_INFO, cd, <span class="hljs-string">&quot;usb rule match,set sr Write Protect&quot;</span>);<br>		&#125;<br>	&#125;<br>&#125;<br>EXPORT_SYMBOL(set_sr_ro);<br><br><br><span class="hljs-comment">/* forbid use scsi write command when cd is read only */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">check_sr_read_access</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> scsi_cd *cd, <span class="hljs-type">fmode_t</span> *mode, <span class="hljs-type">unsigned</span> cmd, <span class="hljs-type">void</span> __user *argp)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sg_io_hdr</span> <span class="hljs-title">hdr</span>;</span><br>	u8 opcode;<br><br>	<span class="hljs-keyword">if</span> (!cd-&gt;writeable &amp;&amp; cmd == SG_IO) &#123;<br>		<span class="hljs-keyword">if</span> (!copy_from_user(&amp;hdr, argp, <span class="hljs-keyword">sizeof</span>(hdr)) &amp;&amp; !copy_from_user(&amp;opcode, hdr.cmdp, <span class="hljs-keyword">sizeof</span>(opcode))) &#123;<br>			<span class="hljs-keyword">if</span> (opcode == WRITE_10 || opcode == WRITE_BLANK || opcode == FORMAT_UNIT || \<br>				opcode == WRITE_LONG || opcode == WRITE_12 || opcode == WRITE_LONG_2 || \<br>				opcode == WRITE_16 || opcode == WRITE_ATTRIBUTE) &#123;<br>				*mode &amp;= ~FMODE_WRITE;<br>				<span class="hljs-keyword">return</span>;<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br>EXPORT_SYMBOL(check_sr_read_access);<br><br><span class="hljs-comment">/* notice usb mtp or ptp device read only*/</span><br><span class="hljs-type">bool</span> <span class="hljs-title function_">notice_mtp_ro</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_device *dev, <span class="hljs-keyword">struct</span> usb_host_interface *alt)</span><br>&#123;<br>	<span class="hljs-type">char</span> *alt_string;<br>	<span class="hljs-type">bool</span> ret = <span class="hljs-literal">false</span>;<br><br>	alt_string = usb_cache_string(dev, alt-&gt;desc.iInterface);<br>	<span class="hljs-keyword">if</span> (alt_string &amp;&amp; (<span class="hljs-built_in">strstr</span>(alt_string, <span class="hljs-string">&quot;MTP&quot;</span>) || <span class="hljs-built_in">strstr</span>(alt_string, <span class="hljs-string">&quot;PTP&quot;</span>))) &#123;<br>		<span class="hljs-keyword">if</span> (!(uos_usb_rule_storage_match(dev-&gt;bus-&gt;bus_name, dev-&gt;devpath, get_raw_devpath(dev)) &amp; <span class="hljs-number">0x2</span>)) &#123;<br>			dev_info(&amp;dev-&gt;dev, <span class="hljs-string">&quot;usb rule match,set MTP and PTP interface read-only&quot;</span>);<br>			ret = <span class="hljs-literal">true</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br>EXPORT_SYMBOL(notice_mtp_ro);<br><br><span class="hljs-comment">/* forbid mtp and ptp device write command */</span><br><span class="hljs-type">bool</span> <span class="hljs-title function_">check_mtp_read_access</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_device *dev, <span class="hljs-type">int</span> ifnum, <span class="hljs-type">void</span> __user *buffer)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">intf</span>;</span><br>	<span class="hljs-type">int</span> rwx_flag;<br>	<span class="hljs-type">bool</span> ret = <span class="hljs-literal">true</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mtp_struct</span> <span class="hljs-title">mtp</span>;</span><br><br>	intf = usb_ifnum_to_if(dev, ifnum);<br>	<span class="hljs-keyword">if</span> (intf-&gt;cur_altsetting-&gt;<span class="hljs-built_in">string</span> &amp;&amp; (<span class="hljs-built_in">strstr</span>(intf-&gt;cur_altsetting-&gt;<span class="hljs-built_in">string</span>, <span class="hljs-string">&quot;MTP&quot;</span>) ||<br>				<span class="hljs-built_in">strstr</span>(intf-&gt;cur_altsetting-&gt;<span class="hljs-built_in">string</span>, <span class="hljs-string">&quot;PTP&quot;</span>))) &#123;<br>		rwx_flag = uos_usb_rule_storage_match(dev-&gt;bus-&gt;bus_name, dev-&gt;devpath, get_raw_devpath(dev));<br>		<span class="hljs-keyword">if</span> (!(rwx_flag &amp; <span class="hljs-number">0x2</span>) &amp;&amp; !copy_from_user(&amp;mtp, buffer, <span class="hljs-keyword">sizeof</span>(mtp))) &#123;<br>			<span class="hljs-keyword">if</span> (mtp.operation_code == <span class="hljs-number">0x100c</span> || mtp.operation_code == <span class="hljs-number">0x100d</span>)<br>				ret = <span class="hljs-literal">false</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br>EXPORT_SYMBOL(check_mtp_read_access);<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">struct</span> scsi_cd *<span class="hljs-title function_">get_scsi_cd</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> gendisk *disk)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> container_of(disk-&gt;private_data, <span class="hljs-keyword">struct</span> scsi_cd, driver);<br>&#125;<br><br><span class="hljs-comment">/* forbid change disk ro using ioctl */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">get_usb_disk_ro</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> block_device *bdev)</span><br>&#123;<br>	<span class="hljs-type">int</span> rwx_flag = <span class="hljs-number">0x7</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scsi_disk</span> *<span class="hljs-title">sdkp</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scsi_cd</span> *<span class="hljs-title">cd</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scsi_device</span> *<span class="hljs-title">sdev</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">gendisk</span> *<span class="hljs-title">disk</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">us_data</span> *<span class="hljs-title">us</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">udev</span>;</span><br>	<span class="hljs-type">int</span> partno;<br><br>	<span class="hljs-keyword">if</span> (!IS_ERR(bdev))&#123;<br>		partno = (<span class="hljs-type">int</span>)bdev-&gt;bd_partno;<br>		disk = get_gendisk(bdev-&gt;bd_dev, &amp;partno);<br>		<span class="hljs-keyword">if</span> (disk) &#123;<br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(disk-&gt;disk_name, <span class="hljs-string">&quot;sd&quot;</span>))&#123;<br>				sdkp = scsi_disk(disk);<br>				sdev = sdkp-&gt;device;<br>			&#125;<br>			<span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(disk-&gt;disk_name, <span class="hljs-string">&quot;sr&quot;</span>))&#123;<br>				cd = get_scsi_cd(disk);<br>				sdev = cd-&gt;device;<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (sdev &amp;&amp; !<span class="hljs-built_in">strcmp</span>(sdev-&gt;host-&gt;hostt-&gt;name, <span class="hljs-string">&quot;usb-storage&quot;</span>)) &#123;<br>		us = host_to_us(sdev-&gt;host);<br>		rwx_flag = uos_usb_rule_storage_match(us-&gt;pusb_dev-&gt;bus-&gt;bus_name, us-&gt;pusb_dev-&gt;devpath, get_raw_devpath(us-&gt;pusb_dev));<br>	&#125;<br>	<span class="hljs-keyword">if</span> (sdev &amp;&amp; !<span class="hljs-built_in">strcmp</span>(sdev-&gt;host-&gt;hostt-&gt;name, <span class="hljs-string">&quot;uas&quot;</span>)) &#123;<br>		udev = get_uas_udev(sdev-&gt;host);<br>		rwx_flag = uos_usb_rule_storage_match(udev-&gt;bus-&gt;bus_name, udev-&gt;devpath, get_raw_devpath(udev));<br>	&#125;<br>	<span class="hljs-keyword">return</span> rwx_flag;<br>&#125;<br>EXPORT_SYMBOL(get_usb_disk_ro);<br><br><br><br><span class="hljs-comment">/* only for test */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">uos_create_test_rule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dmi_usb_rule_v1</span> *<span class="hljs-title">usb_rule_entry</span>;</span><br><br>	usb_rule_counter = <span class="hljs-number">5</span>;<br><br><span class="hljs-comment">/* rule 1, disable 0000:02:00.0 usb 01 all functions priority=0 low*/</span><br>	usb_rule_entry = (<span class="hljs-keyword">struct</span> dmi_usb_rule_v1 *) kmalloc (<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> dmi_usb_rule_v1), GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (usb_rule_entry == <span class="hljs-literal">NULL</span>) &#123;<br>		printk(KERN_ERR <span class="hljs-string">&quot;uos_create_rule alloc memory fail. \n\r&quot;</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	usb_rule_entry-&gt;type = DMI_USB_RULE_TYPE;<br>	usb_rule_entry-&gt;length =<span class="hljs-number">0x30</span>;<br>	usb_rule_entry-&gt;handle =<span class="hljs-number">0</span>;<br>	usb_rule_entry-&gt;signature =<span class="hljs-number">0x52534455</span>;<br>	usb_rule_entry-&gt;version =<span class="hljs-number">1</span>;<br>	usb_rule_entry-&gt;priority =<span class="hljs-number">0</span>; <span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_segment = <span class="hljs-number">0x0000</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_bus=<span class="hljs-number">0x02</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_device=<span class="hljs-number">0x00</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_function=<span class="hljs-number">0x0</span>;<span class="hljs-comment">/****/</span><br>	<span class="hljs-comment">//usb_rule_entry-&gt;port_path_str[16];/****/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;0&#x27;</span>;<span class="hljs-comment">/** left 01**/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;1&#x27;</span>;<span class="hljs-comment">/** left 01**/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">/** left 01**/</span><br>	usb_rule_entry-&gt;usb_vendor=<span class="hljs-number">0xffff</span>;<br>	usb_rule_entry-&gt;usb_product=<span class="hljs-number">0xffff</span>;<br>	usb_rule_entry-&gt;device_class=<span class="hljs-number">0xffff</span>;<br>	usb_rule_entry-&gt;device_subclass=<span class="hljs-number">0xff</span>;<br>	usb_rule_entry-&gt;device_protocol=<span class="hljs-number">0xff</span>;<br>	usb_rule_entry-&gt;support_property=<span class="hljs-number">0x0</span>;  <span class="hljs-comment">/* BLACK_RULE 0　WHITE_RULE 1 */</span><br>	dmi_usb_rule_table_v1[<span class="hljs-number">0</span>] = usb_rule_entry;<br><br><span class="hljs-comment">/* rule 2, allow 0000:02:00.0 usb 01 hid functions priority=1 high */</span><br>	usb_rule_entry = (<span class="hljs-keyword">struct</span> dmi_usb_rule_v1 *) kmalloc (<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> dmi_usb_rule_v1), GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (usb_rule_entry == <span class="hljs-literal">NULL</span>) &#123;<br>		printk(KERN_ERR <span class="hljs-string">&quot;uos_create_rule alloc memory fail. \n\r&quot;</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	usb_rule_entry-&gt;type = DMI_USB_RULE_TYPE;<br>	usb_rule_entry-&gt;length =<span class="hljs-number">0x30</span>;<br>	usb_rule_entry-&gt;handle =<span class="hljs-number">0</span>;<br>	usb_rule_entry-&gt;signature =<span class="hljs-number">0x52534455</span>;<br>	usb_rule_entry-&gt;version =<span class="hljs-number">1</span>;<br>	usb_rule_entry-&gt;priority =<span class="hljs-number">1</span>; <span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_segment = <span class="hljs-number">0x0000</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_bus=<span class="hljs-number">0x02</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_device=<span class="hljs-number">0x00</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_function=<span class="hljs-number">0x0</span>;<span class="hljs-comment">/****/</span><br>	<span class="hljs-comment">//usb_rule_entry-&gt;port_path_str[16];/****/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;0&#x27;</span>;<span class="hljs-comment">/** left 01**/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;1&#x27;</span>;<span class="hljs-comment">/** left 01**/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">/** left 01**/</span><br>	usb_rule_entry-&gt;usb_vendor=<span class="hljs-number">0xffff</span>;<br>	usb_rule_entry-&gt;usb_product=<span class="hljs-number">0xffff</span>;<br>	usb_rule_entry-&gt;device_class=<span class="hljs-number">0x3</span>;<br>	usb_rule_entry-&gt;device_subclass=<span class="hljs-number">0xff</span>;<br>	usb_rule_entry-&gt;device_protocol=<span class="hljs-number">0xff</span>;<br>	usb_rule_entry-&gt;support_property=<span class="hljs-number">0x1</span>;<br>	dmi_usb_rule_table_v1[<span class="hljs-number">1</span>] = usb_rule_entry;<br><br><br><span class="hljs-comment">/* rule 3, allow 0000:04:00.0 usb 04 all functions priority=0 low */</span><br>	usb_rule_entry = (<span class="hljs-keyword">struct</span> dmi_usb_rule_v1 *) kmalloc (<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> dmi_usb_rule_v1), GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (usb_rule_entry == <span class="hljs-literal">NULL</span>) &#123;<br>		printk(KERN_ERR <span class="hljs-string">&quot;uos_create_rule alloc memory fail. \n\r&quot;</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	usb_rule_entry-&gt;type = DMI_USB_RULE_TYPE;<br>	usb_rule_entry-&gt;length =<span class="hljs-number">0x30</span>;<br>	usb_rule_entry-&gt;handle =<span class="hljs-number">1</span>;<br>	usb_rule_entry-&gt;signature =<span class="hljs-number">0x52534455</span>;<br>	usb_rule_entry-&gt;version =<span class="hljs-number">1</span>;<br>	usb_rule_entry-&gt;priority =<span class="hljs-number">0</span>; <span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_segment = <span class="hljs-number">0x0000</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_bus=<span class="hljs-number">0x04</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_device=<span class="hljs-number">0x0</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_function=<span class="hljs-number">0x0</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;0&#x27;</span>;<span class="hljs-comment">/** right 04 **/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;4&#x27;</span>;<span class="hljs-comment">/** right 04 **/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">/** right 04 **/</span><br>	usb_rule_entry-&gt;usb_vendor=<span class="hljs-number">0xffff</span>;<br>	usb_rule_entry-&gt;usb_product=<span class="hljs-number">0xffff</span>;<br>	usb_rule_entry-&gt;device_class=<span class="hljs-number">0xffff</span>;<br>	usb_rule_entry-&gt;device_subclass=<span class="hljs-number">0xff</span>;<br>	usb_rule_entry-&gt;device_protocol=<span class="hljs-number">0xff</span>;<br>	usb_rule_entry-&gt;support_property=<span class="hljs-number">0x1</span>;<br>	dmi_usb_rule_table_v1[<span class="hljs-number">2</span>] = usb_rule_entry;<br><br><br><span class="hljs-comment">/* rule 4, disable 0000:04:00.0 usb 04 storage write&amp;exec priority=1 high */</span><br>	usb_rule_entry = (<span class="hljs-keyword">struct</span> dmi_usb_rule_v1 *) kmalloc (<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> dmi_usb_rule_v1), GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (usb_rule_entry == <span class="hljs-literal">NULL</span>) &#123;<br>		printk(KERN_ERR <span class="hljs-string">&quot;uos_create_rule alloc memory fail. \n\r&quot;</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br>	usb_rule_entry-&gt;type = DMI_USB_RULE_TYPE;<br>	usb_rule_entry-&gt;length =<span class="hljs-number">0x30</span>;<br>	usb_rule_entry-&gt;handle =<span class="hljs-number">1</span>;<br>	usb_rule_entry-&gt;signature =<span class="hljs-number">0x52534455</span>;<br>	usb_rule_entry-&gt;version =<span class="hljs-number">1</span>;<br>	usb_rule_entry-&gt;priority =<span class="hljs-number">1</span>; <span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_segment = <span class="hljs-number">0x0000</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_bus=<span class="hljs-number">0x04</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_device=<span class="hljs-number">0x0</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;usb_controller_name.pci_controller.controller_function=<span class="hljs-number">0x0</span>;<span class="hljs-comment">/****/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;0&#x27;</span>;<span class="hljs-comment">/** right 04 **/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;4&#x27;</span>;<span class="hljs-comment">/** right 04 **/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">2</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">/** right 04 **/</span><br>	usb_rule_entry-&gt;usb_vendor=<span class="hljs-number">0xffff</span>;<br>	usb_rule_entry-&gt;usb_product=<span class="hljs-number">0xffff</span>;<br>	usb_rule_entry-&gt;device_class=<span class="hljs-number">0x8</span>;<br>	usb_rule_entry-&gt;device_subclass=<span class="hljs-number">0xff</span>;<br>	usb_rule_entry-&gt;device_protocol=<span class="hljs-number">0xff</span>;<br>	usb_rule_entry-&gt;support_property=<span class="hljs-number">0xc</span>;<br>	dmi_usb_rule_table_v1[<span class="hljs-number">3</span>] = usb_rule_entry;<br><br><span class="hljs-comment">/* rule 5, disable 1860000.xhci usb 01 priority=1 high */</span><br>        usb_rule_entry = (<span class="hljs-keyword">struct</span> dmi_usb_rule_v1 *) kmalloc (<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> dmi_usb_rule_v1), GFP_KERNEL);<br>        <span class="hljs-keyword">if</span> (usb_rule_entry == <span class="hljs-literal">NULL</span>) &#123;<br>                printk(KERN_ERR <span class="hljs-string">&quot;uos_create_rule alloc memory fail. \n\r&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>        &#125;<br>        usb_rule_entry-&gt;type = DMI_USB_RULE_TYPE;<br>        usb_rule_entry-&gt;length =<span class="hljs-number">0x30</span>;<br>        usb_rule_entry-&gt;handle =<span class="hljs-number">1</span>;<br>        usb_rule_entry-&gt;signature =<span class="hljs-number">0x52534455</span>;<br>        usb_rule_entry-&gt;version =<span class="hljs-number">2</span>;<br>        usb_rule_entry-&gt;priority =<span class="hljs-number">1</span>; <span class="hljs-comment">/****/</span><br>        usb_rule_entry-&gt;usb_controller_name.mmio_controller = <span class="hljs-number">0x0000000001870000</span>;<span class="hljs-comment">/****/</span><br>        usb_rule_entry-&gt;port_path_str[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;1&#x27;</span>;<span class="hljs-comment">/** right 1.4 **/</span><br>        usb_rule_entry-&gt;port_path_str[<span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;.&#x27;</span>; <span class="hljs-comment">/** right 1.4 **/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">2</span>] = <span class="hljs-string">&#x27;4&#x27;</span>; <span class="hljs-comment">/** right 1.4 **/</span><br>	usb_rule_entry-&gt;port_path_str[<span class="hljs-number">3</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">/** right 1.4 **/</span><br>        usb_rule_entry-&gt;usb_vendor=<span class="hljs-number">0xffff</span>;<br>        usb_rule_entry-&gt;usb_product=<span class="hljs-number">0xffff</span>;<br>        usb_rule_entry-&gt;device_class=<span class="hljs-number">0xffff</span>;<br>        usb_rule_entry-&gt;device_subclass=<span class="hljs-number">0xff</span>;<br>        usb_rule_entry-&gt;device_protocol=<span class="hljs-number">0xff</span>;<br>        usb_rule_entry-&gt;support_property=<span class="hljs-number">0x1c</span>;<br>        dmi_usb_rule_table_v1[<span class="hljs-number">4</span>] = usb_rule_entry;<br><br>	<span class="hljs-keyword">return</span>;<br>&#125;<br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">usb_rule_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	printk(KERN_INFO <span class="hljs-string">&quot;%s start ... \r\n&quot;</span>, __func__);<br><br>	usb_rule_data_init();<br><br>	<span class="hljs-keyword">if</span>(!usb_rule_init_flag) &#123;<br>		dmi_walk(get_usb_rule_by_dmi, <span class="hljs-literal">NULL</span>);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span>(!usb_rule_counter) &#123;<br>		printk(KERN_INFO <span class="hljs-string">&quot;%s cannot find rules by dmi \r\n&quot;</span>, __func__);<br>	&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0 <span class="hljs-comment">/* only for test */</span></span><br>	uos_create_test_rule();<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	usb_rule_init_flag = <span class="hljs-literal">true</span>;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>device_initcall(usb_rule_init);<br><br></code></pre></td></tr></table></figure>

<h4 id="drivers-usb-core-devio-c-华为"><a href="#drivers-usb-core-devio-c-华为" class="headerlink" title="drivers&#x2F;usb&#x2F;core&#x2F;devio.c(华为)"></a>drivers&#x2F;usb&#x2F;core&#x2F;devio.c(华为)</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br><span class="line">1525</span><br><span class="line">1526</span><br><span class="line">1527</span><br><span class="line">1528</span><br><span class="line">1529</span><br><span class="line">1530</span><br><span class="line">1531</span><br><span class="line">1532</span><br><span class="line">1533</span><br><span class="line">1534</span><br><span class="line">1535</span><br><span class="line">1536</span><br><span class="line">1537</span><br><span class="line">1538</span><br><span class="line">1539</span><br><span class="line">1540</span><br><span class="line">1541</span><br><span class="line">1542</span><br><span class="line">1543</span><br><span class="line">1544</span><br><span class="line">1545</span><br><span class="line">1546</span><br><span class="line">1547</span><br><span class="line">1548</span><br><span class="line">1549</span><br><span class="line">1550</span><br><span class="line">1551</span><br><span class="line">1552</span><br><span class="line">1553</span><br><span class="line">1554</span><br><span class="line">1555</span><br><span class="line">1556</span><br><span class="line">1557</span><br><span class="line">1558</span><br><span class="line">1559</span><br><span class="line">1560</span><br><span class="line">1561</span><br><span class="line">1562</span><br><span class="line">1563</span><br><span class="line">1564</span><br><span class="line">1565</span><br><span class="line">1566</span><br><span class="line">1567</span><br><span class="line">1568</span><br><span class="line">1569</span><br><span class="line">1570</span><br><span class="line">1571</span><br><span class="line">1572</span><br><span class="line">1573</span><br><span class="line">1574</span><br><span class="line">1575</span><br><span class="line">1576</span><br><span class="line">1577</span><br><span class="line">1578</span><br><span class="line">1579</span><br><span class="line">1580</span><br><span class="line">1581</span><br><span class="line">1582</span><br><span class="line">1583</span><br><span class="line">1584</span><br><span class="line">1585</span><br><span class="line">1586</span><br><span class="line">1587</span><br><span class="line">1588</span><br><span class="line">1589</span><br><span class="line">1590</span><br><span class="line">1591</span><br><span class="line">1592</span><br><span class="line">1593</span><br><span class="line">1594</span><br><span class="line">1595</span><br><span class="line">1596</span><br><span class="line">1597</span><br><span class="line">1598</span><br><span class="line">1599</span><br><span class="line">1600</span><br><span class="line">1601</span><br><span class="line">1602</span><br><span class="line">1603</span><br><span class="line">1604</span><br><span class="line">1605</span><br><span class="line">1606</span><br><span class="line">1607</span><br><span class="line">1608</span><br><span class="line">1609</span><br><span class="line">1610</span><br><span class="line">1611</span><br><span class="line">1612</span><br><span class="line">1613</span><br><span class="line">1614</span><br><span class="line">1615</span><br><span class="line">1616</span><br><span class="line">1617</span><br><span class="line">1618</span><br><span class="line">1619</span><br><span class="line">1620</span><br><span class="line">1621</span><br><span class="line">1622</span><br><span class="line">1623</span><br><span class="line">1624</span><br><span class="line">1625</span><br><span class="line">1626</span><br><span class="line">1627</span><br><span class="line">1628</span><br><span class="line">1629</span><br><span class="line">1630</span><br><span class="line">1631</span><br><span class="line">1632</span><br><span class="line">1633</span><br><span class="line">1634</span><br><span class="line">1635</span><br><span class="line">1636</span><br><span class="line">1637</span><br><span class="line">1638</span><br><span class="line">1639</span><br><span class="line">1640</span><br><span class="line">1641</span><br><span class="line">1642</span><br><span class="line">1643</span><br><span class="line">1644</span><br><span class="line">1645</span><br><span class="line">1646</span><br><span class="line">1647</span><br><span class="line">1648</span><br><span class="line">1649</span><br><span class="line">1650</span><br><span class="line">1651</span><br><span class="line">1652</span><br><span class="line">1653</span><br><span class="line">1654</span><br><span class="line">1655</span><br><span class="line">1656</span><br><span class="line">1657</span><br><span class="line">1658</span><br><span class="line">1659</span><br><span class="line">1660</span><br><span class="line">1661</span><br><span class="line">1662</span><br><span class="line">1663</span><br><span class="line">1664</span><br><span class="line">1665</span><br><span class="line">1666</span><br><span class="line">1667</span><br><span class="line">1668</span><br><span class="line">1669</span><br><span class="line">1670</span><br><span class="line">1671</span><br><span class="line">1672</span><br><span class="line">1673</span><br><span class="line">1674</span><br><span class="line">1675</span><br><span class="line">1676</span><br><span class="line">1677</span><br><span class="line">1678</span><br><span class="line">1679</span><br><span class="line">1680</span><br><span class="line">1681</span><br><span class="line">1682</span><br><span class="line">1683</span><br><span class="line">1684</span><br><span class="line">1685</span><br><span class="line">1686</span><br><span class="line">1687</span><br><span class="line">1688</span><br><span class="line">1689</span><br><span class="line">1690</span><br><span class="line">1691</span><br><span class="line">1692</span><br><span class="line">1693</span><br><span class="line">1694</span><br><span class="line">1695</span><br><span class="line">1696</span><br><span class="line">1697</span><br><span class="line">1698</span><br><span class="line">1699</span><br><span class="line">1700</span><br><span class="line">1701</span><br><span class="line">1702</span><br><span class="line">1703</span><br><span class="line">1704</span><br><span class="line">1705</span><br><span class="line">1706</span><br><span class="line">1707</span><br><span class="line">1708</span><br><span class="line">1709</span><br><span class="line">1710</span><br><span class="line">1711</span><br><span class="line">1712</span><br><span class="line">1713</span><br><span class="line">1714</span><br><span class="line">1715</span><br><span class="line">1716</span><br><span class="line">1717</span><br><span class="line">1718</span><br><span class="line">1719</span><br><span class="line">1720</span><br><span class="line">1721</span><br><span class="line">1722</span><br><span class="line">1723</span><br><span class="line">1724</span><br><span class="line">1725</span><br><span class="line">1726</span><br><span class="line">1727</span><br><span class="line">1728</span><br><span class="line">1729</span><br><span class="line">1730</span><br><span class="line">1731</span><br><span class="line">1732</span><br><span class="line">1733</span><br><span class="line">1734</span><br><span class="line">1735</span><br><span class="line">1736</span><br><span class="line">1737</span><br><span class="line">1738</span><br><span class="line">1739</span><br><span class="line">1740</span><br><span class="line">1741</span><br><span class="line">1742</span><br><span class="line">1743</span><br><span class="line">1744</span><br><span class="line">1745</span><br><span class="line">1746</span><br><span class="line">1747</span><br><span class="line">1748</span><br><span class="line">1749</span><br><span class="line">1750</span><br><span class="line">1751</span><br><span class="line">1752</span><br><span class="line">1753</span><br><span class="line">1754</span><br><span class="line">1755</span><br><span class="line">1756</span><br><span class="line">1757</span><br><span class="line">1758</span><br><span class="line">1759</span><br><span class="line">1760</span><br><span class="line">1761</span><br><span class="line">1762</span><br><span class="line">1763</span><br><span class="line">1764</span><br><span class="line">1765</span><br><span class="line">1766</span><br><span class="line">1767</span><br><span class="line">1768</span><br><span class="line">1769</span><br><span class="line">1770</span><br><span class="line">1771</span><br><span class="line">1772</span><br><span class="line">1773</span><br><span class="line">1774</span><br><span class="line">1775</span><br><span class="line">1776</span><br><span class="line">1777</span><br><span class="line">1778</span><br><span class="line">1779</span><br><span class="line">1780</span><br><span class="line">1781</span><br><span class="line">1782</span><br><span class="line">1783</span><br><span class="line">1784</span><br><span class="line">1785</span><br><span class="line">1786</span><br><span class="line">1787</span><br><span class="line">1788</span><br><span class="line">1789</span><br><span class="line">1790</span><br><span class="line">1791</span><br><span class="line">1792</span><br><span class="line">1793</span><br><span class="line">1794</span><br><span class="line">1795</span><br><span class="line">1796</span><br><span class="line">1797</span><br><span class="line">1798</span><br><span class="line">1799</span><br><span class="line">1800</span><br><span class="line">1801</span><br><span class="line">1802</span><br><span class="line">1803</span><br><span class="line">1804</span><br><span class="line">1805</span><br><span class="line">1806</span><br><span class="line">1807</span><br><span class="line">1808</span><br><span class="line">1809</span><br><span class="line">1810</span><br><span class="line">1811</span><br><span class="line">1812</span><br><span class="line">1813</span><br><span class="line">1814</span><br><span class="line">1815</span><br><span class="line">1816</span><br><span class="line">1817</span><br><span class="line">1818</span><br><span class="line">1819</span><br><span class="line">1820</span><br><span class="line">1821</span><br><span class="line">1822</span><br><span class="line">1823</span><br><span class="line">1824</span><br><span class="line">1825</span><br><span class="line">1826</span><br><span class="line">1827</span><br><span class="line">1828</span><br><span class="line">1829</span><br><span class="line">1830</span><br><span class="line">1831</span><br><span class="line">1832</span><br><span class="line">1833</span><br><span class="line">1834</span><br><span class="line">1835</span><br><span class="line">1836</span><br><span class="line">1837</span><br><span class="line">1838</span><br><span class="line">1839</span><br><span class="line">1840</span><br><span class="line">1841</span><br><span class="line">1842</span><br><span class="line">1843</span><br><span class="line">1844</span><br><span class="line">1845</span><br><span class="line">1846</span><br><span class="line">1847</span><br><span class="line">1848</span><br><span class="line">1849</span><br><span class="line">1850</span><br><span class="line">1851</span><br><span class="line">1852</span><br><span class="line">1853</span><br><span class="line">1854</span><br><span class="line">1855</span><br><span class="line">1856</span><br><span class="line">1857</span><br><span class="line">1858</span><br><span class="line">1859</span><br><span class="line">1860</span><br><span class="line">1861</span><br><span class="line">1862</span><br><span class="line">1863</span><br><span class="line">1864</span><br><span class="line">1865</span><br><span class="line">1866</span><br><span class="line">1867</span><br><span class="line">1868</span><br><span class="line">1869</span><br><span class="line">1870</span><br><span class="line">1871</span><br><span class="line">1872</span><br><span class="line">1873</span><br><span class="line">1874</span><br><span class="line">1875</span><br><span class="line">1876</span><br><span class="line">1877</span><br><span class="line">1878</span><br><span class="line">1879</span><br><span class="line">1880</span><br><span class="line">1881</span><br><span class="line">1882</span><br><span class="line">1883</span><br><span class="line">1884</span><br><span class="line">1885</span><br><span class="line">1886</span><br><span class="line">1887</span><br><span class="line">1888</span><br><span class="line">1889</span><br><span class="line">1890</span><br><span class="line">1891</span><br><span class="line">1892</span><br><span class="line">1893</span><br><span class="line">1894</span><br><span class="line">1895</span><br><span class="line">1896</span><br><span class="line">1897</span><br><span class="line">1898</span><br><span class="line">1899</span><br><span class="line">1900</span><br><span class="line">1901</span><br><span class="line">1902</span><br><span class="line">1903</span><br><span class="line">1904</span><br><span class="line">1905</span><br><span class="line">1906</span><br><span class="line">1907</span><br><span class="line">1908</span><br><span class="line">1909</span><br><span class="line">1910</span><br><span class="line">1911</span><br><span class="line">1912</span><br><span class="line">1913</span><br><span class="line">1914</span><br><span class="line">1915</span><br><span class="line">1916</span><br><span class="line">1917</span><br><span class="line">1918</span><br><span class="line">1919</span><br><span class="line">1920</span><br><span class="line">1921</span><br><span class="line">1922</span><br><span class="line">1923</span><br><span class="line">1924</span><br><span class="line">1925</span><br><span class="line">1926</span><br><span class="line">1927</span><br><span class="line">1928</span><br><span class="line">1929</span><br><span class="line">1930</span><br><span class="line">1931</span><br><span class="line">1932</span><br><span class="line">1933</span><br><span class="line">1934</span><br><span class="line">1935</span><br><span class="line">1936</span><br><span class="line">1937</span><br><span class="line">1938</span><br><span class="line">1939</span><br><span class="line">1940</span><br><span class="line">1941</span><br><span class="line">1942</span><br><span class="line">1943</span><br><span class="line">1944</span><br><span class="line">1945</span><br><span class="line">1946</span><br><span class="line">1947</span><br><span class="line">1948</span><br><span class="line">1949</span><br><span class="line">1950</span><br><span class="line">1951</span><br><span class="line">1952</span><br><span class="line">1953</span><br><span class="line">1954</span><br><span class="line">1955</span><br><span class="line">1956</span><br><span class="line">1957</span><br><span class="line">1958</span><br><span class="line">1959</span><br><span class="line">1960</span><br><span class="line">1961</span><br><span class="line">1962</span><br><span class="line">1963</span><br><span class="line">1964</span><br><span class="line">1965</span><br><span class="line">1966</span><br><span class="line">1967</span><br><span class="line">1968</span><br><span class="line">1969</span><br><span class="line">1970</span><br><span class="line">1971</span><br><span class="line">1972</span><br><span class="line">1973</span><br><span class="line">1974</span><br><span class="line">1975</span><br><span class="line">1976</span><br><span class="line">1977</span><br><span class="line">1978</span><br><span class="line">1979</span><br><span class="line">1980</span><br><span class="line">1981</span><br><span class="line">1982</span><br><span class="line">1983</span><br><span class="line">1984</span><br><span class="line">1985</span><br><span class="line">1986</span><br><span class="line">1987</span><br><span class="line">1988</span><br><span class="line">1989</span><br><span class="line">1990</span><br><span class="line">1991</span><br><span class="line">1992</span><br><span class="line">1993</span><br><span class="line">1994</span><br><span class="line">1995</span><br><span class="line">1996</span><br><span class="line">1997</span><br><span class="line">1998</span><br><span class="line">1999</span><br><span class="line">2000</span><br><span class="line">2001</span><br><span class="line">2002</span><br><span class="line">2003</span><br><span class="line">2004</span><br><span class="line">2005</span><br><span class="line">2006</span><br><span class="line">2007</span><br><span class="line">2008</span><br><span class="line">2009</span><br><span class="line">2010</span><br><span class="line">2011</span><br><span class="line">2012</span><br><span class="line">2013</span><br><span class="line">2014</span><br><span class="line">2015</span><br><span class="line">2016</span><br><span class="line">2017</span><br><span class="line">2018</span><br><span class="line">2019</span><br><span class="line">2020</span><br><span class="line">2021</span><br><span class="line">2022</span><br><span class="line">2023</span><br><span class="line">2024</span><br><span class="line">2025</span><br><span class="line">2026</span><br><span class="line">2027</span><br><span class="line">2028</span><br><span class="line">2029</span><br><span class="line">2030</span><br><span class="line">2031</span><br><span class="line">2032</span><br><span class="line">2033</span><br><span class="line">2034</span><br><span class="line">2035</span><br><span class="line">2036</span><br><span class="line">2037</span><br><span class="line">2038</span><br><span class="line">2039</span><br><span class="line">2040</span><br><span class="line">2041</span><br><span class="line">2042</span><br><span class="line">2043</span><br><span class="line">2044</span><br><span class="line">2045</span><br><span class="line">2046</span><br><span class="line">2047</span><br><span class="line">2048</span><br><span class="line">2049</span><br><span class="line">2050</span><br><span class="line">2051</span><br><span class="line">2052</span><br><span class="line">2053</span><br><span class="line">2054</span><br><span class="line">2055</span><br><span class="line">2056</span><br><span class="line">2057</span><br><span class="line">2058</span><br><span class="line">2059</span><br><span class="line">2060</span><br><span class="line">2061</span><br><span class="line">2062</span><br><span class="line">2063</span><br><span class="line">2064</span><br><span class="line">2065</span><br><span class="line">2066</span><br><span class="line">2067</span><br><span class="line">2068</span><br><span class="line">2069</span><br><span class="line">2070</span><br><span class="line">2071</span><br><span class="line">2072</span><br><span class="line">2073</span><br><span class="line">2074</span><br><span class="line">2075</span><br><span class="line">2076</span><br><span class="line">2077</span><br><span class="line">2078</span><br><span class="line">2079</span><br><span class="line">2080</span><br><span class="line">2081</span><br><span class="line">2082</span><br><span class="line">2083</span><br><span class="line">2084</span><br><span class="line">2085</span><br><span class="line">2086</span><br><span class="line">2087</span><br><span class="line">2088</span><br><span class="line">2089</span><br><span class="line">2090</span><br><span class="line">2091</span><br><span class="line">2092</span><br><span class="line">2093</span><br><span class="line">2094</span><br><span class="line">2095</span><br><span class="line">2096</span><br><span class="line">2097</span><br><span class="line">2098</span><br><span class="line">2099</span><br><span class="line">2100</span><br><span class="line">2101</span><br><span class="line">2102</span><br><span class="line">2103</span><br><span class="line">2104</span><br><span class="line">2105</span><br><span class="line">2106</span><br><span class="line">2107</span><br><span class="line">2108</span><br><span class="line">2109</span><br><span class="line">2110</span><br><span class="line">2111</span><br><span class="line">2112</span><br><span class="line">2113</span><br><span class="line">2114</span><br><span class="line">2115</span><br><span class="line">2116</span><br><span class="line">2117</span><br><span class="line">2118</span><br><span class="line">2119</span><br><span class="line">2120</span><br><span class="line">2121</span><br><span class="line">2122</span><br><span class="line">2123</span><br><span class="line">2124</span><br><span class="line">2125</span><br><span class="line">2126</span><br><span class="line">2127</span><br><span class="line">2128</span><br><span class="line">2129</span><br><span class="line">2130</span><br><span class="line">2131</span><br><span class="line">2132</span><br><span class="line">2133</span><br><span class="line">2134</span><br><span class="line">2135</span><br><span class="line">2136</span><br><span class="line">2137</span><br><span class="line">2138</span><br><span class="line">2139</span><br><span class="line">2140</span><br><span class="line">2141</span><br><span class="line">2142</span><br><span class="line">2143</span><br><span class="line">2144</span><br><span class="line">2145</span><br><span class="line">2146</span><br><span class="line">2147</span><br><span class="line">2148</span><br><span class="line">2149</span><br><span class="line">2150</span><br><span class="line">2151</span><br><span class="line">2152</span><br><span class="line">2153</span><br><span class="line">2154</span><br><span class="line">2155</span><br><span class="line">2156</span><br><span class="line">2157</span><br><span class="line">2158</span><br><span class="line">2159</span><br><span class="line">2160</span><br><span class="line">2161</span><br><span class="line">2162</span><br><span class="line">2163</span><br><span class="line">2164</span><br><span class="line">2165</span><br><span class="line">2166</span><br><span class="line">2167</span><br><span class="line">2168</span><br><span class="line">2169</span><br><span class="line">2170</span><br><span class="line">2171</span><br><span class="line">2172</span><br><span class="line">2173</span><br><span class="line">2174</span><br><span class="line">2175</span><br><span class="line">2176</span><br><span class="line">2177</span><br><span class="line">2178</span><br><span class="line">2179</span><br><span class="line">2180</span><br><span class="line">2181</span><br><span class="line">2182</span><br><span class="line">2183</span><br><span class="line">2184</span><br><span class="line">2185</span><br><span class="line">2186</span><br><span class="line">2187</span><br><span class="line">2188</span><br><span class="line">2189</span><br><span class="line">2190</span><br><span class="line">2191</span><br><span class="line">2192</span><br><span class="line">2193</span><br><span class="line">2194</span><br><span class="line">2195</span><br><span class="line">2196</span><br><span class="line">2197</span><br><span class="line">2198</span><br><span class="line">2199</span><br><span class="line">2200</span><br><span class="line">2201</span><br><span class="line">2202</span><br><span class="line">2203</span><br><span class="line">2204</span><br><span class="line">2205</span><br><span class="line">2206</span><br><span class="line">2207</span><br><span class="line">2208</span><br><span class="line">2209</span><br><span class="line">2210</span><br><span class="line">2211</span><br><span class="line">2212</span><br><span class="line">2213</span><br><span class="line">2214</span><br><span class="line">2215</span><br><span class="line">2216</span><br><span class="line">2217</span><br><span class="line">2218</span><br><span class="line">2219</span><br><span class="line">2220</span><br><span class="line">2221</span><br><span class="line">2222</span><br><span class="line">2223</span><br><span class="line">2224</span><br><span class="line">2225</span><br><span class="line">2226</span><br><span class="line">2227</span><br><span class="line">2228</span><br><span class="line">2229</span><br><span class="line">2230</span><br><span class="line">2231</span><br><span class="line">2232</span><br><span class="line">2233</span><br><span class="line">2234</span><br><span class="line">2235</span><br><span class="line">2236</span><br><span class="line">2237</span><br><span class="line">2238</span><br><span class="line">2239</span><br><span class="line">2240</span><br><span class="line">2241</span><br><span class="line">2242</span><br><span class="line">2243</span><br><span class="line">2244</span><br><span class="line">2245</span><br><span class="line">2246</span><br><span class="line">2247</span><br><span class="line">2248</span><br><span class="line">2249</span><br><span class="line">2250</span><br><span class="line">2251</span><br><span class="line">2252</span><br><span class="line">2253</span><br><span class="line">2254</span><br><span class="line">2255</span><br><span class="line">2256</span><br><span class="line">2257</span><br><span class="line">2258</span><br><span class="line">2259</span><br><span class="line">2260</span><br><span class="line">2261</span><br><span class="line">2262</span><br><span class="line">2263</span><br><span class="line">2264</span><br><span class="line">2265</span><br><span class="line">2266</span><br><span class="line">2267</span><br><span class="line">2268</span><br><span class="line">2269</span><br><span class="line">2270</span><br><span class="line">2271</span><br><span class="line">2272</span><br><span class="line">2273</span><br><span class="line">2274</span><br><span class="line">2275</span><br><span class="line">2276</span><br><span class="line">2277</span><br><span class="line">2278</span><br><span class="line">2279</span><br><span class="line">2280</span><br><span class="line">2281</span><br><span class="line">2282</span><br><span class="line">2283</span><br><span class="line">2284</span><br><span class="line">2285</span><br><span class="line">2286</span><br><span class="line">2287</span><br><span class="line">2288</span><br><span class="line">2289</span><br><span class="line">2290</span><br><span class="line">2291</span><br><span class="line">2292</span><br><span class="line">2293</span><br><span class="line">2294</span><br><span class="line">2295</span><br><span class="line">2296</span><br><span class="line">2297</span><br><span class="line">2298</span><br><span class="line">2299</span><br><span class="line">2300</span><br><span class="line">2301</span><br><span class="line">2302</span><br><span class="line">2303</span><br><span class="line">2304</span><br><span class="line">2305</span><br><span class="line">2306</span><br><span class="line">2307</span><br><span class="line">2308</span><br><span class="line">2309</span><br><span class="line">2310</span><br><span class="line">2311</span><br><span class="line">2312</span><br><span class="line">2313</span><br><span class="line">2314</span><br><span class="line">2315</span><br><span class="line">2316</span><br><span class="line">2317</span><br><span class="line">2318</span><br><span class="line">2319</span><br><span class="line">2320</span><br><span class="line">2321</span><br><span class="line">2322</span><br><span class="line">2323</span><br><span class="line">2324</span><br><span class="line">2325</span><br><span class="line">2326</span><br><span class="line">2327</span><br><span class="line">2328</span><br><span class="line">2329</span><br><span class="line">2330</span><br><span class="line">2331</span><br><span class="line">2332</span><br><span class="line">2333</span><br><span class="line">2334</span><br><span class="line">2335</span><br><span class="line">2336</span><br><span class="line">2337</span><br><span class="line">2338</span><br><span class="line">2339</span><br><span class="line">2340</span><br><span class="line">2341</span><br><span class="line">2342</span><br><span class="line">2343</span><br><span class="line">2344</span><br><span class="line">2345</span><br><span class="line">2346</span><br><span class="line">2347</span><br><span class="line">2348</span><br><span class="line">2349</span><br><span class="line">2350</span><br><span class="line">2351</span><br><span class="line">2352</span><br><span class="line">2353</span><br><span class="line">2354</span><br><span class="line">2355</span><br><span class="line">2356</span><br><span class="line">2357</span><br><span class="line">2358</span><br><span class="line">2359</span><br><span class="line">2360</span><br><span class="line">2361</span><br><span class="line">2362</span><br><span class="line">2363</span><br><span class="line">2364</span><br><span class="line">2365</span><br><span class="line">2366</span><br><span class="line">2367</span><br><span class="line">2368</span><br><span class="line">2369</span><br><span class="line">2370</span><br><span class="line">2371</span><br><span class="line">2372</span><br><span class="line">2373</span><br><span class="line">2374</span><br><span class="line">2375</span><br><span class="line">2376</span><br><span class="line">2377</span><br><span class="line">2378</span><br><span class="line">2379</span><br><span class="line">2380</span><br><span class="line">2381</span><br><span class="line">2382</span><br><span class="line">2383</span><br><span class="line">2384</span><br><span class="line">2385</span><br><span class="line">2386</span><br><span class="line">2387</span><br><span class="line">2388</span><br><span class="line">2389</span><br><span class="line">2390</span><br><span class="line">2391</span><br><span class="line">2392</span><br><span class="line">2393</span><br><span class="line">2394</span><br><span class="line">2395</span><br><span class="line">2396</span><br><span class="line">2397</span><br><span class="line">2398</span><br><span class="line">2399</span><br><span class="line">2400</span><br><span class="line">2401</span><br><span class="line">2402</span><br><span class="line">2403</span><br><span class="line">2404</span><br><span class="line">2405</span><br><span class="line">2406</span><br><span class="line">2407</span><br><span class="line">2408</span><br><span class="line">2409</span><br><span class="line">2410</span><br><span class="line">2411</span><br><span class="line">2412</span><br><span class="line">2413</span><br><span class="line">2414</span><br><span class="line">2415</span><br><span class="line">2416</span><br><span class="line">2417</span><br><span class="line">2418</span><br><span class="line">2419</span><br><span class="line">2420</span><br><span class="line">2421</span><br><span class="line">2422</span><br><span class="line">2423</span><br><span class="line">2424</span><br><span class="line">2425</span><br><span class="line">2426</span><br><span class="line">2427</span><br><span class="line">2428</span><br><span class="line">2429</span><br><span class="line">2430</span><br><span class="line">2431</span><br><span class="line">2432</span><br><span class="line">2433</span><br><span class="line">2434</span><br><span class="line">2435</span><br><span class="line">2436</span><br><span class="line">2437</span><br><span class="line">2438</span><br><span class="line">2439</span><br><span class="line">2440</span><br><span class="line">2441</span><br><span class="line">2442</span><br><span class="line">2443</span><br><span class="line">2444</span><br><span class="line">2445</span><br><span class="line">2446</span><br><span class="line">2447</span><br><span class="line">2448</span><br><span class="line">2449</span><br><span class="line">2450</span><br><span class="line">2451</span><br><span class="line">2452</span><br><span class="line">2453</span><br><span class="line">2454</span><br><span class="line">2455</span><br><span class="line">2456</span><br><span class="line">2457</span><br><span class="line">2458</span><br><span class="line">2459</span><br><span class="line">2460</span><br><span class="line">2461</span><br><span class="line">2462</span><br><span class="line">2463</span><br><span class="line">2464</span><br><span class="line">2465</span><br><span class="line">2466</span><br><span class="line">2467</span><br><span class="line">2468</span><br><span class="line">2469</span><br><span class="line">2470</span><br><span class="line">2471</span><br><span class="line">2472</span><br><span class="line">2473</span><br><span class="line">2474</span><br><span class="line">2475</span><br><span class="line">2476</span><br><span class="line">2477</span><br><span class="line">2478</span><br><span class="line">2479</span><br><span class="line">2480</span><br><span class="line">2481</span><br><span class="line">2482</span><br><span class="line">2483</span><br><span class="line">2484</span><br><span class="line">2485</span><br><span class="line">2486</span><br><span class="line">2487</span><br><span class="line">2488</span><br><span class="line">2489</span><br><span class="line">2490</span><br><span class="line">2491</span><br><span class="line">2492</span><br><span class="line">2493</span><br><span class="line">2494</span><br><span class="line">2495</span><br><span class="line">2496</span><br><span class="line">2497</span><br><span class="line">2498</span><br><span class="line">2499</span><br><span class="line">2500</span><br><span class="line">2501</span><br><span class="line">2502</span><br><span class="line">2503</span><br><span class="line">2504</span><br><span class="line">2505</span><br><span class="line">2506</span><br><span class="line">2507</span><br><span class="line">2508</span><br><span class="line">2509</span><br><span class="line">2510</span><br><span class="line">2511</span><br><span class="line">2512</span><br><span class="line">2513</span><br><span class="line">2514</span><br><span class="line">2515</span><br><span class="line">2516</span><br><span class="line">2517</span><br><span class="line">2518</span><br><span class="line">2519</span><br><span class="line">2520</span><br><span class="line">2521</span><br><span class="line">2522</span><br><span class="line">2523</span><br><span class="line">2524</span><br><span class="line">2525</span><br><span class="line">2526</span><br><span class="line">2527</span><br><span class="line">2528</span><br><span class="line">2529</span><br><span class="line">2530</span><br><span class="line">2531</span><br><span class="line">2532</span><br><span class="line">2533</span><br><span class="line">2534</span><br><span class="line">2535</span><br><span class="line">2536</span><br><span class="line">2537</span><br><span class="line">2538</span><br><span class="line">2539</span><br><span class="line">2540</span><br><span class="line">2541</span><br><span class="line">2542</span><br><span class="line">2543</span><br><span class="line">2544</span><br><span class="line">2545</span><br><span class="line">2546</span><br><span class="line">2547</span><br><span class="line">2548</span><br><span class="line">2549</span><br><span class="line">2550</span><br><span class="line">2551</span><br><span class="line">2552</span><br><span class="line">2553</span><br><span class="line">2554</span><br><span class="line">2555</span><br><span class="line">2556</span><br><span class="line">2557</span><br><span class="line">2558</span><br><span class="line">2559</span><br><span class="line">2560</span><br><span class="line">2561</span><br><span class="line">2562</span><br><span class="line">2563</span><br><span class="line">2564</span><br><span class="line">2565</span><br><span class="line">2566</span><br><span class="line">2567</span><br><span class="line">2568</span><br><span class="line">2569</span><br><span class="line">2570</span><br><span class="line">2571</span><br><span class="line">2572</span><br><span class="line">2573</span><br><span class="line">2574</span><br><span class="line">2575</span><br><span class="line">2576</span><br><span class="line">2577</span><br><span class="line">2578</span><br><span class="line">2579</span><br><span class="line">2580</span><br><span class="line">2581</span><br><span class="line">2582</span><br><span class="line">2583</span><br><span class="line">2584</span><br><span class="line">2585</span><br><span class="line">2586</span><br><span class="line">2587</span><br><span class="line">2588</span><br><span class="line">2589</span><br><span class="line">2590</span><br><span class="line">2591</span><br><span class="line">2592</span><br><span class="line">2593</span><br><span class="line">2594</span><br><span class="line">2595</span><br><span class="line">2596</span><br><span class="line">2597</span><br><span class="line">2598</span><br><span class="line">2599</span><br><span class="line">2600</span><br><span class="line">2601</span><br><span class="line">2602</span><br><span class="line">2603</span><br><span class="line">2604</span><br><span class="line">2605</span><br><span class="line">2606</span><br><span class="line">2607</span><br><span class="line">2608</span><br><span class="line">2609</span><br><span class="line">2610</span><br><span class="line">2611</span><br><span class="line">2612</span><br><span class="line">2613</span><br><span class="line">2614</span><br><span class="line">2615</span><br><span class="line">2616</span><br><span class="line">2617</span><br><span class="line">2618</span><br><span class="line">2619</span><br><span class="line">2620</span><br><span class="line">2621</span><br><span class="line">2622</span><br><span class="line">2623</span><br><span class="line">2624</span><br><span class="line">2625</span><br><span class="line">2626</span><br><span class="line">2627</span><br><span class="line">2628</span><br><span class="line">2629</span><br><span class="line">2630</span><br><span class="line">2631</span><br><span class="line">2632</span><br><span class="line">2633</span><br><span class="line">2634</span><br><span class="line">2635</span><br><span class="line">2636</span><br><span class="line">2637</span><br><span class="line">2638</span><br><span class="line">2639</span><br><span class="line">2640</span><br><span class="line">2641</span><br><span class="line">2642</span><br><span class="line">2643</span><br><span class="line">2644</span><br><span class="line">2645</span><br><span class="line">2646</span><br><span class="line">2647</span><br><span class="line">2648</span><br><span class="line">2649</span><br><span class="line">2650</span><br><span class="line">2651</span><br><span class="line">2652</span><br><span class="line">2653</span><br><span class="line">2654</span><br><span class="line">2655</span><br><span class="line">2656</span><br><span class="line">2657</span><br><span class="line">2658</span><br><span class="line">2659</span><br><span class="line">2660</span><br><span class="line">2661</span><br><span class="line">2662</span><br><span class="line">2663</span><br><span class="line">2664</span><br><span class="line">2665</span><br><span class="line">2666</span><br><span class="line">2667</span><br><span class="line">2668</span><br><span class="line">2669</span><br><span class="line">2670</span><br><span class="line">2671</span><br><span class="line">2672</span><br><span class="line">2673</span><br><span class="line">2674</span><br><span class="line">2675</span><br><span class="line">2676</span><br><span class="line">2677</span><br><span class="line">2678</span><br><span class="line">2679</span><br><span class="line">2680</span><br><span class="line">2681</span><br><span class="line">2682</span><br><span class="line">2683</span><br><span class="line">2684</span><br><span class="line">2685</span><br><span class="line">2686</span><br><span class="line">2687</span><br><span class="line">2688</span><br><span class="line">2689</span><br><span class="line">2690</span><br><span class="line">2691</span><br><span class="line">2692</span><br><span class="line">2693</span><br><span class="line">2694</span><br><span class="line">2695</span><br><span class="line">2696</span><br><span class="line">2697</span><br><span class="line">2698</span><br><span class="line">2699</span><br><span class="line">2700</span><br><span class="line">2701</span><br><span class="line">2702</span><br><span class="line">2703</span><br><span class="line">2704</span><br><span class="line">2705</span><br><span class="line">2706</span><br><span class="line">2707</span><br><span class="line">2708</span><br><span class="line">2709</span><br><span class="line">2710</span><br><span class="line">2711</span><br><span class="line">2712</span><br><span class="line">2713</span><br><span class="line">2714</span><br><span class="line">2715</span><br><span class="line">2716</span><br><span class="line">2717</span><br><span class="line">2718</span><br><span class="line">2719</span><br><span class="line">2720</span><br><span class="line">2721</span><br><span class="line">2722</span><br><span class="line">2723</span><br><span class="line">2724</span><br><span class="line">2725</span><br><span class="line">2726</span><br><span class="line">2727</span><br><span class="line">2728</span><br><span class="line">2729</span><br><span class="line">2730</span><br><span class="line">2731</span><br><span class="line">2732</span><br><span class="line">2733</span><br><span class="line">2734</span><br><span class="line">2735</span><br><span class="line">2736</span><br><span class="line">2737</span><br><span class="line">2738</span><br><span class="line">2739</span><br><span class="line">2740</span><br><span class="line">2741</span><br><span class="line">2742</span><br><span class="line">2743</span><br><span class="line">2744</span><br><span class="line">2745</span><br><span class="line">2746</span><br><span class="line">2747</span><br><span class="line">2748</span><br><span class="line">2749</span><br><span class="line">2750</span><br><span class="line">2751</span><br><span class="line">2752</span><br><span class="line">2753</span><br><span class="line">2754</span><br><span class="line">2755</span><br><span class="line">2756</span><br><span class="line">2757</span><br><span class="line">2758</span><br><span class="line">2759</span><br><span class="line">2760</span><br><span class="line">2761</span><br><span class="line">2762</span><br><span class="line">2763</span><br><span class="line">2764</span><br><span class="line">2765</span><br><span class="line">2766</span><br><span class="line">2767</span><br><span class="line">2768</span><br><span class="line">2769</span><br><span class="line">2770</span><br><span class="line">2771</span><br><span class="line">2772</span><br><span class="line">2773</span><br><span class="line">2774</span><br><span class="line">2775</span><br><span class="line">2776</span><br><span class="line">2777</span><br><span class="line">2778</span><br><span class="line">2779</span><br><span class="line">2780</span><br><span class="line">2781</span><br><span class="line">2782</span><br><span class="line">2783</span><br><span class="line">2784</span><br><span class="line">2785</span><br><span class="line">2786</span><br><span class="line">2787</span><br><span class="line">2788</span><br><span class="line">2789</span><br><span class="line">2790</span><br><span class="line">2791</span><br><span class="line">2792</span><br><span class="line">2793</span><br><span class="line">2794</span><br><span class="line">2795</span><br><span class="line">2796</span><br><span class="line">2797</span><br><span class="line">2798</span><br><span class="line">2799</span><br><span class="line">2800</span><br><span class="line">2801</span><br><span class="line">2802</span><br><span class="line">2803</span><br><span class="line">2804</span><br><span class="line">2805</span><br><span class="line">2806</span><br><span class="line">2807</span><br><span class="line">2808</span><br><span class="line">2809</span><br><span class="line">2810</span><br><span class="line">2811</span><br><span class="line">2812</span><br><span class="line">2813</span><br><span class="line">2814</span><br><span class="line">2815</span><br><span class="line">2816</span><br><span class="line">2817</span><br><span class="line">2818</span><br><span class="line">2819</span><br><span class="line">2820</span><br><span class="line">2821</span><br><span class="line">2822</span><br><span class="line">2823</span><br><span class="line">2824</span><br><span class="line">2825</span><br><span class="line">2826</span><br><span class="line">2827</span><br><span class="line">2828</span><br><span class="line">2829</span><br><span class="line">2830</span><br><span class="line">2831</span><br><span class="line">2832</span><br><span class="line">2833</span><br><span class="line">2834</span><br><span class="line">2835</span><br><span class="line">2836</span><br><span class="line">2837</span><br><span class="line">2838</span><br><span class="line">2839</span><br><span class="line">2840</span><br><span class="line">2841</span><br><span class="line">2842</span><br><span class="line">2843</span><br><span class="line">2844</span><br><span class="line">2845</span><br><span class="line">2846</span><br><span class="line">2847</span><br><span class="line">2848</span><br><span class="line">2849</span><br><span class="line">2850</span><br><span class="line">2851</span><br><span class="line">2852</span><br><span class="line">2853</span><br><span class="line">2854</span><br><span class="line">2855</span><br><span class="line">2856</span><br><span class="line">2857</span><br><span class="line">2858</span><br><span class="line">2859</span><br><span class="line">2860</span><br><span class="line">2861</span><br><span class="line">2862</span><br><span class="line">2863</span><br><span class="line">2864</span><br><span class="line">2865</span><br><span class="line">2866</span><br><span class="line">2867</span><br><span class="line">2868</span><br><span class="line">2869</span><br><span class="line">2870</span><br><span class="line">2871</span><br><span class="line">2872</span><br><span class="line">2873</span><br><span class="line">2874</span><br><span class="line">2875</span><br><span class="line">2876</span><br><span class="line">2877</span><br><span class="line">2878</span><br><span class="line">2879</span><br><span class="line">2880</span><br><span class="line">2881</span><br><span class="line">2882</span><br><span class="line">2883</span><br><span class="line">2884</span><br><span class="line">2885</span><br><span class="line">2886</span><br><span class="line">2887</span><br><span class="line">2888</span><br><span class="line">2889</span><br><span class="line">2890</span><br><span class="line">2891</span><br><span class="line">2892</span><br><span class="line">2893</span><br><span class="line">2894</span><br><span class="line">2895</span><br><span class="line">2896</span><br><span class="line">2897</span><br><span class="line">2898</span><br><span class="line">2899</span><br><span class="line">2900</span><br><span class="line">2901</span><br><span class="line">2902</span><br><span class="line">2903</span><br><span class="line">2904</span><br><span class="line">2905</span><br><span class="line">2906</span><br><span class="line">2907</span><br><span class="line">2908</span><br><span class="line">2909</span><br><span class="line">2910</span><br><span class="line">2911</span><br><span class="line">2912</span><br><span class="line">2913</span><br><span class="line">2914</span><br><span class="line">2915</span><br><span class="line">2916</span><br><span class="line">2917</span><br><span class="line">2918</span><br><span class="line">2919</span><br><span class="line">2920</span><br><span class="line">2921</span><br><span class="line">2922</span><br><span class="line">2923</span><br><span class="line">2924</span><br><span class="line">2925</span><br><span class="line">2926</span><br><span class="line">2927</span><br><span class="line">2928</span><br><span class="line">2929</span><br><span class="line">2930</span><br><span class="line">2931</span><br><span class="line">2932</span><br><span class="line">2933</span><br><span class="line">2934</span><br><span class="line">2935</span><br><span class="line">2936</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// SPDX-License-Identifier: GPL-2.0+</span><br><span class="hljs-comment">/*****************************************************************************/</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> *      devio.c  --  User space communication with USB devices.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *      Copyright (C) 1999-2000  Thomas Sailer (sailer@ife.ee.ethz.ch)</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  This file implements the usbfs/x/y files, where</span><br><span class="hljs-comment"> *  x is the bus number and y the device number.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  It allows user space programs/&quot;drivers&quot; to communicate directly</span><br><span class="hljs-comment"> *  with USB devices without intervening kernel driver.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *  Revision history</span><br><span class="hljs-comment"> *    22.12.1999   0.1   Initial release (split from proc_usb.c)</span><br><span class="hljs-comment"> *    04.01.2000   0.2   Turned into its own filesystem</span><br><span class="hljs-comment"> *    30.09.2005   0.3   Fix user-triggerable oops in async URB delivery</span><br><span class="hljs-comment"> *    			 (CAN-2005-3055)</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">/*****************************************************************************/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/mm.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/sched/signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/slab.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/module.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/usb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/usbdevice_fs.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/usb/hcd.h&gt;</span>	<span class="hljs-comment">/* for usbcore internals */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/cdev.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/notifier.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/security.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/user_namespace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/scatterlist.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/uaccess.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/dma-mapping.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/byteorder.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/moduleparam.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_HUAWEI_ARMPC_SMART_USB</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;usb/smart_usb/hw_smart_usb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;usb.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../../../platform_source/basicplatform/drivers/usb/core/vendor-usb-core.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_HUAWEI_ARMPC_SMART_USB</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;usb/smart_usb/hw_smart_usb.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PM</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAYBE_CAP_SUSPEND	USBDEVFS_CAP_SUSPEND</span><br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAYBE_CAP_SUSPEND	0</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_MAXBUS			64</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_DEVICE_MAX			(USB_MAXBUS * 128)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_SG_SIZE			16384 <span class="hljs-comment">/* split-size for large txs */</span></span><br><br><span class="hljs-comment">/* Mutual exclusion for ps-&gt;list in resume vs. release and remove */</span><br><span class="hljs-type">static</span> <span class="hljs-title function_">DEFINE_MUTEX</span><span class="hljs-params">(usbfs_mutex)</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">list</span>;</span>      <span class="hljs-comment">/* state list */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">dev</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span><br>	<span class="hljs-type">spinlock_t</span> lock;            <span class="hljs-comment">/* protects the async urb lists */</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">async_pending</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">async_completed</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">memory_list</span>;</span><br>	<span class="hljs-type">wait_queue_head_t</span> wait;     <span class="hljs-comment">/* wake up if a request completed */</span><br>	<span class="hljs-type">wait_queue_head_t</span> wait_for_resume;   <span class="hljs-comment">/* wake up upon runtime resume */</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> discsignr;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">disc_pid</span>;</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">cred</span>;</span><br>	<span class="hljs-type">sigval_t</span> disccontext;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> ifclaimed;<br>	u32 disabled_bulk_eps;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> interface_allowed_mask;<br>	<span class="hljs-type">int</span> not_yet_resumed;<br>	<span class="hljs-type">bool</span> suspend_allowed;<br>	<span class="hljs-type">bool</span> privileges_dropped;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_memory</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">memlist</span>;</span><br>	<span class="hljs-type">int</span> vma_use_count;<br>	<span class="hljs-type">int</span> urb_use_count;<br>	u32 size;<br>	<span class="hljs-type">void</span> *mem;<br>	<span class="hljs-type">dma_addr_t</span> dma_handle;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_start;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span>;</span><br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">asynclist</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">pid</span>;</span><br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">cred</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> signr;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ifnum;<br>	<span class="hljs-type">void</span> __user *userbuffer;<br>	<span class="hljs-type">void</span> __user *userurb;<br>	<span class="hljs-type">sigval_t</span> userurb_sigval;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">urb</span> *<span class="hljs-title">urb</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_memory</span> *<span class="hljs-title">usbm</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> mem_usage;<br>	<span class="hljs-type">int</span> status;<br>	u8 bulk_addr;<br>	u8 bulk_status;<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">bool</span> usbfs_snoop;<br>module_param(usbfs_snoop, <span class="hljs-type">bool</span>, S_IRUGO | S_IWUSR);<br>MODULE_PARM_DESC(usbfs_snoop, <span class="hljs-string">&quot;true to log all usbfs traffic&quot;</span>);<br><br><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> usbfs_snoop_max = <span class="hljs-number">65536</span>;<br>module_param(usbfs_snoop_max, uint, S_IRUGO | S_IWUSR);<br>MODULE_PARM_DESC(usbfs_snoop_max,<br>		<span class="hljs-string">&quot;maximum number of bytes to print while snooping&quot;</span>);<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> snoop(dev, format, arg...)				\</span><br><span class="hljs-meta">	do &#123;							\</span><br><span class="hljs-meta">		<span class="hljs-keyword">if</span> (usbfs_snoop)				\</span><br><span class="hljs-meta">			dev_info(dev, format, ## arg);		\</span><br><span class="hljs-meta">	&#125; while (0)</span><br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">snoop_when</span> &#123;</span><br>	SUBMIT, COMPLETE<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_DEVICE_DEV		MKDEV(USB_DEVICE_MAJOR, 0)</span><br><br><span class="hljs-comment">/* Limit on the total amount of memory we can allocate for transfers */</span><br><span class="hljs-type">static</span> u32 usbfs_memory_mb = <span class="hljs-number">16</span>;<br>module_param(usbfs_memory_mb, uint, <span class="hljs-number">0644</span>);<br>MODULE_PARM_DESC(usbfs_memory_mb,<br>		<span class="hljs-string">&quot;maximum MB allowed for usbfs buffers (0 = no limit)&quot;</span>);<br><br><span class="hljs-comment">/* Hard limit, necessary to avoid arithmetic overflow */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USBFS_XFER_MAX         (UINT_MAX / 2 - 1000000)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">atomic64_t</span> usbfs_memory_usage;	<span class="hljs-comment">/* Total memory currently allocated */</span><br><br><span class="hljs-comment">/* Check whether it&#x27;s okay to allocate more memory for a transfer */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">usbfs_increase_memory_usage</span><span class="hljs-params">(u64 amount)</span><br>&#123;<br>	u64 lim;<br><br>	lim = READ_ONCE(usbfs_memory_mb);<br>	lim &lt;&lt;= <span class="hljs-number">20</span>;<br><br>	atomic64_add(amount, &amp;usbfs_memory_usage);<br><br>	<span class="hljs-keyword">if</span> (lim &gt; <span class="hljs-number">0</span> &amp;&amp; atomic64_read(&amp;usbfs_memory_usage) &gt; lim) &#123;<br>		atomic64_sub(amount, &amp;usbfs_memory_usage);<br>		<span class="hljs-keyword">return</span> -ENOMEM;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* Memory for a transfer is being deallocated */</span><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">usbfs_decrease_memory_usage</span><span class="hljs-params">(u64 amount)</span><br>&#123;<br>	atomic64_sub(amount, &amp;usbfs_memory_usage);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">connected</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> (!list_empty(&amp;ps-&gt;<span class="hljs-built_in">list</span>) &amp;&amp;<br>			ps-&gt;dev-&gt;state != USB_STATE_NOTATTACHED);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">dec_usb_memory_use_count</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_memory *usbm, <span class="hljs-type">int</span> *count)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span> =</span> usbm-&gt;ps;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>	spin_lock_irqsave(&amp;ps-&gt;lock, flags);<br>	--*count;<br>	<span class="hljs-keyword">if</span> (usbm-&gt;urb_use_count == <span class="hljs-number">0</span> &amp;&amp; usbm-&gt;vma_use_count == <span class="hljs-number">0</span>) &#123;<br>		list_del(&amp;usbm-&gt;memlist);<br>		spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br><br>		usb_free_coherent(ps-&gt;dev, usbm-&gt;size, usbm-&gt;mem,<br>				usbm-&gt;dma_handle);<br>		usbfs_decrease_memory_usage(<br>			usbm-&gt;size + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_memory));<br>		kfree(usbm);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br>	&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">usbdev_vm_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_memory</span> *<span class="hljs-title">usbm</span> =</span> vma-&gt;vm_private_data;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>	spin_lock_irqsave(&amp;usbm-&gt;ps-&gt;lock, flags);<br>	++usbm-&gt;vma_use_count;<br>	spin_unlock_irqrestore(&amp;usbm-&gt;ps-&gt;lock, flags);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">usbdev_vm_close</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_memory</span> *<span class="hljs-title">usbm</span> =</span> vma-&gt;vm_private_data;<br><br>	dec_usb_memory_use_count(usbm, &amp;usbm-&gt;vma_use_count);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> <span class="hljs-title">usbdev_vm_ops</span> =</span> &#123;<br>	.open = usbdev_vm_open,<br>	.close = usbdev_vm_close<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">usbdev_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_memory</span> *<span class="hljs-title">usbm</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span> =</span> file-&gt;private_data;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_hcd</span> *<span class="hljs-title">hcd</span> =</span> bus_to_hcd(ps-&gt;dev-&gt;bus);<br>	<span class="hljs-type">size_t</span> size = vma-&gt;vm_end - vma-&gt;vm_start;<br>	<span class="hljs-type">void</span> *mem;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br>	<span class="hljs-type">dma_addr_t</span> dma_handle;<br>	<span class="hljs-type">int</span> ret;<br><br>	ret = usbfs_increase_memory_usage(size + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_memory));<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">goto</span> error;<br><br>	usbm = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_memory), GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (!usbm) &#123;<br>		ret = -ENOMEM;<br>		<span class="hljs-keyword">goto</span> error_decrease_mem;<br>	&#125;<br><br>	mem = usb_alloc_coherent(ps-&gt;dev, size, GFP_USER | __GFP_NOWARN,<br>			&amp;dma_handle);<br>	<span class="hljs-keyword">if</span> (!mem) &#123;<br>		ret = -ENOMEM;<br>		<span class="hljs-keyword">goto</span> error_free_usbm;<br>	&#125;<br><br>	<span class="hljs-built_in">memset</span>(mem, <span class="hljs-number">0</span>, size);<br><br>	usbm-&gt;mem = mem;<br>	usbm-&gt;dma_handle = dma_handle;<br>	usbm-&gt;size = size;<br>	usbm-&gt;ps = ps;<br>	usbm-&gt;vm_start = vma-&gt;vm_start;<br>	usbm-&gt;vma_use_count = <span class="hljs-number">1</span>;<br>	INIT_LIST_HEAD(&amp;usbm-&gt;memlist);<br><br>	<span class="hljs-keyword">if</span> (hcd-&gt;localmem_pool || !hcd_uses_dma(hcd)) &#123;<br>		<span class="hljs-keyword">if</span> (remap_pfn_range(vma, vma-&gt;vm_start,<br>				    virt_to_phys(usbm-&gt;mem) &gt;&gt; PAGE_SHIFT,<br>				    size, vma-&gt;vm_page_prot) &lt; <span class="hljs-number">0</span>) &#123;<br>			dec_usb_memory_use_count(usbm, &amp;usbm-&gt;vma_use_count);<br>			<span class="hljs-keyword">return</span> -EAGAIN;<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">if</span> (dma_mmap_coherent(hcd-&gt;self.sysdev, vma, mem, dma_handle,<br>				      size)) &#123;<br>			dec_usb_memory_use_count(usbm, &amp;usbm-&gt;vma_use_count);<br>			<span class="hljs-keyword">return</span> -EAGAIN;<br>		&#125;<br>	&#125;<br><br>	vma-&gt;vm_flags |= VM_IO;<br>	vma-&gt;vm_flags |= (VM_DONTEXPAND | VM_DONTDUMP);<br>	vma-&gt;vm_ops = &amp;usbdev_vm_ops;<br>	vma-&gt;vm_private_data = usbm;<br><br>	spin_lock_irqsave(&amp;ps-&gt;lock, flags);<br>	list_add_tail(&amp;usbm-&gt;memlist, &amp;ps-&gt;memory_list);<br>	spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>error_free_usbm:<br>	kfree(usbm);<br>error_decrease_mem:<br>	usbfs_decrease_memory_usage(size + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_memory));<br>error:<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span> <span class="hljs-title function_">usbdev_read</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">char</span> __user *buf, <span class="hljs-type">size_t</span> nbytes,</span><br><span class="hljs-params">			   <span class="hljs-type">loff_t</span> *ppos)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span> =</span> file-&gt;private_data;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">dev</span> =</span> ps-&gt;dev;<br>	<span class="hljs-type">ssize_t</span> ret = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">unsigned</span> len;<br>	<span class="hljs-type">loff_t</span> pos;<br>	<span class="hljs-type">int</span> i;<br><br>	pos = *ppos;<br>	usb_lock_device(dev);<br>	<span class="hljs-keyword">if</span> (!connected(ps)) &#123;<br>		ret = -ENODEV;<br>		<span class="hljs-keyword">goto</span> err;<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pos &lt; <span class="hljs-number">0</span>) &#123;<br>		ret = -EINVAL;<br>		<span class="hljs-keyword">goto</span> err;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (pos &lt; <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_device_descriptor)) &#123;<br>		<span class="hljs-comment">/* 18 bytes - fits on the stack */</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device_descriptor</span> <span class="hljs-title">temp_desc</span>;</span><br><br>		<span class="hljs-built_in">memcpy</span>(&amp;temp_desc, &amp;dev-&gt;descriptor, <span class="hljs-keyword">sizeof</span>(dev-&gt;descriptor));<br>		le16_to_cpus(&amp;temp_desc.bcdUSB);<br>		le16_to_cpus(&amp;temp_desc.idVendor);<br>		le16_to_cpus(&amp;temp_desc.idProduct);<br>		le16_to_cpus(&amp;temp_desc.bcdDevice);<br><br>		len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_device_descriptor) - pos;<br>		<span class="hljs-keyword">if</span> (len &gt; nbytes)<br>			len = nbytes;<br>		<span class="hljs-keyword">if</span> (copy_to_user(buf, ((<span class="hljs-type">char</span> *)&amp;temp_desc) + pos, len)) &#123;<br>			ret = -EFAULT;<br>			<span class="hljs-keyword">goto</span> err;<br>		&#125;<br><br>		*ppos += len;<br>		buf += len;<br>		nbytes -= len;<br>		ret += len;<br>	&#125;<br><br>	pos = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_device_descriptor);<br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; nbytes &amp;&amp; i &lt; dev-&gt;descriptor.bNumConfigurations; i++) &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_config_descriptor</span> *<span class="hljs-title">config</span> =</span><br>			(<span class="hljs-keyword">struct</span> usb_config_descriptor *)dev-&gt;rawdescriptors[i];<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> length = le16_to_cpu(config-&gt;wTotalLength);<br><br>		<span class="hljs-keyword">if</span> (*ppos &lt; pos + length) &#123;<br><br>			<span class="hljs-comment">/* The descriptor may claim to be longer than it</span><br><span class="hljs-comment">			 * really is.  Here is the actual allocated length. */</span><br>			<span class="hljs-type">unsigned</span> alloclen =<br>				le16_to_cpu(dev-&gt;config[i].desc.wTotalLength);<br><br>			len = length - (*ppos - pos);<br>			<span class="hljs-keyword">if</span> (len &gt; nbytes)<br>				len = nbytes;<br><br>			<span class="hljs-comment">/* Simply don&#x27;t write (skip over) unallocated parts */</span><br>			<span class="hljs-keyword">if</span> (alloclen &gt; (*ppos - pos)) &#123;<br>				alloclen -= (*ppos - pos);<br>				<span class="hljs-keyword">if</span> (copy_to_user(buf,<br>				    dev-&gt;rawdescriptors[i] + (*ppos - pos),<br>				    min(len, alloclen))) &#123;<br>					ret = -EFAULT;<br>					<span class="hljs-keyword">goto</span> err;<br>				&#125;<br>			&#125;<br><br>			*ppos += len;<br>			buf += len;<br>			nbytes -= len;<br>			ret += len;<br>		&#125;<br><br>		pos += length;<br>	&#125;<br><br>err:<br>	usb_unlock_device(dev);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * async list handling</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> async *<span class="hljs-title function_">alloc_async</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> numisoframes)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span>;</span><br><br>	as = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> async), GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (!as)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	as-&gt;urb = usb_alloc_urb(numisoframes, GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (!as-&gt;urb) &#123;<br>		kfree(as);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> as;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">free_async</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> async *as)</span><br>&#123;<br>	<span class="hljs-type">int</span> i;<br><br>	put_pid(as-&gt;pid);<br>	<span class="hljs-keyword">if</span> (as-&gt;cred)<br>		put_cred(as-&gt;cred);<br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; as-&gt;urb-&gt;num_sgs; i++) &#123;<br>		<span class="hljs-keyword">if</span> (sg_page(&amp;as-&gt;urb-&gt;sg[i]))<br>			kfree(sg_virt(&amp;as-&gt;urb-&gt;sg[i]));<br>	&#125;<br><br>	kfree(as-&gt;urb-&gt;sg);<br>	<span class="hljs-keyword">if</span> (as-&gt;usbm == <span class="hljs-literal">NULL</span>)<br>		kfree(as-&gt;urb-&gt;transfer_buffer);<br>	<span class="hljs-keyword">else</span><br>		dec_usb_memory_use_count(as-&gt;usbm, &amp;as-&gt;usbm-&gt;urb_use_count);<br><br>	kfree(as-&gt;urb-&gt;setup_packet);<br>	usb_free_urb(as-&gt;urb);<br>	usbfs_decrease_memory_usage(as-&gt;mem_usage);<br>	kfree(as);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">async_newpending</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> async *as)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span> =</span> as-&gt;ps;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>	spin_lock_irqsave(&amp;ps-&gt;lock, flags);<br>	list_add_tail(&amp;as-&gt;asynclist, &amp;ps-&gt;async_pending);<br>	spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">async_removepending</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> async *as)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span> =</span> as-&gt;ps;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>	spin_lock_irqsave(&amp;ps-&gt;lock, flags);<br>	list_del_init(&amp;as-&gt;asynclist);<br>	spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> async *<span class="hljs-title function_">async_getcompleted</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>	spin_lock_irqsave(&amp;ps-&gt;lock, flags);<br>	<span class="hljs-keyword">if</span> (!list_empty(&amp;ps-&gt;async_completed)) &#123;<br>		as = list_entry(ps-&gt;async_completed.next, <span class="hljs-keyword">struct</span> async,<br>				asynclist);<br>		list_del_init(&amp;as-&gt;asynclist);<br>	&#125;<br>	spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br>	<span class="hljs-keyword">return</span> as;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> async *<span class="hljs-title function_">async_getpending</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps,</span><br><span class="hljs-params">					     <span class="hljs-type">void</span> __user *userurb)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span>;</span><br><br>	list_for_each_entry(as, &amp;ps-&gt;async_pending, asynclist)<br>		<span class="hljs-keyword">if</span> (as-&gt;userurb == userurb) &#123;<br>			list_del_init(&amp;as-&gt;asynclist);<br>			<span class="hljs-keyword">return</span> as;<br>		&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">snoop_urb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_device *udev,</span><br><span class="hljs-params">		<span class="hljs-type">void</span> __user *userurb, <span class="hljs-type">int</span> pipe, <span class="hljs-type">unsigned</span> length,</span><br><span class="hljs-params">		<span class="hljs-type">int</span> timeout_or_status, <span class="hljs-keyword">enum</span> snoop_when when,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *data, <span class="hljs-type">unsigned</span> data_len)</span><br>&#123;<br>	<span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *types[] = &#123;<span class="hljs-string">&quot;isoc&quot;</span>, <span class="hljs-string">&quot;int&quot;</span>, <span class="hljs-string">&quot;ctrl&quot;</span>, <span class="hljs-string">&quot;bulk&quot;</span>&#125;;<br>	<span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *dirs[] = &#123;<span class="hljs-string">&quot;out&quot;</span>, <span class="hljs-string">&quot;in&quot;</span>&#125;;<br>	<span class="hljs-type">int</span> ep;<br>	<span class="hljs-type">const</span> <span class="hljs-type">char</span> *t, *d;<br><br>	<span class="hljs-keyword">if</span> (!usbfs_snoop)<br>		<span class="hljs-keyword">return</span>;<br><br>	ep = usb_pipeendpoint(pipe);<br>	t = types[usb_pipetype(pipe)];<br>	d = dirs[!!usb_pipein(pipe)];<br><br>	<span class="hljs-keyword">if</span> (userurb) &#123;		<span class="hljs-comment">/* Async */</span><br>		<span class="hljs-keyword">if</span> (when == SUBMIT)<br>			dev_info(&amp;udev-&gt;dev, <span class="hljs-string">&quot;userurb %px, ep%d %s-%s, &quot;</span><br>					<span class="hljs-string">&quot;length %u\n&quot;</span>,<br>					userurb, ep, t, d, length);<br>		<span class="hljs-keyword">else</span><br>			dev_info(&amp;udev-&gt;dev, <span class="hljs-string">&quot;userurb %px, ep%d %s-%s, &quot;</span><br>					<span class="hljs-string">&quot;actual_length %u status %d\n&quot;</span>,<br>					userurb, ep, t, d, length,<br>					timeout_or_status);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">if</span> (when == SUBMIT)<br>			dev_info(&amp;udev-&gt;dev, <span class="hljs-string">&quot;ep%d %s-%s, length %u, &quot;</span><br>					<span class="hljs-string">&quot;timeout %d\n&quot;</span>,<br>					ep, t, d, length, timeout_or_status);<br>		<span class="hljs-keyword">else</span><br>			dev_info(&amp;udev-&gt;dev, <span class="hljs-string">&quot;ep%d %s-%s, actual_length %u, &quot;</span><br>					<span class="hljs-string">&quot;status %d\n&quot;</span>,<br>					ep, t, d, length, timeout_or_status);<br>	&#125;<br><br>	data_len = min(data_len, usbfs_snoop_max);<br>	<span class="hljs-keyword">if</span> (data &amp;&amp; data_len &gt; <span class="hljs-number">0</span>) &#123;<br>		print_hex_dump(KERN_DEBUG, <span class="hljs-string">&quot;data: &quot;</span>, DUMP_PREFIX_NONE, <span class="hljs-number">32</span>, <span class="hljs-number">1</span>,<br>			data, data_len, <span class="hljs-number">1</span>);<br>	&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">snoop_urb_data</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> urb *urb, <span class="hljs-type">unsigned</span> len)</span><br>&#123;<br>	<span class="hljs-type">int</span> i, size;<br><br>	len = min(len, usbfs_snoop_max);<br>	<span class="hljs-keyword">if</span> (!usbfs_snoop || len == <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span>;<br><br>	<span class="hljs-keyword">if</span> (urb-&gt;num_sgs == <span class="hljs-number">0</span>) &#123;<br>		print_hex_dump(KERN_DEBUG, <span class="hljs-string">&quot;data: &quot;</span>, DUMP_PREFIX_NONE, <span class="hljs-number">32</span>, <span class="hljs-number">1</span>,<br>			urb-&gt;transfer_buffer, len, <span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">return</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; urb-&gt;num_sgs &amp;&amp; len; i++) &#123;<br>		size = (len &gt; USB_SG_SIZE) ? USB_SG_SIZE : len;<br>		print_hex_dump(KERN_DEBUG, <span class="hljs-string">&quot;data: &quot;</span>, DUMP_PREFIX_NONE, <span class="hljs-number">32</span>, <span class="hljs-number">1</span>,<br>			sg_virt(&amp;urb-&gt;sg[i]), size, <span class="hljs-number">1</span>);<br>		len -= size;<br>	&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">copy_urb_data_to_user</span><span class="hljs-params">(u8 __user *userbuffer, <span class="hljs-keyword">struct</span> urb *urb)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> i, len, size;<br><br>	<span class="hljs-keyword">if</span> (urb-&gt;number_of_packets &gt; <span class="hljs-number">0</span>)		<span class="hljs-comment">/* Isochronous */</span><br>		len = urb-&gt;transfer_buffer_length;<br>	<span class="hljs-keyword">else</span>					<span class="hljs-comment">/* Non-Isoc */</span><br>		len = urb-&gt;actual_length;<br><br>	<span class="hljs-keyword">if</span> (urb-&gt;num_sgs == <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-keyword">if</span> (copy_to_user(userbuffer, urb-&gt;transfer_buffer, len))<br>			<span class="hljs-keyword">return</span> -EFAULT;<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; urb-&gt;num_sgs &amp;&amp; len; i++) &#123;<br>		size = (len &gt; USB_SG_SIZE) ? USB_SG_SIZE : len;<br>		<span class="hljs-keyword">if</span> (copy_to_user(userbuffer, sg_virt(&amp;urb-&gt;sg[i]), size))<br>			<span class="hljs-keyword">return</span> -EFAULT;<br>		userbuffer += size;<br>		len -= size;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AS_CONTINUATION	1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> AS_UNLINK	2</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">cancel_bulk_urbs</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">unsigned</span> bulk_addr)</span><br>__<span class="hljs-title function_">releases</span><span class="hljs-params">(ps-&gt;lock)</span><br>__<span class="hljs-title function_">acquires</span><span class="hljs-params">(ps-&gt;lock)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">urb</span> *<span class="hljs-title">urb</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span>;</span><br><br>	<span class="hljs-comment">/* Mark all the pending URBs that match bulk_addr, up to but not</span><br><span class="hljs-comment">	 * including the first one without AS_CONTINUATION.  If such an</span><br><span class="hljs-comment">	 * URB is encountered then a new transfer has already started so</span><br><span class="hljs-comment">	 * the endpoint doesn&#x27;t need to be disabled; otherwise it does.</span><br><span class="hljs-comment">	 */</span><br>	list_for_each_entry(as, &amp;ps-&gt;async_pending, asynclist) &#123;<br>		<span class="hljs-keyword">if</span> (as-&gt;bulk_addr == bulk_addr) &#123;<br>			<span class="hljs-keyword">if</span> (as-&gt;bulk_status != AS_CONTINUATION)<br>				<span class="hljs-keyword">goto</span> rescan;<br>			as-&gt;bulk_status = AS_UNLINK;<br>			as-&gt;bulk_addr = <span class="hljs-number">0</span>;<br>		&#125;<br>	&#125;<br>	ps-&gt;disabled_bulk_eps |= (<span class="hljs-number">1</span> &lt;&lt; bulk_addr);<br><br>	<span class="hljs-comment">/* Now carefully unlink all the marked pending URBs */</span><br> rescan:<br>	list_for_each_entry_reverse(as, &amp;ps-&gt;async_pending, asynclist) &#123;<br>		<span class="hljs-keyword">if</span> (as-&gt;bulk_status == AS_UNLINK) &#123;<br>			as-&gt;bulk_status = <span class="hljs-number">0</span>;		<span class="hljs-comment">/* Only once */</span><br>			urb = as-&gt;urb;<br>			usb_get_urb(urb);<br>			spin_unlock(&amp;ps-&gt;lock);		<span class="hljs-comment">/* Allow completions */</span><br>			usb_unlink_urb(urb);<br>			usb_put_urb(urb);<br>			spin_lock(&amp;ps-&gt;lock);<br>			<span class="hljs-keyword">goto</span> rescan;<br>		&#125;<br>	&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">async_completed</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> urb *urb)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span> =</span> urb-&gt;context;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span> =</span> as-&gt;ps;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span> *<span class="hljs-title">pid</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cred</span> *<span class="hljs-title">cred</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br>	<span class="hljs-type">sigval_t</span> addr;<br>	<span class="hljs-type">int</span> signr, errno;<br><br>	spin_lock_irqsave(&amp;ps-&gt;lock, flags);<br>	list_move_tail(&amp;as-&gt;asynclist, &amp;ps-&gt;async_completed);<br>	as-&gt;status = urb-&gt;status;<br>	signr = as-&gt;signr;<br>	<span class="hljs-keyword">if</span> (signr) &#123;<br>		errno = as-&gt;status;<br>		addr = as-&gt;userurb_sigval;<br>		pid = get_pid(as-&gt;pid);<br>		cred = get_cred(as-&gt;cred);<br>	&#125;<br>	snoop(&amp;urb-&gt;dev-&gt;dev, <span class="hljs-string">&quot;urb complete\n&quot;</span>);<br>	snoop_urb(urb-&gt;dev, as-&gt;userurb, urb-&gt;pipe, urb-&gt;actual_length,<br>			as-&gt;status, COMPLETE, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (usb_urb_dir_in(urb))<br>		snoop_urb_data(urb, urb-&gt;actual_length);<br><br>	<span class="hljs-keyword">if</span> (as-&gt;status &lt; <span class="hljs-number">0</span> &amp;&amp; as-&gt;bulk_addr &amp;&amp; as-&gt;status != -ECONNRESET &amp;&amp;<br>			as-&gt;status != -ENOENT)<br>		cancel_bulk_urbs(ps, as-&gt;bulk_addr);<br><br>	wake_up(&amp;ps-&gt;wait);<br>	spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br><br>	<span class="hljs-keyword">if</span> (signr) &#123;<br>		kill_pid_usb_asyncio(signr, errno, addr, pid, cred);<br>		put_pid(pid);<br>		put_cred(cred);<br>	&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">destroy_async</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-keyword">struct</span> list_head *<span class="hljs-built_in">list</span>)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">urb</span> *<span class="hljs-title">urb</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>	spin_lock_irqsave(&amp;ps-&gt;lock, flags);<br>	<span class="hljs-keyword">while</span> (!list_empty(<span class="hljs-built_in">list</span>)) &#123;<br>		as = list_last_entry(<span class="hljs-built_in">list</span>, <span class="hljs-keyword">struct</span> async, asynclist);<br>		list_del_init(&amp;as-&gt;asynclist);<br>		urb = as-&gt;urb;<br>		usb_get_urb(urb);<br><br>		<span class="hljs-comment">/* drop the spinlock so the completion handler can run */</span><br>		spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br>		usb_kill_urb(urb);<br>		usb_put_urb(urb);<br>		spin_lock_irqsave(&amp;ps-&gt;lock, flags);<br>	&#125;<br>	spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">destroy_async_on_interface</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps,</span><br><span class="hljs-params">				       <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ifnum)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> *<span class="hljs-title">p</span>, *<span class="hljs-title">q</span>, <span class="hljs-title">hitlist</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>	INIT_LIST_HEAD(&amp;hitlist);<br>	spin_lock_irqsave(&amp;ps-&gt;lock, flags);<br>	list_for_each_safe(p, q, &amp;ps-&gt;async_pending)<br>		<span class="hljs-keyword">if</span> (ifnum == list_entry(p, <span class="hljs-keyword">struct</span> async, asynclist)-&gt;ifnum)<br>			list_move_tail(p, &amp;hitlist);<br>	spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br>	destroy_async(ps, &amp;hitlist);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">destroy_all_async</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps)</span><br>&#123;<br>	destroy_async(ps, &amp;ps-&gt;async_pending);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * interface claims are made only at the request of user level code,</span><br><span class="hljs-comment"> * which can also release them (explicitly or by closing files).</span><br><span class="hljs-comment"> * they&#x27;re also undone when devices disconnect.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">driver_probe</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_interface *intf,</span><br><span class="hljs-params">			<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> usb_device_id *id)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> -ENODEV;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">driver_disconnect</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_interface *intf)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span> =</span> usb_get_intfdata(intf);<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ifnum = intf-&gt;altsetting-&gt;desc.bInterfaceNumber;<br><br>	<span class="hljs-keyword">if</span> (!ps)<br>		<span class="hljs-keyword">return</span>;<br><br>	<span class="hljs-comment">/* <span class="hljs-doctag">NOTE:</span>  this relies on usbcore having canceled and completed</span><br><span class="hljs-comment">	 * all pending I/O requests; 2.6 does that.</span><br><span class="hljs-comment">	 */</span><br><br>	<span class="hljs-keyword">if</span> (likely(ifnum &lt; <span class="hljs-number">8</span>*<span class="hljs-keyword">sizeof</span>(ps-&gt;ifclaimed)))<br>		clear_bit(ifnum, &amp;ps-&gt;ifclaimed);<br>	<span class="hljs-keyword">else</span><br>		dev_warn(&amp;intf-&gt;dev, <span class="hljs-string">&quot;interface number %u out of range\n&quot;</span>,<br>			 ifnum);<br><br>	usb_set_intfdata(intf, <span class="hljs-literal">NULL</span>);<br><br>	<span class="hljs-comment">/* force async requests to complete */</span><br>	destroy_async_on_interface(ps, ifnum);<br>&#125;<br><br><span class="hljs-comment">/* We don&#x27;t care about suspend/resume of claimed interfaces */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">driver_suspend</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_interface *intf, <span class="hljs-type">pm_message_t</span> msg)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">driver_resume</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_interface *intf)</span><br>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* The following routines apply to the entire device, not interfaces */</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">usbfs_notify_suspend</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_device *udev)</span><br>&#123;<br>	<span class="hljs-comment">/* We don&#x27;t need to handle this */</span><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">usbfs_notify_resume</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_device *udev)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span>;</span><br><br>	<span class="hljs-comment">/* Protect against simultaneous remove or release */</span><br>	mutex_lock(&amp;usbfs_mutex);<br>	list_for_each_entry(ps, &amp;udev-&gt;filelist, <span class="hljs-built_in">list</span>) &#123;<br>		WRITE_ONCE(ps-&gt;not_yet_resumed, <span class="hljs-number">0</span>);<br>		wake_up_all(&amp;ps-&gt;wait_for_resume);<br>	&#125;<br>	mutex_unlock(&amp;usbfs_mutex);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_driver</span> <span class="hljs-title">usbfs_driver</span> =</span> &#123;<br>	.name =		<span class="hljs-string">&quot;usbfs&quot;</span>,<br>	.probe =	driver_probe,<br>	.disconnect =	driver_disconnect,<br>	.suspend =	driver_suspend,<br>	.resume =	driver_resume,<br>	.supports_autosuspend = <span class="hljs-number">1</span>,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">claimintf</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ifnum)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">dev</span> =</span> ps-&gt;dev;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">intf</span>;</span><br>	<span class="hljs-type">int</span> err;<br><br>	<span class="hljs-keyword">if</span> (ifnum &gt;= <span class="hljs-number">8</span>*<span class="hljs-keyword">sizeof</span>(ps-&gt;ifclaimed))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	<span class="hljs-comment">/* already claimed */</span><br>	<span class="hljs-keyword">if</span> (test_bit(ifnum, &amp;ps-&gt;ifclaimed))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (ps-&gt;privileges_dropped &amp;&amp;<br>			!test_bit(ifnum, &amp;ps-&gt;interface_allowed_mask))<br>		<span class="hljs-keyword">return</span> -EACCES;<br><br>	intf = usb_ifnum_to_if(dev, ifnum);<br>	<span class="hljs-keyword">if</span> (!intf)<br>		err = -ENOENT;<br>	<span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> old_suppress;<br><br>		<span class="hljs-comment">/* suppress uevents while claiming interface */</span><br>		old_suppress = dev_get_uevent_suppress(&amp;intf-&gt;dev);<br>		dev_set_uevent_suppress(&amp;intf-&gt;dev, <span class="hljs-number">1</span>);<br>		err = usb_driver_claim_interface(&amp;usbfs_driver, intf, ps);<br>		dev_set_uevent_suppress(&amp;intf-&gt;dev, old_suppress);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (err == <span class="hljs-number">0</span>)<br>		set_bit(ifnum, &amp;ps-&gt;ifclaimed);<br>	<span class="hljs-keyword">return</span> err;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">releaseintf</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ifnum)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">dev</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">intf</span>;</span><br>	<span class="hljs-type">int</span> err;<br><br>	err = -EINVAL;<br>	<span class="hljs-keyword">if</span> (ifnum &gt;= <span class="hljs-number">8</span>*<span class="hljs-keyword">sizeof</span>(ps-&gt;ifclaimed))<br>		<span class="hljs-keyword">return</span> err;<br>	dev = ps-&gt;dev;<br>	intf = usb_ifnum_to_if(dev, ifnum);<br>	<span class="hljs-keyword">if</span> (!intf)<br>		err = -ENOENT;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (test_and_clear_bit(ifnum, &amp;ps-&gt;ifclaimed)) &#123;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> old_suppress;<br><br>		<span class="hljs-comment">/* suppress uevents while releasing interface */</span><br>		old_suppress = dev_get_uevent_suppress(&amp;intf-&gt;dev);<br>		dev_set_uevent_suppress(&amp;intf-&gt;dev, <span class="hljs-number">1</span>);<br>		usb_driver_release_interface(&amp;usbfs_driver, intf);<br>		dev_set_uevent_suppress(&amp;intf-&gt;dev, old_suppress);<br>		err = <span class="hljs-number">0</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> err;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">checkintf</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ifnum)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (ps-&gt;dev-&gt;state != USB_STATE_CONFIGURED)<br>		<span class="hljs-keyword">return</span> -EHOSTUNREACH;<br>	<span class="hljs-keyword">if</span> (ifnum &gt;= <span class="hljs-number">8</span>*<span class="hljs-keyword">sizeof</span>(ps-&gt;ifclaimed))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	<span class="hljs-keyword">if</span> (test_bit(ifnum, &amp;ps-&gt;ifclaimed))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-comment">/* if not yet claimed, claim it for the driver */</span><br>	dev_warn(&amp;ps-&gt;dev-&gt;dev, <span class="hljs-string">&quot;usbfs: process %d (%s) did not claim &quot;</span><br>		 <span class="hljs-string">&quot;interface %u before use\n&quot;</span>, task_pid_nr(current),<br>		 current-&gt;comm, ifnum);<br>	<span class="hljs-keyword">return</span> claimintf(ps, ifnum);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findintfep</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_device *dev, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ep)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i, j, e;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">intf</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_interface</span> *<span class="hljs-title">alts</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_endpoint_descriptor</span> *<span class="hljs-title">endpt</span>;</span><br><br>	<span class="hljs-keyword">if</span> (ep &amp; ~(USB_DIR_IN|<span class="hljs-number">0xf</span>))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	<span class="hljs-keyword">if</span> (!dev-&gt;actconfig)<br>		<span class="hljs-keyword">return</span> -ESRCH;<br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; dev-&gt;actconfig-&gt;desc.bNumInterfaces; i++) &#123;<br>		intf = dev-&gt;actconfig-&gt;interface[i];<br>		<span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; intf-&gt;num_altsetting; j++) &#123;<br>			alts = &amp;intf-&gt;altsetting[j];<br>			<span class="hljs-keyword">for</span> (e = <span class="hljs-number">0</span>; e &lt; alts-&gt;desc.bNumEndpoints; e++) &#123;<br>				endpt = &amp;alts-&gt;endpoint[e].desc;<br>				<span class="hljs-keyword">if</span> (endpt-&gt;bEndpointAddress == ep)<br>					<span class="hljs-keyword">return</span> alts-&gt;desc.bInterfaceNumber;<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> -ENOENT;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">check_ctrlrecip</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> requesttype,</span><br><span class="hljs-params">			   <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> request, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> index)</span><br>&#123;<br>	<span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_interface</span> *<span class="hljs-title">alt_setting</span>;</span><br><br>	<span class="hljs-keyword">if</span> (ps-&gt;dev-&gt;state != USB_STATE_UNAUTHENTICATED<br>	 &amp;&amp; ps-&gt;dev-&gt;state != USB_STATE_ADDRESS<br>	 &amp;&amp; ps-&gt;dev-&gt;state != USB_STATE_CONFIGURED)<br>		<span class="hljs-keyword">return</span> -EHOSTUNREACH;<br>	<span class="hljs-keyword">if</span> (USB_TYPE_VENDOR == (USB_TYPE_MASK &amp; requesttype))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * check for the special corner case &#x27;get_device_id&#x27; in the printer</span><br><span class="hljs-comment">	 * class specification, which we always want to allow as it is used</span><br><span class="hljs-comment">	 * to query things like ink level, etc.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (requesttype == <span class="hljs-number">0xa1</span> &amp;&amp; request == <span class="hljs-number">0</span> &amp;&amp; ps-&gt;dev-&gt;actconfig) &#123;<br>		alt_setting = usb_find_alt_setting(ps-&gt;dev-&gt;actconfig,<br>						   index &gt;&gt; <span class="hljs-number">8</span>, index &amp; <span class="hljs-number">0xff</span>);<br>		<span class="hljs-keyword">if</span> (alt_setting<br>		 &amp;&amp; alt_setting-&gt;desc.bInterfaceClass == USB_CLASS_PRINTER)<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br><br>	index &amp;= <span class="hljs-number">0xff</span>;<br>	<span class="hljs-keyword">switch</span> (requesttype &amp; USB_RECIP_MASK) &#123;<br>	<span class="hljs-keyword">case</span> USB_RECIP_ENDPOINT:<br>		<span class="hljs-keyword">if</span> ((index &amp; ~USB_DIR_IN) == <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>		ret = findintfep(ps-&gt;dev, index);<br>		<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Some not fully compliant Win apps seem to get</span><br><span class="hljs-comment">			 * index wrong and have the endpoint number here</span><br><span class="hljs-comment">			 * rather than the endpoint address (with the</span><br><span class="hljs-comment">			 * correct direction). Win does let this through,</span><br><span class="hljs-comment">			 * so we&#x27;ll not reject it here but leave it to</span><br><span class="hljs-comment">			 * the device to not break KVM. But we warn.</span><br><span class="hljs-comment">			 */</span><br>			ret = findintfep(ps-&gt;dev, index ^ <span class="hljs-number">0x80</span>);<br>			<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>				dev_info(&amp;ps-&gt;dev-&gt;dev,<br>					<span class="hljs-string">&quot;%s: process %i (%s) requesting ep %02x but needs %02x\n&quot;</span>,<br>					__func__, task_pid_nr(current),<br>					current-&gt;comm, index, index ^ <span class="hljs-number">0x80</span>);<br>		&#125;<br>		<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>			ret = checkintf(ps, ret);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USB_RECIP_INTERFACE:<br>		ret = checkintf(ps, index);<br>		<span class="hljs-keyword">break</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> usb_host_endpoint *<span class="hljs-title function_">ep_to_host_endpoint</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_device *dev,</span><br><span class="hljs-params">						     <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> ep)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (ep &amp; USB_ENDPOINT_DIR_MASK)<br>		<span class="hljs-keyword">return</span> dev-&gt;ep_in[ep &amp; USB_ENDPOINT_NUMBER_MASK];<br>	<span class="hljs-keyword">else</span><br>		<span class="hljs-keyword">return</span> dev-&gt;ep_out[ep &amp; USB_ENDPOINT_NUMBER_MASK];<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">parse_usbdevfs_streams</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps,</span><br><span class="hljs-params">				  <span class="hljs-keyword">struct</span> usbdevfs_streams __user *streams,</span><br><span class="hljs-params">				  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *num_streams_ret,</span><br><span class="hljs-params">				  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *num_eps_ret,</span><br><span class="hljs-params">				  <span class="hljs-keyword">struct</span> usb_host_endpoint ***eps_ret,</span><br><span class="hljs-params">				  <span class="hljs-keyword">struct</span> usb_interface **intf_ret)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i, num_streams, num_eps;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_endpoint</span> **<span class="hljs-title">eps</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">intf</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> ep;<br>	<span class="hljs-type">int</span> ifnum, ret;<br><br>	<span class="hljs-keyword">if</span> (get_user(num_streams, &amp;streams-&gt;num_streams) ||<br>	    get_user(num_eps, &amp;streams-&gt;num_eps))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	<span class="hljs-keyword">if</span> (num_eps &lt; <span class="hljs-number">1</span> || num_eps &gt; USB_MAXENDPOINTS)<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	<span class="hljs-comment">/* The XHCI controller allows max 2 ^ 16 streams */</span><br>	<span class="hljs-keyword">if</span> (num_streams_ret &amp;&amp; (num_streams &lt; <span class="hljs-number">2</span> || num_streams &gt; <span class="hljs-number">65536</span>))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	eps = kmalloc_array(num_eps, <span class="hljs-keyword">sizeof</span>(*eps), GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (!eps)<br>		<span class="hljs-keyword">return</span> -ENOMEM;<br><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num_eps; i++) &#123;<br>		<span class="hljs-keyword">if</span> (get_user(ep, &amp;streams-&gt;eps[i])) &#123;<br>			ret = -EFAULT;<br>			<span class="hljs-keyword">goto</span> error;<br>		&#125;<br>		eps[i] = ep_to_host_endpoint(ps-&gt;dev, ep);<br>		<span class="hljs-keyword">if</span> (!eps[i]) &#123;<br>			ret = -EINVAL;<br>			<span class="hljs-keyword">goto</span> error;<br>		&#125;<br><br>		<span class="hljs-comment">/* usb_alloc/free_streams operate on an usb_interface */</span><br>		ifnum = findintfep(ps-&gt;dev, ep);<br>		<span class="hljs-keyword">if</span> (ifnum &lt; <span class="hljs-number">0</span>) &#123;<br>			ret = ifnum;<br>			<span class="hljs-keyword">goto</span> error;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) &#123;<br>			ret = checkintf(ps, ifnum);<br>			<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>				<span class="hljs-keyword">goto</span> error;<br>			intf = usb_ifnum_to_if(ps-&gt;dev, ifnum);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-comment">/* Verify all eps belong to the same interface */</span><br>			<span class="hljs-keyword">if</span> (ifnum != intf-&gt;altsetting-&gt;desc.bInterfaceNumber) &#123;<br>				ret = -EINVAL;<br>				<span class="hljs-keyword">goto</span> error;<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (num_streams_ret)<br>		*num_streams_ret = num_streams;<br>	*num_eps_ret = num_eps;<br>	*eps_ret = eps;<br>	*intf_ret = intf;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>error:<br>	kfree(eps);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> usb_device *<span class="hljs-title function_">usbdev_lookup_by_devt</span><span class="hljs-params">(<span class="hljs-type">dev_t</span> devt)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">device</span> *<span class="hljs-title">dev</span>;</span><br><br>	dev = bus_find_device_by_devt(&amp;usb_bus_type, devt);<br>	<span class="hljs-keyword">if</span> (!dev)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">return</span> to_usb_device(dev);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * file operations</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">usbdev_open</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">dev</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span>;</span><br>	<span class="hljs-type">int</span> ret;<br><br>	ret = -ENOMEM;<br>	ps = kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_dev_state), GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (!ps)<br>		<span class="hljs-keyword">goto</span> out_free_ps;<br><br>	ret = -ENODEV;<br><br>	<span class="hljs-comment">/* usbdev device-node */</span><br>	<span class="hljs-keyword">if</span> (imajor(inode) == USB_DEVICE_MAJOR)<br>		dev = usbdev_lookup_by_devt(inode-&gt;i_rdev);<br>	<span class="hljs-keyword">if</span> (!dev)<br>		<span class="hljs-keyword">goto</span> out_free_ps;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> CONFIG_USB_DEVICE_READ_USE_TRYLOCK</span><br>	usb_lock_device(dev);<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>	<span class="hljs-keyword">if</span> (usb_device_read_usb_trylock_device(dev)) &#123;<br>		usb_put_dev(dev);<br>		<span class="hljs-keyword">goto</span> out_free_ps;<br>	&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	<span class="hljs-keyword">if</span> (dev-&gt;state == USB_STATE_NOTATTACHED)<br>		<span class="hljs-keyword">goto</span> out_unlock_device;<br><br>	ret = usb_autoresume_device(dev);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">goto</span> out_unlock_device;<br><br>	ps-&gt;dev = dev;<br>	ps-&gt;file = file;<br>	ps-&gt;interface_allowed_mask = <span class="hljs-number">0xFFFFFFFF</span>; <span class="hljs-comment">/* 32 bits */</span><br>	spin_lock_init(&amp;ps-&gt;lock);<br>	INIT_LIST_HEAD(&amp;ps-&gt;<span class="hljs-built_in">list</span>);<br>	INIT_LIST_HEAD(&amp;ps-&gt;async_pending);<br>	INIT_LIST_HEAD(&amp;ps-&gt;async_completed);<br>	INIT_LIST_HEAD(&amp;ps-&gt;memory_list);<br>	init_waitqueue_head(&amp;ps-&gt;wait);<br>	init_waitqueue_head(&amp;ps-&gt;wait_for_resume);<br>	ps-&gt;disc_pid = get_pid(task_pid(current));<br>	ps-&gt;cred = get_current_cred();<br>	smp_wmb();<br><br>	<span class="hljs-comment">/* Can&#x27;t race with resume; the device is already active */</span><br>	list_add_tail(&amp;ps-&gt;<span class="hljs-built_in">list</span>, &amp;dev-&gt;filelist);<br>	file-&gt;private_data = ps;<br>	usb_unlock_device(dev);<br>	snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;opened by process %d: %s\n&quot;</span>, task_pid_nr(current),<br>			current-&gt;comm);<br>	<span class="hljs-keyword">return</span> ret;<br><br> out_unlock_device:<br>	usb_unlock_device(dev);<br>	usb_put_dev(dev);<br> out_free_ps:<br>	kfree(ps);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">usbdev_release</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-keyword">struct</span> file *file)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span> =</span> file-&gt;private_data;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">dev</span> =</span> ps-&gt;dev;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ifnum;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span>;</span><br><br>	usb_lock_device(dev);<br>	usb_hub_release_all_ports(dev, ps);<br><br>	<span class="hljs-comment">/* Protect against simultaneous resume */</span><br>	mutex_lock(&amp;usbfs_mutex);<br>	list_del_init(&amp;ps-&gt;<span class="hljs-built_in">list</span>);<br>	mutex_unlock(&amp;usbfs_mutex);<br><br>	<span class="hljs-keyword">for</span> (ifnum = <span class="hljs-number">0</span>; ps-&gt;ifclaimed &amp;&amp; ifnum &lt; <span class="hljs-number">8</span>*<span class="hljs-keyword">sizeof</span>(ps-&gt;ifclaimed);<br>			ifnum++) &#123;<br>		<span class="hljs-keyword">if</span> (test_bit(ifnum, &amp;ps-&gt;ifclaimed))<br>			releaseintf(ps, ifnum);<br>	&#125;<br>	destroy_all_async(ps);<br>	<span class="hljs-keyword">if</span> (!ps-&gt;suspend_allowed)<br>		usb_autosuspend_device(dev);<br>	usb_unlock_device(dev);<br>	usb_put_dev(dev);<br>	put_pid(ps-&gt;disc_pid);<br>	put_cred(ps-&gt;cred);<br><br>	as = async_getcompleted(ps);<br>	<span class="hljs-keyword">while</span> (as) &#123;<br>		free_async(as);<br>		as = async_getcompleted(ps);<br>	&#125;<br><br>	kfree(ps);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_proc_control</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps,</span><br><span class="hljs-params">		<span class="hljs-keyword">struct</span> usbdevfs_ctrltransfer *ctrl)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">dev</span> =</span> ps-&gt;dev;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tmo;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *tbuf;<br>	<span class="hljs-type">unsigned</span> wLength;<br>	<span class="hljs-type">int</span> i, pipe, ret;<br><br>	ret = check_ctrlrecip(ps, ctrl-&gt;bRequestType, ctrl-&gt;bRequest,<br>			      ctrl-&gt;wIndex);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br>	wLength = ctrl-&gt;wLength;	<span class="hljs-comment">/* To suppress 64k PAGE_SIZE warning */</span><br>	<span class="hljs-keyword">if</span> (wLength &gt; PAGE_SIZE)<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	ret = usbfs_increase_memory_usage(PAGE_SIZE + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> urb) +<br>			<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_ctrlrequest));<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br>	tbuf = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)__get_free_page(GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (!tbuf) &#123;<br>		ret = -ENOMEM;<br>		<span class="hljs-keyword">goto</span> done;<br>	&#125;<br>	tmo = ctrl-&gt;timeout;<br>	snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;control urb: bRequestType=%02x &quot;</span><br>		<span class="hljs-string">&quot;bRequest=%02x wValue=%04x &quot;</span><br>		<span class="hljs-string">&quot;wIndex=%04x wLength=%04x\n&quot;</span>,<br>		ctrl-&gt;bRequestType, ctrl-&gt;bRequest, ctrl-&gt;wValue,<br>		ctrl-&gt;wIndex, ctrl-&gt;wLength);<br>	<span class="hljs-keyword">if</span> ((ctrl-&gt;bRequestType &amp; USB_DIR_IN) &amp;&amp; ctrl-&gt;wLength) &#123;<br>		pipe = usb_rcvctrlpipe(dev, <span class="hljs-number">0</span>);<br>		snoop_urb(dev, <span class="hljs-literal">NULL</span>, pipe, ctrl-&gt;wLength, tmo, SUBMIT, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>		usb_unlock_device(dev);<br>		i = usb_control_msg(dev, pipe, ctrl-&gt;bRequest,<br>				    ctrl-&gt;bRequestType, ctrl-&gt;wValue, ctrl-&gt;wIndex,<br>				    tbuf, ctrl-&gt;wLength, tmo);<br>		usb_lock_device(dev);<br>		snoop_urb(dev, <span class="hljs-literal">NULL</span>, pipe, max(i, <span class="hljs-number">0</span>), min(i, <span class="hljs-number">0</span>), COMPLETE,<br>			  tbuf, max(i, <span class="hljs-number">0</span>));<br>		<span class="hljs-keyword">if</span> ((i &gt; <span class="hljs-number">0</span>) &amp;&amp; ctrl-&gt;wLength) &#123;<br>			<span class="hljs-keyword">if</span> (copy_to_user(ctrl-&gt;data, tbuf, i)) &#123;<br>				ret = -EFAULT;<br>				<span class="hljs-keyword">goto</span> done;<br>			&#125;<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">if</span> (ctrl-&gt;wLength) &#123;<br>			<span class="hljs-keyword">if</span> (copy_from_user(tbuf, ctrl-&gt;data, ctrl-&gt;wLength)) &#123;<br>				ret = -EFAULT;<br>				<span class="hljs-keyword">goto</span> done;<br>			&#125;<br>		&#125;<br>		pipe = usb_sndctrlpipe(dev, <span class="hljs-number">0</span>);<br>		snoop_urb(dev, <span class="hljs-literal">NULL</span>, pipe, ctrl-&gt;wLength, tmo, SUBMIT,<br>			tbuf, ctrl-&gt;wLength);<br><br>		usb_unlock_device(dev);<br>		i = usb_control_msg(dev, usb_sndctrlpipe(dev, <span class="hljs-number">0</span>), ctrl-&gt;bRequest,<br>				    ctrl-&gt;bRequestType, ctrl-&gt;wValue, ctrl-&gt;wIndex,<br>				    tbuf, ctrl-&gt;wLength, tmo);<br>		usb_lock_device(dev);<br>		snoop_urb(dev, <span class="hljs-literal">NULL</span>, pipe, max(i, <span class="hljs-number">0</span>), min(i, <span class="hljs-number">0</span>), COMPLETE, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>	&#125;<br>	<span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">0</span> &amp;&amp; i != -EPIPE) &#123;<br>		dev_printk(KERN_DEBUG, &amp;dev-&gt;dev, <span class="hljs-string">&quot;usbfs: USBDEVFS_CONTROL &quot;</span><br>			   <span class="hljs-string">&quot;failed cmd %s rqt %u rq %u len %u ret %d\n&quot;</span>,<br>			   current-&gt;comm, ctrl-&gt;bRequestType, ctrl-&gt;bRequest,<br>			   ctrl-&gt;wLength, i);<br>	&#125;<br>	ret = i;<br> done:<br>	free_page((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) tbuf);<br>	usbfs_decrease_memory_usage(PAGE_SIZE + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> urb) +<br>			<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_ctrlrequest));<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_control</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_ctrltransfer</span> <span class="hljs-title">ctrl</span>;</span><br><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;ctrl, arg, <span class="hljs-keyword">sizeof</span>(ctrl)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	<span class="hljs-keyword">return</span> do_proc_control(ps, &amp;ctrl);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_proc_bulk</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps,</span><br><span class="hljs-params">		<span class="hljs-keyword">struct</span> usbdevfs_bulktransfer *bulk)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">dev</span> =</span> ps-&gt;dev;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tmo, len1, pipe;<br>	<span class="hljs-type">int</span> len2;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *tbuf;<br>	<span class="hljs-type">int</span> i, ret;<br><br>	ret = findintfep(ps-&gt;dev, bulk-&gt;ep);<br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> ret;<br>	ret = checkintf(ps, ret);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br>	<span class="hljs-keyword">if</span> (bulk-&gt;ep &amp; USB_DIR_IN)<br>		pipe = usb_rcvbulkpipe(dev, bulk-&gt;ep &amp; <span class="hljs-number">0x7f</span>);<br>	<span class="hljs-keyword">else</span><br>		pipe = usb_sndbulkpipe(dev, bulk-&gt;ep &amp; <span class="hljs-number">0x7f</span>);<br>	<span class="hljs-keyword">if</span> (!usb_maxpacket(dev, pipe, !(bulk-&gt;ep &amp; USB_DIR_IN)))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	len1 = bulk-&gt;len;<br>	<span class="hljs-keyword">if</span> (len1 &gt;= (INT_MAX - <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> urb)))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	ret = usbfs_increase_memory_usage(len1 + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> urb));<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * len1 can be almost arbitrarily large.  Don&#x27;t WARN if it&#x27;s</span><br><span class="hljs-comment">	 * too big, just fail the request.</span><br><span class="hljs-comment">	 */</span><br>	tbuf = kmalloc(len1, GFP_KERNEL | __GFP_NOWARN);<br>	<span class="hljs-keyword">if</span> (!tbuf) &#123;<br>		ret = -ENOMEM;<br>		<span class="hljs-keyword">goto</span> done;<br>	&#125;<br>	tmo = bulk-&gt;timeout;<br>	<span class="hljs-keyword">if</span> (bulk-&gt;ep &amp; <span class="hljs-number">0x80</span>) &#123;<br>		snoop_urb(dev, <span class="hljs-literal">NULL</span>, pipe, len1, tmo, SUBMIT, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br><br>		usb_unlock_device(dev);<br>		i = usb_bulk_msg(dev, pipe, tbuf, len1, &amp;len2, tmo);<br>		usb_lock_device(dev);<br>		snoop_urb(dev, <span class="hljs-literal">NULL</span>, pipe, len2, i, COMPLETE, tbuf, len2);<br><br>		<span class="hljs-keyword">if</span> (!i &amp;&amp; len2) &#123;<br>			<span class="hljs-keyword">if</span> (copy_to_user(bulk-&gt;data, tbuf, len2)) &#123;<br>				ret = -EFAULT;<br>				<span class="hljs-keyword">goto</span> done;<br>			&#125;<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">if</span> (len1) &#123;<br>			<span class="hljs-keyword">if</span> (copy_from_user(tbuf, bulk-&gt;data, len1)) &#123;<br>				ret = -EFAULT;<br>				<span class="hljs-keyword">goto</span> done;<br>			&#125;<br>		&#125;<br>		snoop_urb(dev, <span class="hljs-literal">NULL</span>, pipe, len1, tmo, SUBMIT, tbuf, len1);<br><br>		usb_unlock_device(dev);<br>		i = usb_bulk_msg(dev, pipe, tbuf, len1, &amp;len2, tmo);<br>		usb_lock_device(dev);<br>		snoop_urb(dev, <span class="hljs-literal">NULL</span>, pipe, len2, i, COMPLETE, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>	&#125;<br>	ret = (i &lt; <span class="hljs-number">0</span> ? i : len2);<br> done:<br>	kfree(tbuf);<br>	usbfs_decrease_memory_usage(len1 + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> urb));<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_bulk</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_bulktransfer</span> <span class="hljs-title">bulk</span>;</span><br><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;bulk, arg, <span class="hljs-keyword">sizeof</span>(bulk)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	<span class="hljs-keyword">return</span> do_proc_bulk(ps, &amp;bulk);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">check_reset_of_active_ep</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_device *udev,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> epnum, <span class="hljs-type">char</span> *ioctl_name)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_endpoint</span> **<span class="hljs-title">eps</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_endpoint</span> *<span class="hljs-title">ep</span>;</span><br><br>	eps = (epnum &amp; USB_DIR_IN) ? udev-&gt;ep_in : udev-&gt;ep_out;<br>	ep = eps[epnum &amp; <span class="hljs-number">0x0f</span>];<br>	<span class="hljs-keyword">if</span> (ep &amp;&amp; !list_empty(&amp;ep-&gt;urb_list))<br>		dev_warn(&amp;udev-&gt;dev, <span class="hljs-string">&quot;Process %d (%s) called USBDEVFS_%s for active endpoint 0x%02x\n&quot;</span>,<br>				task_pid_nr(current), current-&gt;comm,<br>				ioctl_name, epnum);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_resetep</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ep;<br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (get_user(ep, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __user *)arg))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	ret = findintfep(ps-&gt;dev, ep);<br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> ret;<br>	ret = checkintf(ps, ret);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br>	check_reset_of_active_ep(ps-&gt;dev, ep, <span class="hljs-string">&quot;RESETEP&quot;</span>);<br>	usb_reset_endpoint(ps-&gt;dev, ep);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_clearhalt</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ep;<br>	<span class="hljs-type">int</span> pipe;<br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (get_user(ep, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __user *)arg))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	ret = findintfep(ps-&gt;dev, ep);<br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> ret;<br>	ret = checkintf(ps, ret);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br>	check_reset_of_active_ep(ps-&gt;dev, ep, <span class="hljs-string">&quot;CLEAR_HALT&quot;</span>);<br>	<span class="hljs-keyword">if</span> (ep &amp; USB_DIR_IN)<br>		pipe = usb_rcvbulkpipe(ps-&gt;dev, ep &amp; <span class="hljs-number">0x7f</span>);<br>	<span class="hljs-keyword">else</span><br>		pipe = usb_sndbulkpipe(ps-&gt;dev, ep &amp; <span class="hljs-number">0x7f</span>);<br><br>	<span class="hljs-keyword">return</span> usb_clear_halt(ps-&gt;dev, pipe);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_getdriver</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_getdriver</span> <span class="hljs-title">gd</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">intf</span>;</span><br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;gd, arg, <span class="hljs-keyword">sizeof</span>(gd)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	intf = usb_ifnum_to_if(ps-&gt;dev, gd.interface);<br>	<span class="hljs-keyword">if</span> (!intf || !intf-&gt;dev.driver)<br>		ret = -ENODATA;<br>	<span class="hljs-keyword">else</span> &#123;<br>		strlcpy(gd.driver, intf-&gt;dev.driver-&gt;name,<br>				<span class="hljs-keyword">sizeof</span>(gd.driver));<br>		ret = (copy_to_user(arg, &amp;gd, <span class="hljs-keyword">sizeof</span>(gd)) ? -EFAULT : <span class="hljs-number">0</span>);<br>	&#125;<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_connectinfo</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_connectinfo</span> <span class="hljs-title">ci</span>;</span><br><br>	<span class="hljs-built_in">memset</span>(&amp;ci, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(ci));<br>	ci.devnum = ps-&gt;dev-&gt;devnum;<br>	ci.slow = ps-&gt;dev-&gt;speed == USB_SPEED_LOW;<br><br>	<span class="hljs-keyword">if</span> (copy_to_user(arg, &amp;ci, <span class="hljs-keyword">sizeof</span>(ci)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_conninfo_ex</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps,</span><br><span class="hljs-params">			    <span class="hljs-type">void</span> __user *arg, <span class="hljs-type">size_t</span> size)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_conninfo_ex</span> <span class="hljs-title">ci</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">udev</span> =</span> ps-&gt;dev;<br><br>	<span class="hljs-keyword">if</span> (size &lt; <span class="hljs-keyword">sizeof</span>(ci.size))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	<span class="hljs-built_in">memset</span>(&amp;ci, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(ci));<br>	ci.size = <span class="hljs-keyword">sizeof</span>(ci);<br>	ci.busnum = udev-&gt;bus-&gt;busnum;<br>	ci.devnum = udev-&gt;devnum;<br>	ci.speed = udev-&gt;speed;<br><br>	<span class="hljs-keyword">while</span> (udev &amp;&amp; udev-&gt;portnum != <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-keyword">if</span> (++ci.num_ports &lt;= ARRAY_SIZE(ci.ports))<br>			ci.ports[ARRAY_SIZE(ci.ports) - ci.num_ports] =<br>					udev-&gt;portnum;<br>		udev = udev-&gt;parent;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (ci.num_ports &lt; ARRAY_SIZE(ci.ports))<br>		memmove(&amp;ci.ports[<span class="hljs-number">0</span>],<br>			&amp;ci.ports[ARRAY_SIZE(ci.ports) - ci.num_ports],<br>			ci.num_ports);<br><br>	<span class="hljs-keyword">if</span> (copy_to_user(arg, &amp;ci, min(<span class="hljs-keyword">sizeof</span>(ci), size)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_resetdevice</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_config</span> *<span class="hljs-title">actconfig</span> =</span> ps-&gt;dev-&gt;actconfig;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">interface</span>;</span><br>	<span class="hljs-type">int</span> i, number;<br><br>	<span class="hljs-comment">/* Don&#x27;t allow a device reset if the process has dropped the</span><br><span class="hljs-comment">	 * privilege to do such things and any of the interfaces are</span><br><span class="hljs-comment">	 * currently claimed.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (ps-&gt;privileges_dropped &amp;&amp; actconfig) &#123;<br>		<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; actconfig-&gt;desc.bNumInterfaces; ++i) &#123;<br>			interface = actconfig-&gt;interface[i];<br>			number = interface-&gt;cur_altsetting-&gt;desc.bInterfaceNumber;<br>			<span class="hljs-keyword">if</span> (usb_interface_claimed(interface) &amp;&amp;<br>					!test_bit(number, &amp;ps-&gt;ifclaimed)) &#123;<br>				dev_warn(&amp;ps-&gt;dev-&gt;dev,<br>					<span class="hljs-string">&quot;usbfs: interface %d claimed by %s while &#x27;%s&#x27; resets device\n&quot;</span>,<br>					number,	interface-&gt;dev.driver-&gt;name, current-&gt;comm);<br>				<span class="hljs-keyword">return</span> -EACCES;<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> usb_reset_device(ps-&gt;dev);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_setintf</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_setinterface</span> <span class="hljs-title">setintf</span>;</span><br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;setintf, arg, <span class="hljs-keyword">sizeof</span>(setintf)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	ret = checkintf(ps, setintf.interface);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br><br>	destroy_async_on_interface(ps, setintf.interface);<br><br>	<span class="hljs-keyword">return</span> usb_set_interface(ps-&gt;dev, setintf.interface,<br>			setintf.altsetting);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_setconfig</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-type">int</span> u;<br>	<span class="hljs-type">int</span> status = <span class="hljs-number">0</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_config</span> *<span class="hljs-title">actconfig</span>;</span><br><br>	<span class="hljs-keyword">if</span> (get_user(u, (<span class="hljs-type">int</span> __user *)arg))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	actconfig = ps-&gt;dev-&gt;actconfig;<br><br>	<span class="hljs-comment">/* Don&#x27;t touch the device if any interfaces are claimed.</span><br><span class="hljs-comment">	 * It could interfere with other drivers&#x27; operations, and if</span><br><span class="hljs-comment">	 * an interface is claimed by usbfs it could easily deadlock.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (actconfig) &#123;<br>		<span class="hljs-type">int</span> i;<br><br>		<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; actconfig-&gt;desc.bNumInterfaces; ++i) &#123;<br>			<span class="hljs-keyword">if</span> (usb_interface_claimed(actconfig-&gt;interface[i])) &#123;<br>				dev_warn(&amp;ps-&gt;dev-&gt;dev,<br>					<span class="hljs-string">&quot;usbfs: interface %d claimed by %s &quot;</span><br>					<span class="hljs-string">&quot;while &#x27;%s&#x27; sets config #%d\n&quot;</span>,<br>					actconfig-&gt;interface[i]<br>						-&gt;cur_altsetting<br>						-&gt;desc.bInterfaceNumber,<br>					actconfig-&gt;interface[i]<br>						-&gt;dev.driver-&gt;name,<br>					current-&gt;comm, u);<br>				status = -EBUSY;<br>				<span class="hljs-keyword">break</span>;<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">/* SET_CONFIGURATION is often abused as a &quot;cheap&quot; driver reset,</span><br><span class="hljs-comment">	 * so avoid usb_set_configuration()&#x27;s kick to sysfs</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (status == <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-keyword">if</span> (actconfig &amp;&amp; actconfig-&gt;desc.bConfigurationValue == u)<br>			status = usb_reset_configuration(ps-&gt;dev);<br>		<span class="hljs-keyword">else</span><br>			status = usb_set_configuration(ps-&gt;dev, u);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> status;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> usb_memory *<br><span class="hljs-title function_">find_memory_area</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> usbdevfs_urb *uurb)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_memory</span> *<span class="hljs-title">usbm</span> =</span> <span class="hljs-literal">NULL</span>, *iter;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> uurb_start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)uurb-&gt;buffer;<br><br>	spin_lock_irqsave(&amp;ps-&gt;lock, flags);<br>	list_for_each_entry(iter, &amp;ps-&gt;memory_list, memlist) &#123;<br>		<span class="hljs-keyword">if</span> (uurb_start &gt;= iter-&gt;vm_start &amp;&amp;<br>				uurb_start &lt; iter-&gt;vm_start + iter-&gt;size) &#123;<br>			<span class="hljs-keyword">if</span> (uurb-&gt;buffer_length &gt; iter-&gt;vm_start + iter-&gt;size -<br>					uurb_start) &#123;<br>				usbm = ERR_PTR(-EINVAL);<br>			&#125; <span class="hljs-keyword">else</span> &#123;<br>				usbm = iter;<br>				usbm-&gt;urb_use_count++;<br>			&#125;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br>	&#125;<br>	spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br>	<span class="hljs-keyword">return</span> usbm;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_HUAWEI_ARMPC_SMART_USB</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mtp_struct</span> &#123;</span><br>	u32 container_length;<br>	u16 container_type;<br>	u16 operation_code;<br>	u32 transaction_id;<br>	<span class="hljs-type">void</span> *payload;<br>&#125;;<br><br><span class="hljs-comment">/* forbid mtp &amp;&amp; ptp &amp;&amp; adb methods write command */</span><br><span class="hljs-type">bool</span> <span class="hljs-title function_">hw_check_phone_read_access</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_device *dev, <span class="hljs-type">int</span> ifnum, <span class="hljs-type">void</span> __user *buffer)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">intf</span>;</span><br>	<span class="hljs-type">bool</span> ret = <span class="hljs-literal">true</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mtp_struct</span> <span class="hljs-title">mtp</span>;</span><br>	<span class="hljs-type">char</span> *usb_path = <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-keyword">if</span> (dev-&gt;devpath) &#123;<br>		usb_path = dev-&gt;devpath;<br>	<br>		<span class="hljs-keyword">if</span> (hw_get_usb_safe_mode(usb_path) == <span class="hljs-number">0x0</span>)<br>			<span class="hljs-keyword">return</span> ret;<br><br>		intf = usb_ifnum_to_if(dev, ifnum);<br>		<span class="hljs-keyword">if</span> (intf-&gt;cur_altsetting &amp;&amp; intf-&gt;cur_altsetting-&gt;<span class="hljs-built_in">string</span> &amp;&amp; (<span class="hljs-built_in">strstr</span>(intf-&gt;cur_altsetting-&gt;<span class="hljs-built_in">string</span>, <span class="hljs-string">&quot;ADB Interface&quot;</span>))) &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> ((dev-&gt;config &amp;&amp; dev-&gt;config-&gt;<span class="hljs-built_in">string</span> &amp;&amp; ((<span class="hljs-built_in">strstr</span>(dev-&gt;config-&gt;<span class="hljs-built_in">string</span>, <span class="hljs-string">&quot;mtp&quot;</span>)) || (<span class="hljs-built_in">strstr</span>(dev-&gt;config-&gt;<span class="hljs-built_in">string</span>, <span class="hljs-string">&quot;ptp&quot;</span>)))) ||<br>			(intf-&gt;cur_altsetting-&gt;desc.bInterfaceClass == USB_CLASS_STILL_IMAGE &amp;&amp; intf-&gt;cur_altsetting-&gt;desc.bInterfaceProtocol == <span class="hljs-number">0x01</span>) ||<br>			(intf-&gt;cur_altsetting-&gt;<span class="hljs-built_in">string</span> &amp;&amp; (<span class="hljs-built_in">strstr</span>(intf-&gt;cur_altsetting-&gt;<span class="hljs-built_in">string</span>, <span class="hljs-string">&quot;MTP&quot;</span>) || <span class="hljs-built_in">strstr</span>(intf-&gt;cur_altsetting-&gt;<span class="hljs-built_in">string</span>, <span class="hljs-string">&quot;PTP&quot;</span>)))) &#123;<br><br>			<span class="hljs-keyword">if</span> (check_storage_rejects_status(usb_path))<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br><br>			<span class="hljs-keyword">if</span> (!copy_from_user(&amp;mtp, buffer, <span class="hljs-keyword">sizeof</span>(mtp))) &#123;<br>				<span class="hljs-comment">/* MTP Operation Codes</span><br><span class="hljs-comment">				* MTP_OPERATION_GET_DEVICE_INFO                       0x1001</span><br><span class="hljs-comment">				* MTP_OPERATION_OPEN_SESSION                          0x1002</span><br><span class="hljs-comment">				* MTP_OPERATION_CLOSE_SESSION                         0x1003</span><br><span class="hljs-comment">				* MTP_OPERATION_GET_STORAGE_IDS                       0x1004</span><br><span class="hljs-comment">				* MTP_OPERATION_GET_STORAGE_INFO                      0x1005</span><br><span class="hljs-comment">				* MTP_OPERATION_GET_NUM_OBJECTS                       0x1006</span><br><span class="hljs-comment">				* MTP_OPERATION_GET_OBJECT_HANDLES                    0x1007</span><br><span class="hljs-comment">				* MTP_OPERATION_GET_OBJECT_INFO                       0x1008</span><br><span class="hljs-comment">				* MTP_OPERATION_GET_OBJECT                            0x1009</span><br><span class="hljs-comment">				* MTP_OPERATION_GET_THUMB                             0x100A</span><br><span class="hljs-comment">				* MTP_OPERATION_DELETE_OBJECT                         0x100B</span><br><span class="hljs-comment">				* MTP_OPERATION_SEND_OBJECT_INFO                      0x100C</span><br><span class="hljs-comment">				* MTP_OPERATION_SEND_OBJECT                           0x100D</span><br><span class="hljs-comment">				* MTP_OPERATION_INITIATE_CAPTURE                      0x100E</span><br><span class="hljs-comment">				* MTP_OPERATION_FORMAT_STORE                          0x100F</span><br><span class="hljs-comment">				* MTP_OPERATION_RESET_DEVICE                          0x1010</span><br><span class="hljs-comment">				* MTP_OPERATION_SELF_TEST                             0x1011</span><br><span class="hljs-comment">				* MTP_OPERATION_SET_OBJECT_PROTECTION                 0x1012</span><br><span class="hljs-comment">				* MTP_OPERATION_POWER_DOWN                            0x1013</span><br><span class="hljs-comment">				* MTP_OPERATION_GET_DEVICE_PROP_DESC                  0x1014</span><br><span class="hljs-comment">				* MTP_OPERATION_GET_DEVICE_PROP_VALUE                 0x1015</span><br><span class="hljs-comment">				* MTP_OPERATION_SET_DEVICE_PROP_VALUE                 0x1016</span><br><span class="hljs-comment">				* MTP_OPERATION_RESET_DEVICE_PROP_VALUE               0x1017</span><br><span class="hljs-comment">				* MTP_OPERATION_SET_OBJECT_PROP_VALUE                 0x9804</span><br><span class="hljs-comment">				* MTP_OPERATION_SET_OBJECT_PROP_LIST                  0x9806</span><br><span class="hljs-comment">				*/</span><br>				<span class="hljs-keyword">if</span> (mtp.operation_code == <span class="hljs-number">0x100b</span> || mtp.operation_code == <span class="hljs-number">0x100c</span> || mtp.operation_code == <span class="hljs-number">0x100d</span> || mtp.operation_code == <span class="hljs-number">0x100f</span> || mtp.operation_code == <span class="hljs-number">0x9804</span> || mtp.operation_code == <span class="hljs-number">0x9806</span>) &#123;<br>					ret = <span class="hljs-literal">false</span>;<br>				&#125;<br>			&#125;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_do_submiturb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-keyword">struct</span> usbdevfs_urb *uurb,</span><br><span class="hljs-params">			<span class="hljs-keyword">struct</span> usbdevfs_iso_packet_desc __user *iso_frame_desc,</span><br><span class="hljs-params">			<span class="hljs-type">void</span> __user *arg, <span class="hljs-type">sigval_t</span> userurb_sigval)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_iso_packet_desc</span> *<span class="hljs-title">isopkt</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_endpoint</span> *<span class="hljs-title">ep</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_ctrlrequest</span> *<span class="hljs-title">dr</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> u, totlen, isofrmlen;<br>	<span class="hljs-type">int</span> i, ret, num_sgs = <span class="hljs-number">0</span>, ifnum = <span class="hljs-number">-1</span>;<br>	<span class="hljs-type">int</span> number_of_packets = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> stream_id = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">void</span> *buf;<br>	<span class="hljs-type">bool</span> is_in;<br>	<span class="hljs-type">bool</span> allow_short = <span class="hljs-literal">false</span>;<br>	<span class="hljs-type">bool</span> allow_zero = <span class="hljs-literal">false</span>;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> mask =	USBDEVFS_URB_SHORT_NOT_OK |<br>				USBDEVFS_URB_BULK_CONTINUATION |<br>				USBDEVFS_URB_NO_FSBR |<br>				USBDEVFS_URB_ZERO_PACKET |<br>				USBDEVFS_URB_NO_INTERRUPT;<br>	<span class="hljs-comment">/* USBDEVFS_URB_ISO_ASAP is a special case */</span><br>	<span class="hljs-keyword">if</span> (uurb-&gt;type == USBDEVFS_URB_TYPE_ISO)<br>		mask |= USBDEVFS_URB_ISO_ASAP;<br><br>	<span class="hljs-keyword">if</span> (uurb-&gt;flags &amp; ~mask)<br>			<span class="hljs-keyword">return</span> -EINVAL;<br><br>	<span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)uurb-&gt;buffer_length &gt;= USBFS_XFER_MAX)<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	<span class="hljs-keyword">if</span> (uurb-&gt;buffer_length &gt; <span class="hljs-number">0</span> &amp;&amp; !uurb-&gt;buffer)<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	<span class="hljs-keyword">if</span> (!(uurb-&gt;type == USBDEVFS_URB_TYPE_CONTROL &amp;&amp;<br>	    (uurb-&gt;endpoint &amp; ~USB_ENDPOINT_DIR_MASK) == <span class="hljs-number">0</span>)) &#123;<br>		ifnum = findintfep(ps-&gt;dev, uurb-&gt;endpoint);<br>		<span class="hljs-keyword">if</span> (ifnum &lt; <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">return</span> ifnum;<br>		ret = checkintf(ps, ifnum);<br>		<span class="hljs-keyword">if</span> (ret)<br>			<span class="hljs-keyword">return</span> ret;<br>	&#125;<br>	ep = ep_to_host_endpoint(ps-&gt;dev, uurb-&gt;endpoint);<br>	<span class="hljs-keyword">if</span> (!ep)<br>		<span class="hljs-keyword">return</span> -ENOENT;<br>	is_in = (uurb-&gt;endpoint &amp; USB_ENDPOINT_DIR_MASK) != <span class="hljs-number">0</span>;<br><br>	u = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">switch</span> (uurb-&gt;type) &#123;<br>	<span class="hljs-keyword">case</span> USBDEVFS_URB_TYPE_CONTROL:<br>		<span class="hljs-keyword">if</span> (is_in)<br>			allow_short = <span class="hljs-literal">true</span>;<br>		<span class="hljs-keyword">if</span> (!usb_endpoint_xfer_control(&amp;ep-&gt;desc))<br>			<span class="hljs-keyword">return</span> -EINVAL;<br>		<span class="hljs-comment">/* min 8 byte setup packet */</span><br>		<span class="hljs-keyword">if</span> (uurb-&gt;buffer_length &lt; <span class="hljs-number">8</span>)<br>			<span class="hljs-keyword">return</span> -EINVAL;<br>		dr = kmalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_ctrlrequest), GFP_KERNEL);<br>		<span class="hljs-keyword">if</span> (!dr)<br>			<span class="hljs-keyword">return</span> -ENOMEM;<br>		<span class="hljs-keyword">if</span> (copy_from_user(dr, uurb-&gt;buffer, <span class="hljs-number">8</span>)) &#123;<br>			ret = -EFAULT;<br>			<span class="hljs-keyword">goto</span> error;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (uurb-&gt;buffer_length &lt; (le16_to_cpu(dr-&gt;wLength) + <span class="hljs-number">8</span>)) &#123;<br>			ret = -EINVAL;<br>			<span class="hljs-keyword">goto</span> error;<br>		&#125;<br>		ret = check_ctrlrecip(ps, dr-&gt;bRequestType, dr-&gt;bRequest,<br>				      le16_to_cpu(dr-&gt;wIndex));<br>		<span class="hljs-keyword">if</span> (ret)<br>			<span class="hljs-keyword">goto</span> error;<br>		uurb-&gt;buffer_length = le16_to_cpu(dr-&gt;wLength);<br>		uurb-&gt;buffer += <span class="hljs-number">8</span>;<br>		<span class="hljs-keyword">if</span> ((dr-&gt;bRequestType &amp; USB_DIR_IN) &amp;&amp; uurb-&gt;buffer_length) &#123;<br>			is_in = <span class="hljs-literal">true</span>;<br>			uurb-&gt;endpoint |= USB_DIR_IN;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			is_in = <span class="hljs-literal">false</span>;<br>			uurb-&gt;endpoint &amp;= ~USB_DIR_IN;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (is_in)<br>			allow_short = <span class="hljs-literal">true</span>;<br>		snoop(&amp;ps-&gt;dev-&gt;dev, <span class="hljs-string">&quot;control urb: bRequestType=%02x &quot;</span><br>			<span class="hljs-string">&quot;bRequest=%02x wValue=%04x &quot;</span><br>			<span class="hljs-string">&quot;wIndex=%04x wLength=%04x\n&quot;</span>,<br>			dr-&gt;bRequestType, dr-&gt;bRequest,<br>			__le16_to_cpu(dr-&gt;wValue),<br>			__le16_to_cpu(dr-&gt;wIndex),<br>			__le16_to_cpu(dr-&gt;wLength));<br>		u = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_ctrlrequest);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_URB_TYPE_BULK:<br>		<span class="hljs-keyword">if</span> (!is_in)<br>			allow_zero = <span class="hljs-literal">true</span>;<br>		<span class="hljs-keyword">else</span><br>			allow_short = <span class="hljs-literal">true</span>;<br>		<span class="hljs-keyword">switch</span> (usb_endpoint_type(&amp;ep-&gt;desc)) &#123;<br>		<span class="hljs-keyword">case</span> USB_ENDPOINT_XFER_CONTROL:<br>		<span class="hljs-keyword">case</span> USB_ENDPOINT_XFER_ISOC:<br>			<span class="hljs-keyword">return</span> -EINVAL;<br>		<span class="hljs-keyword">case</span> USB_ENDPOINT_XFER_INT:<br>			<span class="hljs-comment">/* allow single-shot interrupt transfers */</span><br>			uurb-&gt;type = USBDEVFS_URB_TYPE_INTERRUPT;<br>			<span class="hljs-keyword">goto</span> interrupt_urb;<br>		&#125;<br>		num_sgs = DIV_ROUND_UP(uurb-&gt;buffer_length, USB_SG_SIZE);<br>		<span class="hljs-keyword">if</span> (num_sgs == <span class="hljs-number">1</span> || num_sgs &gt; ps-&gt;dev-&gt;bus-&gt;sg_tablesize)<br>			num_sgs = <span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">if</span> (ep-&gt;streams)<br>			stream_id = uurb-&gt;stream_id;<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_URB_TYPE_INTERRUPT:<br>		<span class="hljs-keyword">if</span> (!usb_endpoint_xfer_int(&amp;ep-&gt;desc))<br>			<span class="hljs-keyword">return</span> -EINVAL;<br> interrupt_urb:<br>		<span class="hljs-keyword">if</span> (!is_in)<br>			allow_zero = <span class="hljs-literal">true</span>;<br>		<span class="hljs-keyword">else</span><br>			allow_short = <span class="hljs-literal">true</span>;<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_URB_TYPE_ISO:<br>		<span class="hljs-comment">/* arbitrary limit */</span><br>		<span class="hljs-keyword">if</span> (uurb-&gt;number_of_packets &lt; <span class="hljs-number">1</span> ||<br>		    uurb-&gt;number_of_packets &gt; <span class="hljs-number">128</span>)<br>			<span class="hljs-keyword">return</span> -EINVAL;<br>		<span class="hljs-keyword">if</span> (!usb_endpoint_xfer_isoc(&amp;ep-&gt;desc))<br>			<span class="hljs-keyword">return</span> -EINVAL;<br>		number_of_packets = uurb-&gt;number_of_packets;<br>		isofrmlen = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usbdevfs_iso_packet_desc) *<br>				   number_of_packets;<br>		isopkt = memdup_user(iso_frame_desc, isofrmlen);<br>		<span class="hljs-keyword">if</span> (IS_ERR(isopkt)) &#123;<br>			ret = PTR_ERR(isopkt);<br>			isopkt = <span class="hljs-literal">NULL</span>;<br>			<span class="hljs-keyword">goto</span> error;<br>		&#125;<br>		<span class="hljs-keyword">for</span> (totlen = u = <span class="hljs-number">0</span>; u &lt; number_of_packets; u++) &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * arbitrary limit need for USB 3.1 Gen2</span><br><span class="hljs-comment">			 * sizemax: 96 DPs at SSP, 96 * 1024 = 98304</span><br><span class="hljs-comment">			 */</span><br>			<span class="hljs-keyword">if</span> (isopkt[u].length &gt; <span class="hljs-number">98304</span>) &#123;<br>				ret = -EINVAL;<br>				<span class="hljs-keyword">goto</span> error;<br>			&#125;<br>			totlen += isopkt[u].length;<br>		&#125;<br>		u *= <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> usb_iso_packet_descriptor);<br>		uurb-&gt;buffer_length = totlen;<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">default</span>:<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (uurb-&gt;buffer_length &gt; <span class="hljs-number">0</span> &amp;&amp;<br>			!access_ok(uurb-&gt;buffer, uurb-&gt;buffer_length)) &#123;<br>		ret = -EFAULT;<br>		<span class="hljs-keyword">goto</span> error;<br>	&#125;<br>	as = alloc_async(number_of_packets);<br>	<span class="hljs-keyword">if</span> (!as) &#123;<br>		ret = -ENOMEM;<br>		<span class="hljs-keyword">goto</span> error;<br>	&#125;<br><br>	as-&gt;usbm = find_memory_area(ps, uurb);<br>	<span class="hljs-keyword">if</span> (IS_ERR(as-&gt;usbm)) &#123;<br>		ret = PTR_ERR(as-&gt;usbm);<br>		as-&gt;usbm = <span class="hljs-literal">NULL</span>;<br>		<span class="hljs-keyword">goto</span> error;<br>	&#125;<br><br>	<span class="hljs-comment">/* do not use SG buffers when memory mapped segments</span><br><span class="hljs-comment">	 * are in use</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (as-&gt;usbm)<br>		num_sgs = <span class="hljs-number">0</span>;<br><br>	u += <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> async) + <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> urb) +<br>	     (as-&gt;usbm ? <span class="hljs-number">0</span> : uurb-&gt;buffer_length) +<br>	     num_sgs * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> scatterlist);<br>	ret = usbfs_increase_memory_usage(u);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">goto</span> error;<br>	as-&gt;mem_usage = u;<br><br>	<span class="hljs-keyword">if</span> (num_sgs) &#123;<br>		as-&gt;urb-&gt;sg = kmalloc_array(num_sgs,<br>					    <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> scatterlist),<br>					    GFP_KERNEL | __GFP_NOWARN);<br>		<span class="hljs-keyword">if</span> (!as-&gt;urb-&gt;sg) &#123;<br>			ret = -ENOMEM;<br>			<span class="hljs-keyword">goto</span> error;<br>		&#125;<br>		as-&gt;urb-&gt;num_sgs = num_sgs;<br>		sg_init_table(as-&gt;urb-&gt;sg, as-&gt;urb-&gt;num_sgs);<br><br>		totlen = uurb-&gt;buffer_length;<br>		<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; as-&gt;urb-&gt;num_sgs; i++) &#123;<br>			u = (totlen &gt; USB_SG_SIZE) ? USB_SG_SIZE : totlen;<br>			buf = kmalloc(u, GFP_KERNEL);<br>			<span class="hljs-keyword">if</span> (!buf) &#123;<br>				ret = -ENOMEM;<br>				<span class="hljs-keyword">goto</span> error;<br>			&#125;<br>			sg_set_buf(&amp;as-&gt;urb-&gt;sg[i], buf, u);<br><br>			<span class="hljs-keyword">if</span> (!is_in) &#123;<br>				<span class="hljs-keyword">if</span> (copy_from_user(buf, uurb-&gt;buffer, u)) &#123;<br>					ret = -EFAULT;<br>					<span class="hljs-keyword">goto</span> error;<br>				&#125;<br>				uurb-&gt;buffer += u;<br>			&#125;<br>			totlen -= u;<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uurb-&gt;buffer_length &gt; <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-keyword">if</span> (as-&gt;usbm) &#123;<br>			<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> uurb_start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)uurb-&gt;buffer;<br><br>			as-&gt;urb-&gt;transfer_buffer = as-&gt;usbm-&gt;mem +<br>					(uurb_start - as-&gt;usbm-&gt;vm_start);<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			as-&gt;urb-&gt;transfer_buffer = kmalloc(uurb-&gt;buffer_length,<br>					GFP_KERNEL | __GFP_NOWARN);<br>			<span class="hljs-keyword">if</span> (!as-&gt;urb-&gt;transfer_buffer) &#123;<br>				ret = -ENOMEM;<br>				<span class="hljs-keyword">goto</span> error;<br>			&#125;<br>			<span class="hljs-keyword">if</span> (!is_in) &#123;<br>				<span class="hljs-keyword">if</span> (copy_from_user(as-&gt;urb-&gt;transfer_buffer,<br>						   uurb-&gt;buffer,<br>						   uurb-&gt;buffer_length)) &#123;<br>					ret = -EFAULT;<br>					<span class="hljs-keyword">goto</span> error;<br>				&#125;<br>			&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uurb-&gt;type == USBDEVFS_URB_TYPE_ISO) &#123;<br>				<span class="hljs-comment">/*</span><br><span class="hljs-comment">				 * Isochronous input data may end up being</span><br><span class="hljs-comment">				 * discontiguous if some of the packets are</span><br><span class="hljs-comment">				 * short. Clear the buffer so that the gaps</span><br><span class="hljs-comment">				 * don&#x27;t leak kernel data to userspace.</span><br><span class="hljs-comment">				 */</span><br>				<span class="hljs-built_in">memset</span>(as-&gt;urb-&gt;transfer_buffer, <span class="hljs-number">0</span>,<br>						uurb-&gt;buffer_length);<br>			&#125;<br>		&#125;<br>	&#125;<br>	as-&gt;urb-&gt;dev = ps-&gt;dev;<br>	as-&gt;urb-&gt;pipe = (uurb-&gt;type &lt;&lt; <span class="hljs-number">30</span>) |<br>			__create_pipe(ps-&gt;dev, uurb-&gt;endpoint &amp; <span class="hljs-number">0xf</span>) |<br>			(uurb-&gt;endpoint &amp; USB_DIR_IN);<br><br>	<span class="hljs-comment">/* This tedious sequence is necessary because the URB_* flags</span><br><span class="hljs-comment">	 * are internal to the kernel and subject to change, whereas</span><br><span class="hljs-comment">	 * the USBDEVFS_URB_* flags are a user API and must not be changed.</span><br><span class="hljs-comment">	 */</span><br>	u = (is_in ? URB_DIR_IN : URB_DIR_OUT);<br>	<span class="hljs-keyword">if</span> (uurb-&gt;flags &amp; USBDEVFS_URB_ISO_ASAP)<br>		u |= URB_ISO_ASAP;<br>	<span class="hljs-keyword">if</span> (allow_short &amp;&amp; uurb-&gt;flags &amp; USBDEVFS_URB_SHORT_NOT_OK)<br>		u |= URB_SHORT_NOT_OK;<br>	<span class="hljs-keyword">if</span> (allow_zero &amp;&amp; uurb-&gt;flags &amp; USBDEVFS_URB_ZERO_PACKET)<br>		u |= URB_ZERO_PACKET;<br>	<span class="hljs-keyword">if</span> (uurb-&gt;flags &amp; USBDEVFS_URB_NO_INTERRUPT)<br>		u |= URB_NO_INTERRUPT;<br>	as-&gt;urb-&gt;transfer_flags = u;<br><br>	<span class="hljs-keyword">if</span> (!allow_short &amp;&amp; uurb-&gt;flags &amp; USBDEVFS_URB_SHORT_NOT_OK)<br>		dev_warn(&amp;ps-&gt;dev-&gt;dev, <span class="hljs-string">&quot;Requested nonsensical USBDEVFS_URB_SHORT_NOT_OK.\n&quot;</span>);<br>	<span class="hljs-keyword">if</span> (!allow_zero &amp;&amp; uurb-&gt;flags &amp; USBDEVFS_URB_ZERO_PACKET)<br>		dev_warn(&amp;ps-&gt;dev-&gt;dev, <span class="hljs-string">&quot;Requested nonsensical USBDEVFS_URB_ZERO_PACKET.\n&quot;</span>);<br><br>	as-&gt;urb-&gt;transfer_buffer_length = uurb-&gt;buffer_length;<br>	as-&gt;urb-&gt;setup_packet = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *)dr;<br>	dr = <span class="hljs-literal">NULL</span>;<br>	as-&gt;urb-&gt;start_frame = uurb-&gt;start_frame;<br>	as-&gt;urb-&gt;number_of_packets = number_of_packets;<br>	as-&gt;urb-&gt;stream_id = stream_id;<br><br>	<span class="hljs-keyword">if</span> (ep-&gt;desc.bInterval) &#123;<br>		<span class="hljs-keyword">if</span> (uurb-&gt;type == USBDEVFS_URB_TYPE_ISO ||<br>				ps-&gt;dev-&gt;speed == USB_SPEED_HIGH ||<br>				ps-&gt;dev-&gt;speed &gt;= USB_SPEED_SUPER)<br>			as-&gt;urb-&gt;interval = <span class="hljs-number">1</span> &lt;&lt;<br>					min(<span class="hljs-number">15</span>, ep-&gt;desc.bInterval - <span class="hljs-number">1</span>);<br>		<span class="hljs-keyword">else</span><br>			as-&gt;urb-&gt;interval = ep-&gt;desc.bInterval;<br>	&#125;<br><br>	as-&gt;urb-&gt;context = as;<br>	as-&gt;urb-&gt;complete = async_completed;<br>	<span class="hljs-keyword">for</span> (totlen = u = <span class="hljs-number">0</span>; u &lt; number_of_packets; u++) &#123;<br>		as-&gt;urb-&gt;iso_frame_desc[u].offset = totlen;<br>		as-&gt;urb-&gt;iso_frame_desc[u].length = isopkt[u].length;<br>		totlen += isopkt[u].length;<br>	&#125;<br>	kfree(isopkt);<br>	isopkt = <span class="hljs-literal">NULL</span>;<br>	as-&gt;ps = ps;<br>	as-&gt;userurb = arg;<br>	as-&gt;userurb_sigval = userurb_sigval;<br>	<span class="hljs-keyword">if</span> (as-&gt;usbm) &#123;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> uurb_start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)uurb-&gt;buffer;<br><br>		as-&gt;urb-&gt;transfer_flags |= URB_NO_TRANSFER_DMA_MAP;<br>		as-&gt;urb-&gt;transfer_dma = as-&gt;usbm-&gt;dma_handle +<br>				(uurb_start - as-&gt;usbm-&gt;vm_start);<br>	&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (is_in &amp;&amp; uurb-&gt;buffer_length &gt; <span class="hljs-number">0</span>)<br>		as-&gt;userbuffer = uurb-&gt;buffer;<br>	as-&gt;signr = uurb-&gt;signr;<br>	as-&gt;ifnum = ifnum;<br>	as-&gt;pid = get_pid(task_pid(current));<br>	as-&gt;cred = get_current_cred();<br>	snoop_urb(ps-&gt;dev, as-&gt;userurb, as-&gt;urb-&gt;pipe,<br>			as-&gt;urb-&gt;transfer_buffer_length, <span class="hljs-number">0</span>, SUBMIT,<br>			<span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (!is_in)<br>		snoop_urb_data(as-&gt;urb, as-&gt;urb-&gt;transfer_buffer_length);<br><br>	async_newpending(as);<br><br>	<span class="hljs-keyword">if</span> (usb_endpoint_xfer_bulk(&amp;ep-&gt;desc)) &#123;<br>		spin_lock_irq(&amp;ps-&gt;lock);<br><br>		<span class="hljs-comment">/* Not exactly the endpoint address; the direction bit is</span><br><span class="hljs-comment">		 * shifted to the 0x10 position so that the value will be</span><br><span class="hljs-comment">		 * between 0 and 31.</span><br><span class="hljs-comment">		 */</span><br>		as-&gt;bulk_addr = usb_endpoint_num(&amp;ep-&gt;desc) |<br>			((ep-&gt;desc.bEndpointAddress &amp; USB_ENDPOINT_DIR_MASK)<br>				&gt;&gt; <span class="hljs-number">3</span>);<br><br>		<span class="hljs-comment">/* If this bulk URB is the start of a new transfer, re-enable</span><br><span class="hljs-comment">		 * the endpoint.  Otherwise mark it as a continuation URB.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (uurb-&gt;flags &amp; USBDEVFS_URB_BULK_CONTINUATION)<br>			as-&gt;bulk_status = AS_CONTINUATION;<br>		<span class="hljs-keyword">else</span><br>			ps-&gt;disabled_bulk_eps &amp;= ~(<span class="hljs-number">1</span> &lt;&lt; as-&gt;bulk_addr);<br><br>		<span class="hljs-comment">/* Don&#x27;t accept continuation URBs if the endpoint is</span><br><span class="hljs-comment">		 * disabled because of an earlier error.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (ps-&gt;disabled_bulk_eps &amp; (<span class="hljs-number">1</span> &lt;&lt; as-&gt;bulk_addr))<br>			ret = -EREMOTEIO;<br>		<span class="hljs-keyword">else</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_HUAWEI_ARMPC_SMART_USB</span><br>		&#123;<br>			<span class="hljs-keyword">if</span> (!hw_check_phone_read_access(ps-&gt;dev, ifnum, uurb-&gt;buffer))&#123;<br>				ret = -EACCES;<br>			&#125;<br>			<span class="hljs-keyword">else</span> &#123;<br>				ret = usb_submit_urb(as-&gt;urb, GFP_ATOMIC);<br>			&#125;<br>		&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>		ret = usb_submit_urb(as-&gt;urb, GFP_ATOMIC);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>		spin_unlock_irq(&amp;ps-&gt;lock);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		ret = usb_submit_urb(as-&gt;urb, GFP_KERNEL);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (ret) &#123;<br>		dev_printk(KERN_DEBUG, &amp;ps-&gt;dev-&gt;dev,<br>			   <span class="hljs-string">&quot;usbfs: usb_submit_urb returned %d\n&quot;</span>, ret);<br>		snoop_urb(ps-&gt;dev, as-&gt;userurb, as-&gt;urb-&gt;pipe,<br>				<span class="hljs-number">0</span>, ret, COMPLETE, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>		async_removepending(as);<br>		<span class="hljs-keyword">goto</span> error;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br> error:<br>	kfree(isopkt);<br>	kfree(dr);<br>	<span class="hljs-keyword">if</span> (as)<br>		free_async(as);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_submiturb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_urb</span> <span class="hljs-title">uurb</span>;</span><br>	<span class="hljs-type">sigval_t</span> userurb_sigval;<br><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;uurb, arg, <span class="hljs-keyword">sizeof</span>(uurb)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	<span class="hljs-built_in">memset</span>(&amp;userurb_sigval, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(userurb_sigval));<br>	userurb_sigval.sival_ptr = arg;<br><br>	<span class="hljs-keyword">return</span> proc_do_submiturb(ps, &amp;uurb,<br>			(((<span class="hljs-keyword">struct</span> usbdevfs_urb __user *)arg)-&gt;iso_frame_desc),<br>			arg, userurb_sigval);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_unlinkurb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">urb</span> *<span class="hljs-title">urb</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br><br>	spin_lock_irqsave(&amp;ps-&gt;lock, flags);<br>	as = async_getpending(ps, arg);<br>	<span class="hljs-keyword">if</span> (!as) &#123;<br>		spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br>		<span class="hljs-keyword">return</span> -EINVAL;<br>	&#125;<br><br>	urb = as-&gt;urb;<br>	usb_get_urb(urb);<br>	spin_unlock_irqrestore(&amp;ps-&gt;lock, flags);<br><br>	usb_kill_urb(urb);<br>	usb_put_urb(urb);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">compute_isochronous_actual_length</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> urb *urb)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i;<br><br>	<span class="hljs-keyword">if</span> (urb-&gt;number_of_packets &gt; <span class="hljs-number">0</span>) &#123;<br>		urb-&gt;actual_length = <span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; urb-&gt;number_of_packets; i++)<br>			urb-&gt;actual_length +=<br>					urb-&gt;iso_frame_desc[i].actual_length;<br>	&#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">processcompl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> async *as, <span class="hljs-type">void</span> __user * __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">urb</span> *<span class="hljs-title">urb</span> =</span> as-&gt;urb;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_urb</span> __<span class="hljs-title">user</span> *<span class="hljs-title">userurb</span> =</span> as-&gt;userurb;<br>	<span class="hljs-type">void</span> __user *addr = as-&gt;userurb;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i;<br><br>	compute_isochronous_actual_length(urb);<br>	<span class="hljs-keyword">if</span> (as-&gt;userbuffer &amp;&amp; urb-&gt;actual_length) &#123;<br>		<span class="hljs-keyword">if</span> (copy_urb_data_to_user(as-&gt;userbuffer, urb))<br>			<span class="hljs-keyword">goto</span> err_out;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (put_user(as-&gt;status, &amp;userurb-&gt;status))<br>		<span class="hljs-keyword">goto</span> err_out;<br>	<span class="hljs-keyword">if</span> (put_user(urb-&gt;actual_length, &amp;userurb-&gt;actual_length))<br>		<span class="hljs-keyword">goto</span> err_out;<br>	<span class="hljs-keyword">if</span> (put_user(urb-&gt;error_count, &amp;userurb-&gt;error_count))<br>		<span class="hljs-keyword">goto</span> err_out;<br><br>	<span class="hljs-keyword">if</span> (usb_endpoint_xfer_isoc(&amp;urb-&gt;ep-&gt;desc)) &#123;<br>		<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; urb-&gt;number_of_packets; i++) &#123;<br>			<span class="hljs-keyword">if</span> (put_user(urb-&gt;iso_frame_desc[i].actual_length,<br>				     &amp;userurb-&gt;iso_frame_desc[i].actual_length))<br>				<span class="hljs-keyword">goto</span> err_out;<br>			<span class="hljs-keyword">if</span> (put_user(urb-&gt;iso_frame_desc[i].status,<br>				     &amp;userurb-&gt;iso_frame_desc[i].status))<br>				<span class="hljs-keyword">goto</span> err_out;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (put_user(addr, (<span class="hljs-type">void</span> __user * __user *)arg))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err_out:<br>	<span class="hljs-keyword">return</span> -EFAULT;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> async *<span class="hljs-title function_">reap_as</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps)</span><br>&#123;<br>	DECLARE_WAITQUEUE(wait, current);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">dev</span> =</span> ps-&gt;dev;<br><br>	add_wait_queue(&amp;ps-&gt;wait, &amp;wait);<br>	<span class="hljs-keyword">for</span> (;;) &#123;<br>		__set_current_state(TASK_INTERRUPTIBLE);<br>		as = async_getcompleted(ps);<br>		<span class="hljs-keyword">if</span> (as || !connected(ps))<br>			<span class="hljs-keyword">break</span>;<br>		<span class="hljs-keyword">if</span> (signal_pending(current))<br>			<span class="hljs-keyword">break</span>;<br>		usb_unlock_device(dev);<br>		schedule();<br>		usb_lock_device(dev);<br>	&#125;<br>	remove_wait_queue(&amp;ps-&gt;wait, &amp;wait);<br>	set_current_state(TASK_RUNNING);<br>	<span class="hljs-keyword">return</span> as;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_reapurb</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span> =</span> reap_as(ps);<br><br>	<span class="hljs-keyword">if</span> (as) &#123;<br>		<span class="hljs-type">int</span> retval;<br><br>		snoop(&amp;ps-&gt;dev-&gt;dev, <span class="hljs-string">&quot;reap %px\n&quot;</span>, as-&gt;userurb);<br>		retval = processcompl(as, (<span class="hljs-type">void</span> __user * __user *)arg);<br>		free_async(as);<br>		<span class="hljs-keyword">return</span> retval;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (signal_pending(current))<br>		<span class="hljs-keyword">return</span> -EINTR;<br>	<span class="hljs-keyword">return</span> -ENODEV;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_reapurbnonblock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-type">int</span> retval;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span>;</span><br><br>	as = async_getcompleted(ps);<br>	<span class="hljs-keyword">if</span> (as) &#123;<br>		snoop(&amp;ps-&gt;dev-&gt;dev, <span class="hljs-string">&quot;reap %px\n&quot;</span>, as-&gt;userurb);<br>		retval = processcompl(as, (<span class="hljs-type">void</span> __user * __user *)arg);<br>		free_async(as);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		retval = (connected(ps) ? -EAGAIN : -ENODEV);<br>	&#125;<br>	<span class="hljs-keyword">return</span> retval;<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_control_compat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps,</span><br><span class="hljs-params">				<span class="hljs-keyword">struct</span> usbdevfs_ctrltransfer32 __user *p32)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_ctrltransfer</span> <span class="hljs-title">ctrl</span>;</span><br>	u32 udata;<br><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;ctrl, p32, <span class="hljs-keyword">sizeof</span>(*p32) - <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">compat_caddr_t</span>)) ||<br>	    get_user(udata, &amp;p32-&gt;data))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	ctrl.data = compat_ptr(udata);<br>	<span class="hljs-keyword">return</span> do_proc_control(ps, &amp;ctrl);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_bulk_compat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps,</span><br><span class="hljs-params">			<span class="hljs-keyword">struct</span> usbdevfs_bulktransfer32 __user *p32)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_bulktransfer</span> <span class="hljs-title">bulk</span>;</span><br>	<span class="hljs-type">compat_caddr_t</span> addr;<br><br>	<span class="hljs-keyword">if</span> (get_user(bulk.ep, &amp;p32-&gt;ep) ||<br>	    get_user(bulk.len, &amp;p32-&gt;len) ||<br>	    get_user(bulk.timeout, &amp;p32-&gt;timeout) ||<br>	    get_user(addr, &amp;p32-&gt;data))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	bulk.data = compat_ptr(addr);<br>	<span class="hljs-keyword">return</span> do_proc_bulk(ps, &amp;bulk);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_disconnectsignal_compat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_disconnectsignal32</span> <span class="hljs-title">ds</span>;</span><br><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;ds, arg, <span class="hljs-keyword">sizeof</span>(ds)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	ps-&gt;discsignr = ds.signr;<br>	ps-&gt;disccontext.sival_int = ds.context;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">get_urb32</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usbdevfs_urb *kurb,</span><br><span class="hljs-params">		     <span class="hljs-keyword">struct</span> usbdevfs_urb32 __user *uurb)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_urb32</span> <span class="hljs-title">urb32</span>;</span><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;urb32, uurb, <span class="hljs-keyword">sizeof</span>(*uurb)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	kurb-&gt;type = urb32.type;<br>	kurb-&gt;endpoint = urb32.endpoint;<br>	kurb-&gt;status = urb32.status;<br>	kurb-&gt;flags = urb32.flags;<br>	kurb-&gt;buffer = compat_ptr(urb32.buffer);<br>	kurb-&gt;buffer_length = urb32.buffer_length;<br>	kurb-&gt;actual_length = urb32.actual_length;<br>	kurb-&gt;start_frame = urb32.start_frame;<br>	kurb-&gt;number_of_packets = urb32.number_of_packets;<br>	kurb-&gt;error_count = urb32.error_count;<br>	kurb-&gt;signr = urb32.signr;<br>	kurb-&gt;usercontext = compat_ptr(urb32.usercontext);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_submiturb_compat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_urb</span> <span class="hljs-title">uurb</span>;</span><br>	<span class="hljs-type">sigval_t</span> userurb_sigval;<br><br>	<span class="hljs-keyword">if</span> (get_urb32(&amp;uurb, (<span class="hljs-keyword">struct</span> usbdevfs_urb32 __user *)arg))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	<span class="hljs-built_in">memset</span>(&amp;userurb_sigval, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(userurb_sigval));<br>	userurb_sigval.sival_int = ptr_to_compat(arg);<br><br>	<span class="hljs-keyword">return</span> proc_do_submiturb(ps, &amp;uurb,<br>			((<span class="hljs-keyword">struct</span> usbdevfs_urb32 __user *)arg)-&gt;iso_frame_desc,<br>			arg, userurb_sigval);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">processcompl_compat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> async *as, <span class="hljs-type">void</span> __user * __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">urb</span> *<span class="hljs-title">urb</span> =</span> as-&gt;urb;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_urb32</span> __<span class="hljs-title">user</span> *<span class="hljs-title">userurb</span> =</span> as-&gt;userurb;<br>	<span class="hljs-type">void</span> __user *addr = as-&gt;userurb;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i;<br><br>	compute_isochronous_actual_length(urb);<br>	<span class="hljs-keyword">if</span> (as-&gt;userbuffer &amp;&amp; urb-&gt;actual_length) &#123;<br>		<span class="hljs-keyword">if</span> (copy_urb_data_to_user(as-&gt;userbuffer, urb))<br>			<span class="hljs-keyword">return</span> -EFAULT;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (put_user(as-&gt;status, &amp;userurb-&gt;status))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	<span class="hljs-keyword">if</span> (put_user(urb-&gt;actual_length, &amp;userurb-&gt;actual_length))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	<span class="hljs-keyword">if</span> (put_user(urb-&gt;error_count, &amp;userurb-&gt;error_count))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	<span class="hljs-keyword">if</span> (usb_endpoint_xfer_isoc(&amp;urb-&gt;ep-&gt;desc)) &#123;<br>		<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; urb-&gt;number_of_packets; i++) &#123;<br>			<span class="hljs-keyword">if</span> (put_user(urb-&gt;iso_frame_desc[i].actual_length,<br>				     &amp;userurb-&gt;iso_frame_desc[i].actual_length))<br>				<span class="hljs-keyword">return</span> -EFAULT;<br>			<span class="hljs-keyword">if</span> (put_user(urb-&gt;iso_frame_desc[i].status,<br>				     &amp;userurb-&gt;iso_frame_desc[i].status))<br>				<span class="hljs-keyword">return</span> -EFAULT;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (put_user(ptr_to_compat(addr), (u32 __user *)arg))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_reapurb_compat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span> =</span> reap_as(ps);<br><br>	<span class="hljs-keyword">if</span> (as) &#123;<br>		<span class="hljs-type">int</span> retval;<br><br>		snoop(&amp;ps-&gt;dev-&gt;dev, <span class="hljs-string">&quot;reap %px\n&quot;</span>, as-&gt;userurb);<br>		retval = processcompl_compat(as, (<span class="hljs-type">void</span> __user * __user *)arg);<br>		free_async(as);<br>		<span class="hljs-keyword">return</span> retval;<br>	&#125;<br>	<span class="hljs-keyword">if</span> (signal_pending(current))<br>		<span class="hljs-keyword">return</span> -EINTR;<br>	<span class="hljs-keyword">return</span> -ENODEV;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_reapurbnonblock_compat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-type">int</span> retval;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">async</span> *<span class="hljs-title">as</span>;</span><br><br>	as = async_getcompleted(ps);<br>	<span class="hljs-keyword">if</span> (as) &#123;<br>		snoop(&amp;ps-&gt;dev-&gt;dev, <span class="hljs-string">&quot;reap %px\n&quot;</span>, as-&gt;userurb);<br>		retval = processcompl_compat(as, (<span class="hljs-type">void</span> __user * __user *)arg);<br>		free_async(as);<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		retval = (connected(ps) ? -EAGAIN : -ENODEV);<br>	&#125;<br>	<span class="hljs-keyword">return</span> retval;<br>&#125;<br><br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_disconnectsignal</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_disconnectsignal</span> <span class="hljs-title">ds</span>;</span><br><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;ds, arg, <span class="hljs-keyword">sizeof</span>(ds)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	ps-&gt;discsignr = ds.signr;<br>	ps-&gt;disccontext.sival_ptr = ds.context;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_claiminterface</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ifnum;<br><br>	<span class="hljs-keyword">if</span> (get_user(ifnum, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __user *)arg))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	<span class="hljs-keyword">return</span> claimintf(ps, ifnum);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_releaseinterface</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> ifnum;<br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (get_user(ifnum, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> __user *)arg))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	ret = releaseintf(ps, ifnum);<br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> ret;<br>	destroy_async_on_interface(ps, ifnum);<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-keyword">struct</span> usbdevfs_ioctl *ctl)</span><br>&#123;<br>	<span class="hljs-type">int</span>			size;<br>	<span class="hljs-type">void</span>			*buf = <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-type">int</span>			retval = <span class="hljs-number">0</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span>    *<span class="hljs-title">intf</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_driver</span>       *<span class="hljs-title">driver</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>	<span class="hljs-keyword">if</span> (ps-&gt;privileges_dropped)<br>		<span class="hljs-keyword">return</span> -EACCES;<br><br>	<span class="hljs-keyword">if</span> (!connected(ps))<br>		<span class="hljs-keyword">return</span> -ENODEV;<br><br>	<span class="hljs-comment">/* alloc buffer */</span><br>	size = _IOC_SIZE(ctl-&gt;ioctl_code);<br>	<span class="hljs-keyword">if</span> (size &gt; <span class="hljs-number">0</span>) &#123;<br>		buf = kmalloc(size, GFP_KERNEL);<br>		<span class="hljs-keyword">if</span> (buf == <span class="hljs-literal">NULL</span>)<br>			<span class="hljs-keyword">return</span> -ENOMEM;<br>		<span class="hljs-keyword">if</span> ((_IOC_DIR(ctl-&gt;ioctl_code) &amp; _IOC_WRITE)) &#123;<br>			<span class="hljs-keyword">if</span> (copy_from_user(buf, ctl-&gt;data, size)) &#123;<br>				kfree(buf);<br>				<span class="hljs-keyword">return</span> -EFAULT;<br>			&#125;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			<span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, size);<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (ps-&gt;dev-&gt;state != USB_STATE_CONFIGURED)<br>		retval = -EHOSTUNREACH;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(intf = usb_ifnum_to_if(ps-&gt;dev, ctl-&gt;ifno)))<br>		retval = -EINVAL;<br>	<span class="hljs-keyword">else</span> <span class="hljs-keyword">switch</span> (ctl-&gt;ioctl_code) &#123;<br><br>	<span class="hljs-comment">/* disconnect kernel driver from interface */</span><br>	<span class="hljs-keyword">case</span> USBDEVFS_DISCONNECT:<br>		<span class="hljs-keyword">if</span> (intf-&gt;dev.driver) &#123;<br>			driver = to_usb_driver(intf-&gt;dev.driver);<br>			dev_dbg(&amp;intf-&gt;dev, <span class="hljs-string">&quot;disconnect by usbfs\n&quot;</span>);<br>			usb_driver_release_interface(driver, intf);<br>		&#125; <span class="hljs-keyword">else</span><br>			retval = -ENODATA;<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-comment">/* let kernel drivers try to (re)bind to the interface */</span><br>	<span class="hljs-keyword">case</span> USBDEVFS_CONNECT:<br>		<span class="hljs-keyword">if</span> (!intf-&gt;dev.driver)<br>			retval = device_attach(&amp;intf-&gt;dev);<br>		<span class="hljs-keyword">else</span><br>			retval = -EBUSY;<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-comment">/* talk directly to the interface&#x27;s driver */</span><br>	<span class="hljs-keyword">default</span>:<br>		<span class="hljs-keyword">if</span> (intf-&gt;dev.driver)<br>			driver = to_usb_driver(intf-&gt;dev.driver);<br>		<span class="hljs-keyword">if</span> (driver == <span class="hljs-literal">NULL</span> || driver-&gt;unlocked_ioctl == <span class="hljs-literal">NULL</span>) &#123;<br>			retval = -ENOTTY;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			retval = driver-&gt;unlocked_ioctl(intf, ctl-&gt;ioctl_code, buf);<br>			<span class="hljs-keyword">if</span> (retval == -ENOIOCTLCMD)<br>				retval = -ENOTTY;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">/* cleanup and return */</span><br>	<span class="hljs-keyword">if</span> (retval &gt;= <span class="hljs-number">0</span><br>			&amp;&amp; (_IOC_DIR(ctl-&gt;ioctl_code) &amp; _IOC_READ) != <span class="hljs-number">0</span><br>			&amp;&amp; size &gt; <span class="hljs-number">0</span><br>			&amp;&amp; copy_to_user(ctl-&gt;data, buf, size) != <span class="hljs-number">0</span>)<br>		retval = -EFAULT;<br><br>	kfree(buf);<br>	<span class="hljs-keyword">return</span> retval;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_ioctl_default</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_ioctl</span>	<span class="hljs-title">ctrl</span>;</span><br><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;ctrl, arg, <span class="hljs-keyword">sizeof</span>(ctrl)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	<span class="hljs-keyword">return</span> proc_ioctl(ps, &amp;ctrl);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_ioctl_compat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">compat_uptr_t</span> arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_ioctl32</span> <span class="hljs-title">ioc32</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_ioctl</span> <span class="hljs-title">ctrl</span>;</span><br><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;ioc32, compat_ptr(arg), <span class="hljs-keyword">sizeof</span>(ioc32)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	ctrl.ifno = ioc32.ifno;<br>	ctrl.ioctl_code = ioc32.ioctl_code;<br>	ctrl.data = compat_ptr(ioc32.data);<br>	<span class="hljs-keyword">return</span> proc_ioctl(ps, &amp;ctrl);<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_claim_port</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> portnum;<br>	<span class="hljs-type">int</span> rc;<br><br>	<span class="hljs-keyword">if</span> (get_user(portnum, (<span class="hljs-type">unsigned</span> __user *) arg))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	rc = usb_hub_claim_port(ps-&gt;dev, portnum, ps);<br>	<span class="hljs-keyword">if</span> (rc == <span class="hljs-number">0</span>)<br>		snoop(&amp;ps-&gt;dev-&gt;dev, <span class="hljs-string">&quot;port %d claimed by process %d: %s\n&quot;</span>,<br>			portnum, task_pid_nr(current), current-&gt;comm);<br>	<span class="hljs-keyword">return</span> rc;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_release_port</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> portnum;<br><br>	<span class="hljs-keyword">if</span> (get_user(portnum, (<span class="hljs-type">unsigned</span> __user *) arg))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br>	<span class="hljs-keyword">return</span> usb_hub_release_port(ps-&gt;dev, portnum, ps);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_get_capabilities</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	__u32 caps;<br><br>	caps = USBDEVFS_CAP_ZERO_PACKET | USBDEVFS_CAP_NO_PACKET_SIZE_LIM |<br>			USBDEVFS_CAP_REAP_AFTER_DISCONNECT | USBDEVFS_CAP_MMAP |<br>			USBDEVFS_CAP_DROP_PRIVILEGES |<br>			USBDEVFS_CAP_CONNINFO_EX | MAYBE_CAP_SUSPEND;<br>	<span class="hljs-keyword">if</span> (!ps-&gt;dev-&gt;bus-&gt;no_stop_on_short)<br>		caps |= USBDEVFS_CAP_BULK_CONTINUATION;<br>	<span class="hljs-keyword">if</span> (ps-&gt;dev-&gt;bus-&gt;sg_tablesize)<br>		caps |= USBDEVFS_CAP_BULK_SCATTER_GATHER;<br><br>	<span class="hljs-keyword">if</span> (put_user(caps, (__u32 __user *)arg))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_disconnect_claim</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usbdevfs_disconnect_claim</span> <span class="hljs-title">dc</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">intf</span>;</span><br><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;dc, arg, <span class="hljs-keyword">sizeof</span>(dc)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	intf = usb_ifnum_to_if(ps-&gt;dev, dc.interface);<br>	<span class="hljs-keyword">if</span> (!intf)<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	<span class="hljs-keyword">if</span> (intf-&gt;dev.driver) &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_driver</span> *<span class="hljs-title">driver</span> =</span> to_usb_driver(intf-&gt;dev.driver);<br><br>		<span class="hljs-keyword">if</span> (ps-&gt;privileges_dropped)<br>			<span class="hljs-keyword">return</span> -EACCES;<br><br>		<span class="hljs-keyword">if</span> ((dc.flags &amp; USBDEVFS_DISCONNECT_CLAIM_IF_DRIVER) &amp;&amp;<br>				<span class="hljs-built_in">strncmp</span>(dc.driver, intf-&gt;dev.driver-&gt;name,<br>					<span class="hljs-keyword">sizeof</span>(dc.driver)) != <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">return</span> -EBUSY;<br><br>		<span class="hljs-keyword">if</span> ((dc.flags &amp; USBDEVFS_DISCONNECT_CLAIM_EXCEPT_DRIVER) &amp;&amp;<br>				<span class="hljs-built_in">strncmp</span>(dc.driver, intf-&gt;dev.driver-&gt;name,<br>					<span class="hljs-keyword">sizeof</span>(dc.driver)) == <span class="hljs-number">0</span>)<br>			<span class="hljs-keyword">return</span> -EBUSY;<br><br>		dev_dbg(&amp;intf-&gt;dev, <span class="hljs-string">&quot;disconnect by usbfs\n&quot;</span>);<br>		usb_driver_release_interface(driver, intf);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> claimintf(ps, dc.interface);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_alloc_streams</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> num_streams, num_eps;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_endpoint</span> **<span class="hljs-title">eps</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">intf</span>;</span><br>	<span class="hljs-type">int</span> r;<br><br>	r = parse_usbdevfs_streams(ps, arg, &amp;num_streams, &amp;num_eps,<br>				   &amp;eps, &amp;intf);<br>	<span class="hljs-keyword">if</span> (r)<br>		<span class="hljs-keyword">return</span> r;<br><br>	destroy_async_on_interface(ps,<br>				   intf-&gt;altsetting[<span class="hljs-number">0</span>].desc.bInterfaceNumber);<br><br>	r = usb_alloc_streams(intf, eps, num_eps, num_streams, GFP_KERNEL);<br>	kfree(eps);<br>	<span class="hljs-keyword">return</span> r;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_free_streams</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> num_eps;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_host_endpoint</span> **<span class="hljs-title">eps</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">intf</span>;</span><br>	<span class="hljs-type">int</span> r;<br><br>	r = parse_usbdevfs_streams(ps, arg, <span class="hljs-literal">NULL</span>, &amp;num_eps, &amp;eps, &amp;intf);<br>	<span class="hljs-keyword">if</span> (r)<br>		<span class="hljs-keyword">return</span> r;<br><br>	destroy_async_on_interface(ps,<br>				   intf-&gt;altsetting[<span class="hljs-number">0</span>].desc.bInterfaceNumber);<br><br>	r = usb_free_streams(intf, eps, num_eps, GFP_KERNEL);<br>	kfree(eps);<br>	<span class="hljs-keyword">return</span> r;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_drop_privileges</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br>	u32 data;<br><br>	<span class="hljs-keyword">if</span> (copy_from_user(&amp;data, arg, <span class="hljs-keyword">sizeof</span>(data)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	<span class="hljs-comment">/* This is a one way operation. Once privileges are</span><br><span class="hljs-comment">	 * dropped, you cannot regain them. You may however reissue</span><br><span class="hljs-comment">	 * this ioctl to shrink the allowed interfaces mask.</span><br><span class="hljs-comment">	 */</span><br>	ps-&gt;interface_allowed_mask &amp;= data;<br>	ps-&gt;privileges_dropped = <span class="hljs-literal">true</span>;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_forbid_suspend</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps)</span><br>&#123;<br>	<span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (ps-&gt;suspend_allowed) &#123;<br>		ret = usb_autoresume_device(ps-&gt;dev);<br>		<span class="hljs-keyword">if</span> (ret == <span class="hljs-number">0</span>)<br>			ps-&gt;suspend_allowed = <span class="hljs-literal">false</span>;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ret != -ENODEV)<br>			ret = -EIO;<br>	&#125;<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_allow_suspend</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps)</span><br>&#123;<br>	<span class="hljs-keyword">if</span> (!connected(ps))<br>		<span class="hljs-keyword">return</span> -ENODEV;<br><br>	WRITE_ONCE(ps-&gt;not_yet_resumed, <span class="hljs-number">1</span>);<br>	<span class="hljs-keyword">if</span> (!ps-&gt;suspend_allowed) &#123;<br>		usb_autosuspend_device(ps-&gt;dev);<br>		ps-&gt;suspend_allowed = <span class="hljs-literal">true</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">proc_wait_for_resume</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_dev_state *ps)</span><br>&#123;<br>	<span class="hljs-type">int</span> ret;<br><br>	usb_unlock_device(ps-&gt;dev);<br>	ret = wait_event_interruptible(ps-&gt;wait_for_resume,<br>			READ_ONCE(ps-&gt;not_yet_resumed) == <span class="hljs-number">0</span>);<br>	usb_lock_device(ps-&gt;dev);<br><br>	<span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>)<br>		<span class="hljs-keyword">return</span> -EINTR;<br>	<span class="hljs-keyword">return</span> proc_forbid_suspend(ps);<br>&#125;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * <span class="hljs-doctag">NOTE:</span>  All requests here that have interface numbers as parameters</span><br><span class="hljs-comment"> * are assuming that somehow the configuration has been prevented from</span><br><span class="hljs-comment"> * changing.  But there&#x27;s no mechanism to ensure that...</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">usbdev_do_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd,</span><br><span class="hljs-params">				<span class="hljs-type">void</span> __user *p)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span> =</span> file-&gt;private_data;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> file_inode(file);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_device</span> *<span class="hljs-title">dev</span> =</span> ps-&gt;dev;<br>	<span class="hljs-type">int</span> ret = -ENOTTY;<br><br><span class="hljs-comment">// #ifdef CONFIG_HUAWEI_ARMPC_SMART_USB</span><br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_interface</span> *<span class="hljs-title">intf</span>;</span><br>	<span class="hljs-type">int</span> i;<br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; (dev-&gt;actconfig != <span class="hljs-literal">NULL</span>) &amp;&amp; (i &lt; dev-&gt;actconfig-&gt;desc.bNumInterfaces); ++i) &#123;<br>		intf = dev-&gt;actconfig-&gt;interface[i];<br>		<span class="hljs-keyword">if</span> (check_storage_rejects_status(dev-&gt;devpath) &amp;&amp; (intf != <span class="hljs-literal">NULL</span>) &amp;&amp; (intf-&gt;cur_altsetting != <span class="hljs-literal">NULL</span>) &amp;&amp;<br>			(intf-&gt;cur_altsetting-&gt;desc.bInterfaceClass == USB_CLASS_MASS_STORAGE)) &#123;<br>			dev_info(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: devpath = %s bInterfaceClass %d is not authorized for access&quot;</span>,<br>				__func__, dev-&gt;devpath, intf-&gt;cur_altsetting-&gt;desc.bInterfaceClass);<br>			<span class="hljs-keyword">return</span> ret;<br>		&#125;<br>	&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	<span class="hljs-keyword">if</span> (!(file-&gt;f_mode &amp; FMODE_WRITE))<br>		<span class="hljs-keyword">return</span> -EPERM;<br><br>	usb_lock_device(dev);<br><br>	<span class="hljs-comment">/* Reap operations are allowed even after disconnection */</span><br>	<span class="hljs-keyword">switch</span> (cmd) &#123;<br>	<span class="hljs-keyword">case</span> USBDEVFS_REAPURB:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: REAPURB\n&quot;</span>, __func__);<br>		ret = proc_reapurb(ps, p);<br>		<span class="hljs-keyword">goto</span> done;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_REAPURBNDELAY:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: REAPURBNDELAY\n&quot;</span>, __func__);<br>		ret = proc_reapurbnonblock(ps, p);<br>		<span class="hljs-keyword">goto</span> done;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br>	<span class="hljs-keyword">case</span> USBDEVFS_REAPURB32:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: REAPURB32\n&quot;</span>, __func__);<br>		ret = proc_reapurb_compat(ps, p);<br>		<span class="hljs-keyword">goto</span> done;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_REAPURBNDELAY32:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: REAPURBNDELAY32\n&quot;</span>, __func__);<br>		ret = proc_reapurbnonblock_compat(ps, p);<br>		<span class="hljs-keyword">goto</span> done;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (!connected(ps)) &#123;<br>		usb_unlock_device(dev);<br>		<span class="hljs-keyword">return</span> -ENODEV;<br>	&#125;<br><br>	<span class="hljs-keyword">switch</span> (cmd) &#123;<br>	<span class="hljs-keyword">case</span> USBDEVFS_CONTROL:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: CONTROL\n&quot;</span>, __func__);<br>		ret = proc_control(ps, p);<br>		<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>			inode-&gt;i_mtime = current_time(inode);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_BULK:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: BULK\n&quot;</span>, __func__);<br>		ret = proc_bulk(ps, p);<br>		<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>			inode-&gt;i_mtime = current_time(inode);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_RESETEP:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: RESETEP\n&quot;</span>, __func__);<br>		ret = proc_resetep(ps, p);<br>		<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>			inode-&gt;i_mtime = current_time(inode);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_RESET:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: RESET\n&quot;</span>, __func__);<br>		ret = proc_resetdevice(ps);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_CLEAR_HALT:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: CLEAR_HALT\n&quot;</span>, __func__);<br>		ret = proc_clearhalt(ps, p);<br>		<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>			inode-&gt;i_mtime = current_time(inode);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_GETDRIVER:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: GETDRIVER\n&quot;</span>, __func__);<br>		ret = proc_getdriver(ps, p);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_CONNECTINFO:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: CONNECTINFO\n&quot;</span>, __func__);<br>		ret = proc_connectinfo(ps, p);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_SETINTERFACE:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: SETINTERFACE\n&quot;</span>, __func__);<br>		ret = proc_setintf(ps, p);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_SETCONFIGURATION:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: SETCONFIGURATION\n&quot;</span>, __func__);<br>		ret = proc_setconfig(ps, p);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_SUBMITURB:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: SUBMITURB\n&quot;</span>, __func__);<br>		ret = proc_submiturb(ps, p);<br>		<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>			inode-&gt;i_mtime = current_time(inode);<br>		<span class="hljs-keyword">break</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_COMPAT</span><br>	<span class="hljs-keyword">case</span> USBDEVFS_CONTROL32:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: CONTROL32\n&quot;</span>, __func__);<br>		ret = proc_control_compat(ps, p);<br>		<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>			inode-&gt;i_mtime = current_time(inode);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_BULK32:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: BULK32\n&quot;</span>, __func__);<br>		ret = proc_bulk_compat(ps, p);<br>		<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>			inode-&gt;i_mtime = current_time(inode);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_DISCSIGNAL32:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: DISCSIGNAL32\n&quot;</span>, __func__);<br>		ret = proc_disconnectsignal_compat(ps, p);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_SUBMITURB32:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: SUBMITURB32\n&quot;</span>, __func__);<br>		ret = proc_submiturb_compat(ps, p);<br>		<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>			inode-&gt;i_mtime = current_time(inode);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_IOCTL32:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: IOCTL32\n&quot;</span>, __func__);<br>		ret = proc_ioctl_compat(ps, ptr_to_compat(p));<br>		<span class="hljs-keyword">break</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>	<span class="hljs-keyword">case</span> USBDEVFS_DISCARDURB:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: DISCARDURB %px\n&quot;</span>, __func__, p);<br>		ret = proc_unlinkurb(ps, p);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_DISCSIGNAL:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: DISCSIGNAL\n&quot;</span>, __func__);<br>		ret = proc_disconnectsignal(ps, p);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_CLAIMINTERFACE:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: CLAIMINTERFACE\n&quot;</span>, __func__);<br>		ret = proc_claiminterface(ps, p);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_RELEASEINTERFACE:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: RELEASEINTERFACE\n&quot;</span>, __func__);<br>		ret = proc_releaseinterface(ps, p);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_IOCTL:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: IOCTL\n&quot;</span>, __func__);<br>		ret = proc_ioctl_default(ps, p);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_CLAIM_PORT:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: CLAIM_PORT\n&quot;</span>, __func__);<br>		ret = proc_claim_port(ps, p);<br>		<span class="hljs-keyword">break</span>;<br><br>	<span class="hljs-keyword">case</span> USBDEVFS_RELEASE_PORT:<br>		snoop(&amp;dev-&gt;dev, <span class="hljs-string">&quot;%s: RELEASE_PORT\n&quot;</span>, __func__);<br>		ret = proc_release_port(ps, p);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> USBDEVFS_GET_CAPABILITIES:<br>		ret = proc_get_capabilities(ps, p);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> USBDEVFS_DISCONNECT_CLAIM:<br>		ret = proc_disconnect_claim(ps, p);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> USBDEVFS_ALLOC_STREAMS:<br>		ret = proc_alloc_streams(ps, p);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> USBDEVFS_FREE_STREAMS:<br>		ret = proc_free_streams(ps, p);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> USBDEVFS_DROP_PRIVILEGES:<br>		ret = proc_drop_privileges(ps, p);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> USBDEVFS_GET_SPEED:<br>		ret = ps-&gt;dev-&gt;speed;<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> USBDEVFS_FORBID_SUSPEND:<br>		ret = proc_forbid_suspend(ps);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> USBDEVFS_ALLOW_SUSPEND:<br>		ret = proc_allow_suspend(ps);<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> USBDEVFS_WAIT_FOR_RESUME:<br>		ret = proc_wait_for_resume(ps);<br>		<span class="hljs-keyword">break</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/* Handle variable-length commands */</span><br>	<span class="hljs-keyword">switch</span> (cmd &amp; ~IOCSIZE_MASK) &#123;<br>	<span class="hljs-keyword">case</span> <span class="hljs-title function_">USBDEVFS_CONNINFO_EX</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span>:<br>		ret = proc_conninfo_ex(ps, p, _IOC_SIZE(cmd));<br>		<span class="hljs-keyword">break</span>;<br>	&#125;<br><br> done:<br>	usb_unlock_device(dev);<br>	<span class="hljs-keyword">if</span> (ret &gt;= <span class="hljs-number">0</span>)<br>		inode-&gt;i_atime = current_time(inode);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">usbdev_ioctl</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd,</span><br><span class="hljs-params">			<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg)</span><br>&#123;<br>	<span class="hljs-type">int</span> ret;<br><br>	ret = usbdev_do_ioctl(file, cmd, (<span class="hljs-type">void</span> __user *)arg);<br><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">/* No kernel lock - fine */</span><br><span class="hljs-type">static</span> <span class="hljs-type">__poll_t</span> <span class="hljs-title function_">usbdev_poll</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file,</span><br><span class="hljs-params">				<span class="hljs-keyword">struct</span> poll_table_struct *wait)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span> =</span> file-&gt;private_data;<br>	<span class="hljs-type">__poll_t</span> mask = <span class="hljs-number">0</span>;<br><br>	poll_wait(file, &amp;ps-&gt;wait, wait);<br>	<span class="hljs-keyword">if</span> (file-&gt;f_mode &amp; FMODE_WRITE &amp;&amp; !list_empty(&amp;ps-&gt;async_completed))<br>		mask |= EPOLLOUT | EPOLLWRNORM;<br>	<span class="hljs-keyword">if</span> (!connected(ps))<br>		mask |= EPOLLHUP;<br>	<span class="hljs-keyword">if</span> (list_empty(&amp;ps-&gt;<span class="hljs-built_in">list</span>))<br>		mask |= EPOLLERR;<br>	<span class="hljs-keyword">return</span> mask;<br>&#125;<br><br><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">usbdev_file_operations</span> =</span> &#123;<br>	.owner =	  THIS_MODULE,<br>	.llseek =	  no_seek_end_llseek,<br>	.read =		  usbdev_read,<br>	.poll =		  usbdev_poll,<br>	.unlocked_ioctl = usbdev_ioctl,<br>	.compat_ioctl =   compat_ptr_ioctl,<br>	.mmap =           usbdev_mmap,<br>	.open =		  usbdev_open,<br>	.release =	  usbdev_release,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">usbdev_remove</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> usb_device *udev)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">usb_dev_state</span> *<span class="hljs-title">ps</span>;</span><br><br>	<span class="hljs-comment">/* Protect against simultaneous resume */</span><br>	mutex_lock(&amp;usbfs_mutex);<br>	<span class="hljs-keyword">while</span> (!list_empty(&amp;udev-&gt;filelist)) &#123;<br>		ps = list_entry(udev-&gt;filelist.next, <span class="hljs-keyword">struct</span> usb_dev_state, <span class="hljs-built_in">list</span>);<br>		destroy_all_async(ps);<br>		wake_up_all(&amp;ps-&gt;wait);<br>		WRITE_ONCE(ps-&gt;not_yet_resumed, <span class="hljs-number">0</span>);<br>		wake_up_all(&amp;ps-&gt;wait_for_resume);<br>		list_del_init(&amp;ps-&gt;<span class="hljs-built_in">list</span>);<br>		<span class="hljs-keyword">if</span> (ps-&gt;discsignr)<br>			kill_pid_usb_asyncio(ps-&gt;discsignr, EPIPE, ps-&gt;disccontext,<br>					     ps-&gt;disc_pid, ps-&gt;cred);<br>	&#125;<br>	mutex_unlock(&amp;usbfs_mutex);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">usbdev_notify</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> notifier_block *self,</span><br><span class="hljs-params">			       <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> action, <span class="hljs-type">void</span> *dev)</span><br>&#123;<br>	<span class="hljs-keyword">switch</span> (action) &#123;<br>	<span class="hljs-keyword">case</span> USB_DEVICE_ADD:<br>		<span class="hljs-keyword">break</span>;<br>	<span class="hljs-keyword">case</span> USB_DEVICE_REMOVE:<br>		usbdev_remove(dev);<br>		<span class="hljs-keyword">break</span>;<br>	&#125;<br>	<span class="hljs-keyword">return</span> NOTIFY_OK;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">notifier_block</span> <span class="hljs-title">usbdev_nb</span> =</span> &#123;<br>	.notifier_call =	usbdev_notify,<br>&#125;;<br><br><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cdev</span> <span class="hljs-title">usb_device_cdev</span>;</span><br><br><span class="hljs-type">int</span> __init <span class="hljs-title function_">usb_devio_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	<span class="hljs-type">int</span> retval;<br><br>	retval = register_chrdev_region(USB_DEVICE_DEV, USB_DEVICE_MAX,<br>					<span class="hljs-string">&quot;usb_device&quot;</span>);<br>	<span class="hljs-keyword">if</span> (retval) &#123;<br>		printk(KERN_ERR <span class="hljs-string">&quot;Unable to register minors for usb_device\n&quot;</span>);<br>		<span class="hljs-keyword">goto</span> out;<br>	&#125;<br>	cdev_init(&amp;usb_device_cdev, &amp;usbdev_file_operations);<br>	retval = cdev_add(&amp;usb_device_cdev, USB_DEVICE_DEV, USB_DEVICE_MAX);<br>	<span class="hljs-keyword">if</span> (retval) &#123;<br>		printk(KERN_ERR <span class="hljs-string">&quot;Unable to get usb_device major %d\n&quot;</span>,<br>		       USB_DEVICE_MAJOR);<br>		<span class="hljs-keyword">goto</span> error_cdev;<br>	&#125;<br>	usb_register_notify(&amp;usbdev_nb);<br>out:<br>	<span class="hljs-keyword">return</span> retval;<br><br>error_cdev:<br>	unregister_chrdev_region(USB_DEVICE_DEV, USB_DEVICE_MAX);<br>	<span class="hljs-keyword">goto</span> out;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">usb_devio_cleanup</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>	usb_unregister_notify(&amp;usbdev_nb);<br>	cdev_del(&amp;usb_device_cdev);<br>	unregister_chrdev_region(USB_DEVICE_DEV, USB_DEVICE_MAX);<br>&#125;<br><br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>uos</div>
      <div>https://tomwithkernel.github.io/tom/uos/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Tom</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年5月7日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2025年7月18日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"mGugYoHICpLi8BnBygCpEblQ-MdYXbMMI","appKey":"jxVWH2hG2DLvf0KjiGZ93acw","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://tomwithkernel.github.io/" target="_blank" rel="nofollow noopener"><span>Tom</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/TomWithKernel/kernel" target="_blank" rel="nofollow noopener"><span>repository</span></a> <div> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/duration.js"></script> </div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>




  
<script src="/js/scrollAnimation.js"></script>
<script src="/js/expand-toc.js"></script>



<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
<!-- hexo injector body_end start --><script src="/js/backgroundize.js"></script><!-- hexo injector body_end end --></body>
</html>
